---
phase: 19-outbound-email-foundation
plan: 02
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - /home/ubuntu/.openclaw/skills/resend-email/SKILL.md
  - /home/ubuntu/clawd/agents/main/email-template.html
  - /home/ubuntu/clawd/agents/main/email-config.json
  - /home/ubuntu/.openclaw/cron/jobs.json
autonomous: true

must_haves:
  truths:
    - "Bob can send email via Slack command using resend-email skill"
    - "Morning briefing is delivered to both Slack and email"
    - "Bob knows when to escalate events to email vs Slack-only"
    - "Alert email soft cap of 5/day is enforced via config counter"
    - "All outbound emails include Auto-Submitted: auto-generated header"
    - "Email template follows Practical Typography principles with inline CSS"
  artifacts:
    - path: "/home/ubuntu/.openclaw/skills/resend-email/SKILL.md"
      provides: "Send email instructions with alert thresholds and briefing integration"
      contains: "name: Resend Email"
    - path: "/home/ubuntu/clawd/agents/main/email-template.html"
      provides: "HTML email template with inline CSS and placeholders"
      contains: "{{CONTENT}}"
    - path: "/home/ubuntu/clawd/agents/main/email-config.json"
      provides: "Recipient list and daily send counters"
      contains: "theandykaufman@gmail.com"
  key_links:
    - from: "/home/ubuntu/.openclaw/skills/resend-email/SKILL.md"
      to: "Resend API"
      via: "curl POST https://api.resend.com/emails"
      pattern: "api.resend.com/emails"
    - from: "/home/ubuntu/.openclaw/skills/resend-email/SKILL.md"
      to: "/home/ubuntu/clawd/agents/main/email-template.html"
      via: "Bob reads template, replaces placeholders, passes as html body"
      pattern: "email-template.html"
    - from: "/home/ubuntu/.openclaw/skills/resend-email/SKILL.md"
      to: "/home/ubuntu/clawd/agents/main/email-config.json"
      via: "Bob reads config for recipients and alert counter"
      pattern: "email-config.json"
    - from: "/home/ubuntu/.openclaw/cron/jobs.json"
      to: "/home/ubuntu/.openclaw/skills/resend-email/SKILL.md"
      via: "Morning briefing systemEvent instructs email send after Slack"
      pattern: "Email Briefing"
---

<objective>
Create the resend-email skill (SKILL.md + HTML template + config), then integrate email delivery into the morning briefing cron so Bob sends briefings to both Slack and email.

Purpose: Give Bob the ability to send formatted emails via Resend API and automatically deliver morning briefings via email alongside Slack.
Output: Working resend-email skill, HTML template, recipient config, updated briefing cron.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-outbound-email-foundation/19-RESEARCH.md
@.planning/phases/19-outbound-email-foundation/19-CONTEXT.md
@.planning/phases/19-outbound-email-foundation/19-01-SUMMARY.md
@.planning/phases/02-oura-ring-integration/02-01-SUMMARY.md
@.planning/phases/03-daily-briefing-rate-limits/03-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create email template, config, and resend-email SKILL.md</name>
  <files>
    /home/ubuntu/.openclaw/skills/resend-email/SKILL.md
    /home/ubuntu/clawd/agents/main/email-template.html
    /home/ubuntu/clawd/agents/main/email-config.json
  </files>
  <action>
    **Step 1: Create email-config.json**
    SSH to EC2 and create `/home/ubuntu/clawd/agents/main/email-config.json`:
    ```json
    {
      "recipients": [
        {
          "email": "theandykaufman@gmail.com",
          "name": "Andy"
        }
      ],
      "daily_send_count": 0,
      "daily_send_date": "2026-02-16",
      "alert_count_today": 0
    }
    ```
    This file is in Bob's workspace, so inside sandbox it is `/workspace/email-config.json`.

    **Step 2: Create email-template.html**
    SSH to EC2 and create `/home/ubuntu/clawd/agents/main/email-template.html`.
    The template must follow these locked decisions from CONTEXT.md:
    - Minimal HTML with Practical Typography principles
    - Inline CSS only (Gmail strips style tags)
    - System font stack: `-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif`
    - Body: 16px font-size, line-height 1.5, color #333333
    - Container: max-width 600px, auto margin, 24px/16px padding
    - Heading hierarchy: h1 1.5rem #111111, h2 1.35rem #222222, h3 1.15rem #333333
    - Heading spacing: more top margin (binds to content below), less bottom
    - Blockquote: 0.95em, 1.5rem left padding, 3px solid #dddddd left border
    - Footer: "Sent by Bob" -- 0.8rem, #999999, border-top separator
    - Placeholders: `{{SUBJECT}}`, `{{CONTENT}}`, `{{DATE}}`
    - Unicode smart quotes, en/em dashes, proper ellipsis (actual characters)
    - No images, no tracking pixels, no marketing elements
    - No dark mode support (requires style block Gmail strips)
    Inside sandbox this is `/workspace/email-template.html`.

    Include HTML comment patterns at top showing available inline styles for content sections (h2, h3, p, blockquote, ul/li, hr, strong, em) so Bob knows the palette when composing content.

    **Step 3: Create SKILL.md**
    SSH to EC2 and create `/home/ubuntu/.openclaw/skills/resend-email/SKILL.md` with YAML frontmatter:
    ```yaml
    ---
    name: Resend Email
    description: Send formatted emails via Resend REST API from bob@mail.andykaufman.net
    ---
    ```

    SKILL.md sections:

    **Section 1: Overview**
    - From: `Bob <bob@mail.andykaufman.net>`
    - API: POST https://api.resend.com/emails
    - Auth: Bearer $RESEND_API_KEY
    - Template: /workspace/email-template.html
    - Config: /workspace/email-config.json
    - All emails MUST include `"Auto-Submitted": "auto-generated"` header (RFC 3834, prevents bot loops)

    **Section 2: Send Email (curl pattern)**
    Document the exact curl command pattern:
    ```bash
    curl -s -X POST 'https://api.resend.com/emails' \
      -H "Authorization: Bearer $RESEND_API_KEY" \
      -H 'Content-Type: application/json' \
      -d '{
        "from": "Bob <bob@mail.andykaufman.net>",
        "to": [RECIPIENTS_ARRAY],
        "subject": "SUBJECT",
        "html": "HTML_CONTENT",
        "text": "PLAIN_TEXT_FALLBACK",
        "headers": {"Auto-Submitted": "auto-generated"},
        "tags": [{"name": "type", "value": "TYPE"}]
      }'
    ```
    Success: 200 with `{"id": "..."}`. Errors: 401 (bad key), 422 (validation), 429 (rate limit 2 req/s).

    **Section 3: Email Composition Workflow**
    1. Read /workspace/email-config.json for recipient list
    2. Read /workspace/email-template.html for template
    3. Compose content HTML using inline styles from template comment palette
    4. Replace {{SUBJECT}}, {{CONTENT}}, {{DATE}} placeholders
    5. Generate plain text fallback (strip HTML, preserve structure)
    6. Build curl command with composed HTML and recipient array
    7. Execute curl, check for 200 response
    8. If error, retry once after 2s; if still failing, report error in Slack

    **Section 4: Subject Line Conventions**
    | Type | Format | Example |
    |------|--------|---------|
    | Morning briefing | `Morning Briefing \u2014 {Day Mon DD}` | `Morning Briefing \u2014 Mon Feb 16` |
    | Evening recap | `Evening Recap \u2014 {Day Mon DD}` | `Evening Recap \u2014 Mon Feb 16` |
    | Weekly review | `Weekly Review \u2014 Week of {Mon DD}` | `Weekly Review \u2014 Week of Feb 10` |
    | Alert (critical) | `[Alert] {Brief description}` | `[Alert] Gateway Health Check Failed` |
    | Alert (important) | `[Notice] {Brief description}` | `[Notice] 3 Cron Jobs Failed Today` |
    | General | `{Descriptive subject}` | `Your Meeting Prep for 2:00 PM` |

    **Section 5: Alert Email Criteria**
    Define when Bob should escalate to email:

    | Category | Email? | Examples |
    |----------|--------|----------|
    | Critical | Always | Gateway down, Tailscale disconnected, OOM, security breach, disk >90% |
    | Important | Yes, if 7 AM-10 PM PT | Cron failed 2+ times consecutively, health anomaly (sleep <50, HRV spike >20%), disk >85%, pipeline stall >48h |
    | Informational | Never (Slack only) | Single cron failure, weather alert, routine status, content pipeline updates |

    **Soft cap:** Max 5 alert emails per day. Before sending an alert:
    1. Read /workspace/email-config.json
    2. Check if `daily_send_date` matches today; if not, reset `alert_count_today` to 0
    3. If `alert_count_today` >= 5, stay Slack-only and mention "email alert cap reached"
    4. If under cap, send email and increment `alert_count_today`
    5. Write updated config back to /workspace/email-config.json

    **Section 6: Morning Briefing Email**
    After composing the morning briefing for Slack:
    1. Read /workspace/email-config.json for recipients
    2. Read /workspace/email-template.html
    3. Reformat briefing content into HTML using template (same content as Slack, formatted for email)
    4. Subject: `Morning Briefing \u2014 {Day Mon DD}`
    5. Send via curl pattern from Section 2
    6. Tag: `{"name": "type", "value": "briefing"}`
    7. Reset `daily_send_date` to today and `alert_count_today` to 0 (daily counter reset)
    8. If send fails, log error but do NOT block the Slack briefing
    9. Increment `daily_send_count`

    **Section 7: Rate Limits and Quotas**
    - Free tier: 100 emails/day, 3000/month
    - Rate limit: 2 requests/second
    - Each recipient counts as 1 email (3 recipients = 3 against daily quota)
    - Current usage: ~2-5 emails/day (briefing + occasional alerts). Huge margin.

    **Step 4: Verify skill detection**
    Run `openclaw skills list` and confirm "Resend Email" appears as "ready".
    If not detected, check YAML frontmatter formatting (must have `name:` and `description:` fields).
  </action>
  <verify>
    1. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cat ~/clawd/agents/main/email-config.json'` shows valid JSON with theandykaufman@gmail.com
    2. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cat ~/clawd/agents/main/email-template.html'` shows HTML with {{SUBJECT}}, {{CONTENT}}, {{DATE}} placeholders
    3. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cat ~/.openclaw/skills/resend-email/SKILL.md | head -5'` shows YAML frontmatter with name and description
    4. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 '/home/ubuntu/.npm-global/bin/openclaw skills list'` shows "Resend Email" as ready
  </verify>
  <done>
    resend-email SKILL.md deployed with 7 sections (overview, curl pattern, composition workflow, subject conventions, alert criteria, briefing integration, quotas). HTML template with Practical Typography inline CSS at /workspace/email-template.html. Recipient config at /workspace/email-config.json with theandykaufman@gmail.com. Skill detected by OpenClaw as "ready".
  </done>
</task>

<task type="auto">
  <name>Task 2: Update morning briefing cron and verify end-to-end email send</name>
  <files>
    /home/ubuntu/.openclaw/cron/jobs.json
  </files>
  <action>
    **Step 1: Read current morning briefing cron**
    SSH to EC2 and read the current morning-briefing cron job (ID: 863587f3-bb4e-409b-aee2-11fe2373e6e0) from jobs.json to understand the existing systemEvent text structure. The cron uses `sessionTarget: "main"` with `payload.kind: "systemEvent"`.

    **Step 2: Add email briefing section to systemEvent text**
    Append a new section to the morning briefing systemEvent text. This section instructs Bob to send the briefing via email AFTER composing and sending to Slack:

    ```
    ## N. Email Briefing
    After sending the briefing to Slack, also deliver it via email:
    1. Read /workspace/email-config.json for recipient list
    2. Read /workspace/email-template.html for the HTML template
    3. Reformat the briefing content into the HTML template using inline CSS patterns from the template
    4. Use the resend-email skill to send the email
    5. Subject line: "Morning Briefing - {Day Mon DD}" (with em dash)
    6. Include Auto-Submitted: auto-generated header
    7. Reset daily_send_date and alert_count_today in email-config.json
    8. If email send fails, note the error in Slack but do not retry or block
    ```

    Use `openclaw cron edit` CLI to update the systemEvent text. If CLI doesn't support long text edits cleanly, patch jobs.json directly via jq on EC2, then restart gateway to pick up changes.

    **Important:** The morning briefing is a systemEvent cron, which runs in embedded mode with HOST paths. However, the systemEvent TEXT instructs the agent what to do -- and when the agent runs, it runs in the Docker sandbox. So the paths in the systemEvent text should use `/workspace/` (sandbox paths), not host paths. This is the established pattern from Phase 3 Plan 2.

    **Step 3: Test email send via Bob**
    After restarting gateway, ask Bob in Slack to send a test email to verify the skill works end-to-end:
    - "Send a test email to Andy saying hello"
    - Verify Bob reads the config, constructs the curl, sends successfully
    - Check that the email arrives in theandykaufman@gmail.com

    **Step 4: Verify Auto-Submitted header**
    On the received test email, use Gmail "Show Original" to confirm:
    - `Auto-Submitted: auto-generated` header is present
    - SPF: PASS
    - DKIM: PASS

    If jq is not available in sandbox, document the python3 fallback for JSON parsing in the summary.
  </action>
  <verify>
    1. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 '/home/ubuntu/.npm-global/bin/openclaw cron list --json' | python3 -c "import sys,json; jobs=json.load(sys.stdin); briefing=[j for j in jobs if 'morning' in j.get('description','').lower()]; print(briefing[0]['payload']['text'][:200] if briefing else 'NOT FOUND')"` shows email briefing section in systemEvent text
    2. Bob successfully sends test email via Slack command (Resend returns 200)
    3. Test email arrives in theandykaufman@gmail.com inbox with correct subject formatting
    4. Gmail "Show Original" shows Auto-Submitted header + SPF/DKIM PASS
  </verify>
  <done>
    Morning briefing cron updated with email section. Bob can send email via resend-email skill from Slack. Test email delivered with Auto-Submitted header, SPF PASS, DKIM PASS. End-to-end outbound email pipeline working.
  </done>
</task>

</tasks>

<verification>
1. `openclaw skills list` shows "Resend Email" as ready
2. Bob sends test email from Slack -- arrives in inbox (not spam)
3. Morning briefing cron systemEvent includes email delivery section
4. email-template.html contains Practical Typography inline CSS with h1/h2/h3 hierarchy
5. email-config.json contains theandykaufman@gmail.com recipient
6. All test emails include Auto-Submitted: auto-generated header
7. SKILL.md documents alert categories (Critical/Important/Informational) with soft cap
</verification>

<success_criteria>
- Bob sends formatted email via resend-email skill from any session
- Morning briefing cron delivers to both Slack and email
- Alert email criteria documented with 5/day soft cap
- HTML template follows Practical Typography with inline CSS
- All outbound emails include Auto-Submitted header
</success_criteria>

<output>
After completion, create `.planning/phases/19-outbound-email-foundation/19-02-SUMMARY.md`
</output>
