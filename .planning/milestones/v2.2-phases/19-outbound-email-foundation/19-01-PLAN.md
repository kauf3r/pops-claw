---
phase: 19-outbound-email-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/.openclaw/.env
  - /home/ubuntu/.openclaw/openclaw.json
autonomous: false
user_setup:
  - service: resend
    why: "Email sending API for outbound emails"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key (scope: sending_access)"
    dashboard_config:
      - task: "Create Resend account"
        location: "https://resend.com/signup"
      - task: "Add domain mail.andykaufman.net"
        location: "Resend Dashboard -> Domains -> Add Domain"
      - task: "Copy DNS records (SPF TXT + 3x DKIM CNAME)"
        location: "Resend Dashboard -> Domains -> mail.andykaufman.net"
  - service: dns-provider
    why: "Domain verification for SPF/DKIM/DMARC"
    dashboard_config:
      - task: "Add SPF TXT record on send.mail.andykaufman.net"
        location: "DNS provider for andykaufman.net"
      - task: "Add 3x DKIM CNAME records"
        location: "DNS provider for andykaufman.net"
      - task: "Add DMARC TXT record on _dmarc.mail.andykaufman.net (if needed)"
        location: "DNS provider for andykaufman.net"

must_haves:
  truths:
    - "RESEND_API_KEY is accessible inside Docker sandbox"
    - "mail.andykaufman.net domain is verified in Resend dashboard"
    - "SPF and DKIM pass on test email (check via Gmail Show Original)"
    - "Test email from bob@mail.andykaufman.net arrives in theandykaufman@gmail.com inbox"
  artifacts:
    - path: "/home/ubuntu/.openclaw/.env"
      provides: "RESEND_API_KEY for gateway"
      contains: "RESEND_API_KEY="
    - path: "/home/ubuntu/.openclaw/openclaw.json"
      provides: "RESEND_API_KEY injected into sandbox env"
      contains: "RESEND_API_KEY"
  key_links:
    - from: "/home/ubuntu/.openclaw/openclaw.json"
      to: "Docker sandbox env"
      via: "agents.defaults.sandbox.docker.env.RESEND_API_KEY"
      pattern: "RESEND_API_KEY"
    - from: "Resend API"
      to: "mail.andykaufman.net DNS"
      via: "SPF/DKIM verification"
      pattern: "domain verified"
---

<objective>
Set up Resend account, verify mail.andykaufman.net domain with DNS records, inject API key into OpenClaw sandbox environment, and send a test email confirming end-to-end deliverability.

Purpose: Establish the sending infrastructure so Bob can send email from bob@mail.andykaufman.net via Resend REST API.
Output: Verified domain, API key in sandbox env, successful test email delivery with SPF/DKIM pass.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-outbound-email-foundation/19-RESEARCH.md
@.planning/phases/19-outbound-email-foundation/19-CONTEXT.md
@.planning/phases/02-oura-ring-integration/02-01-SUMMARY.md
</context>

<tasks>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 1: Create Resend account, add domain, and configure DNS</name>
  <action>
    User must complete these steps manually (no API for account creation):

    **Step 1: Create Resend account**
    - Go to https://resend.com/signup
    - Create account (free tier: 100 emails/day, 3000/month)

    **Step 2: Add domain**
    - In Resend Dashboard, go to Domains -> Add Domain
    - Enter: `mail.andykaufman.net`
    - Resend will generate DNS records (SPF TXT, 3x DKIM CNAME, optional DMARC TXT)
    - Copy all generated records

    **Step 3: Add DNS records at registrar**
    - Add all Resend-generated DNS records to andykaufman.net DNS:
      - SPF: TXT record on `send.mail.andykaufman.net` (value from Resend)
      - DKIM: 3x CNAME records (hashes from Resend dashboard)
      - DMARC: TXT on `_dmarc.mail.andykaufman.net` with value `v=DMARC1; p=none;` (start permissive for testing)
    - Wait for Resend dashboard to show domain as "Verified" (usually 1-30 min for DNS propagation)

    **Step 4: Create API key**
    - In Resend Dashboard, go to API Keys -> Create API Key
    - Scope: `sending_access` (least privilege -- sending only, no domain management)
    - Name: `pops-claw-sandbox`
    - Copy the API key value

    **Provide to Claude:** The RESEND_API_KEY value and confirmation that the domain shows "Verified" in Resend dashboard.
  </action>
  <resume-signal>Provide the RESEND_API_KEY and confirm domain is verified. If DMARC exists on parent domain (andykaufman.net), mention its policy.</resume-signal>
</task>

<task type="auto">
  <name>Task 2: Inject API key into sandbox env and send test email</name>
  <files>
    /home/ubuntu/.openclaw/.env
    /home/ubuntu/.openclaw/openclaw.json
  </files>
  <action>
    **Step 1: Check existing DMARC on parent domain**
    Run `dig TXT _dmarc.andykaufman.net` from EC2 to check for inherited DMARC policy. If parent has `p=reject` or `p=quarantine` with no subdomain override, note this for the user (subdomain DMARC TXT should already be added in Task 1).

    **Step 2: Add RESEND_API_KEY to .env**
    SSH to EC2 (100.72.143.9) and append `RESEND_API_KEY=<value from Task 1>` to `~/.openclaw/.env`.

    **Step 3: Add RESEND_API_KEY to openclaw.json sandbox env**
    Add `RESEND_API_KEY` to `agents.defaults.sandbox.docker.env` in `~/.openclaw/openclaw.json`.
    This is the critical step -- .env is loaded by gateway only, sandbox needs its own env injection.
    Follow the established pattern from Phase 2 (OURA_ACCESS_TOKEN) and Phase 5 (GOVEE_API_KEY).

    **Step 4: Restart gateway**
    Run `systemctl --user restart openclaw-gateway.service` and verify it comes up healthy.

    **Step 5: Verify env var in sandbox**
    Trigger Bob to run `echo $RESEND_API_KEY` in sandbox to confirm the variable is accessible.

    **Step 6: Send test email via curl**
    From EC2, send a test email using curl directly (not through Bob yet):
    ```
    curl -s -X POST 'https://api.resend.com/emails' \
      -H "Authorization: Bearer $RESEND_API_KEY" \
      -H 'Content-Type: application/json' \
      -d '{
        "from": "Bob <bob@mail.andykaufman.net>",
        "to": ["theandykaufman@gmail.com"],
        "subject": "Test Email from Bob",
        "html": "<p>This is a test email from Bob via Resend API.</p>",
        "text": "This is a test email from Bob via Resend API.",
        "headers": {
          "Auto-Submitted": "auto-generated"
        }
      }'
    ```
    Expect 200 response with `{"id": "..."}`.

    **Step 7: Verify deliverability**
    Check that the test email arrives in theandykaufman@gmail.com (not spam). If user can check Gmail "Show Original", verify SPF and DKIM both show "PASS".
  </action>
  <verify>
    1. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'grep RESEND_API_KEY ~/.openclaw/.env'` shows the key
    2. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 '/home/ubuntu/.npm-global/bin/openclaw config get agents.defaults.sandbox.docker.env'` includes RESEND_API_KEY
    3. `systemctl --user is-active openclaw-gateway.service` returns active
    4. Test curl returns 200 with email ID
    5. Test email arrives in inbox (not spam)
  </verify>
  <done>
    RESEND_API_KEY in both .env and openclaw.json sandbox env. Gateway restarted. Test email delivered to theandykaufman@gmail.com with SPF/DKIM pass. Auto-Submitted header present.
  </done>
</task>

</tasks>

<verification>
1. Resend dashboard shows mail.andykaufman.net as "Verified"
2. RESEND_API_KEY accessible inside Docker sandbox (Bob can echo it)
3. Test email arrived in theandykaufman@gmail.com inbox (not spam)
4. Gmail "Show Original" on test email shows SPF: PASS and DKIM: PASS
5. Auto-Submitted: auto-generated header present in email headers
</verification>

<success_criteria>
- Domain mail.andykaufman.net verified in Resend (SPF/DKIM pass)
- RESEND_API_KEY injected into sandbox env (both .env and openclaw.json)
- Test email from bob@mail.andykaufman.net delivered successfully
- Foundation ready for SKILL.md creation in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/19-outbound-email-foundation/19-01-SUMMARY.md`
</output>
