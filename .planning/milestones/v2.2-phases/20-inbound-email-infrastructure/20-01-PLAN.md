---
phase: 20-inbound-email-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.openclaw/openclaw.json
  - /etc/ufw rules (EC2)
  - Caddyfile (VPS)
autonomous: true
requirements:
  - "gateway-bind-tailnet"
  - "hooks-endpoint-dedicated-token"
  - "ufw-sg-defense-in-depth"
  - "caddy-webhook-route"
  - "vps-tailscale-connectivity"

must_haves:
  truths:
    - "Gateway listens on Tailscale IP (100.72.143.9:18789) instead of localhost"
    - "POST to /hooks/agent with hooks token returns 202"
    - "UFW allows 18789 from 100.64.0.0/10"
    - "VPS can reach EC2 gateway over Tailscale"
    - "Caddy on VPS routes /webhooks/resend to n8n with IP restriction"
    - "SSH tunnel uses Tailscale IP (not localhost) for dashboard access"
  artifacts:
    - path: "~/.openclaw/openclaw.json"
      provides: "hooks config with dedicated token, bind: tailnet"
      contains: "hooks"
    - path: "Caddyfile (VPS)"
      provides: "/webhooks/resend route with remote_ip restriction"
      contains: "resend_webhook"
  key_links:
    - from: "VPS Caddy /webhooks/resend"
      to: "n8n localhost:5678"
      via: "reverse_proxy"
    - from: "n8n (future)"
      to: "EC2 100.72.143.9:18789/hooks/agent"
      via: "Tailscale network"
---

<objective>
Configure EC2 gateway for inbound webhooks (bind change + hooks endpoint + firewall) and set up VPS Caddy route for Resend webhook relay.

Purpose: Build the infrastructure endpoints so n8n (Plan 02) can receive Resend webhooks and forward to OpenClaw.
Output: Gateway accepting hook POSTs from Tailscale, Caddy routing webhooks to n8n, verified VPS-to-EC2 connectivity.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-inbound-email-infrastructure/20-RESEARCH.md
@.planning/phases/19-outbound-email-foundation/19-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Gateway bind change + hooks config + UFW update on EC2</name>
  <files>~/.openclaw/openclaw.json, UFW rules on EC2</files>
  <action>
SSH to EC2 (100.72.143.9) and perform these steps:

1. **Backup config:**
   ```
   cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.pre-hooks-backup
   ```

2. **Generate dedicated hooks token:**
   ```
   python3 -c "import secrets; print(secrets.token_urlsafe(32))"
   ```
   Save the output -- this is the HOOKS_TOKEN (separate from gateway auth token).

3. **Update openclaw.json** using jq or manual edit. Add/modify these fields:
   - `gateway.bind`: change from `"loopback"` to `"tailnet"` (binds to Tailscale IP 100.72.143.9 instead of 127.0.0.1)
   - `hooks.enabled`: `true`
   - `hooks.token`: the generated HOOKS_TOKEN
   - `hooks.path`: `"/hooks"`

   Read the existing config first to understand the structure, then patch. Do NOT overwrite unrelated fields.

4. **UFW rules** -- verify port 18789 is allowed from Tailscale CGNAT:
   ```
   sudo ufw status numbered | grep 18789
   ```
   If no rule exists:
   ```
   sudo ufw allow from 100.64.0.0/10 to any port 18789 proto tcp comment "OpenClaw gateway from Tailscale"
   ```
   If rule already exists (from earlier phases), no action needed.

5. **Restart gateway:**
   ```
   systemctl --user restart openclaw-gateway.service
   ```

6. **Verify gateway is listening on Tailscale IP:**
   ```
   ss -tlnp | grep 18789
   ```
   Should show `100.72.143.9:18789` (not `127.0.0.1:18789`).

7. **Test hooks endpoint from EC2 itself:**
   ```
   curl -s -o /dev/null -w "%{http_code}" -X POST http://100.72.143.9:18789/hooks/agent \
     -H "x-openclaw-token: HOOKS_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"message": "test hook", "name": "test"}'
   ```
   Should return 202 (accepted).

8. **Verify Slack/gateway still works** -- check journal for any errors:
   ```
   journalctl --user -u openclaw-gateway.service --since '2 min ago' | tail -20
   ```
   Slack uses Socket Mode (outbound connection), so bind change should NOT affect it.

IMPORTANT: After bind change, SSH tunnel for dashboard must use Tailscale IP:
`ssh -L 3000:100.72.143.9:18789 -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9`
(Not `ssh -L 3000:localhost:18789` which will stop working.)
  </action>
  <verify>
1. `ss -tlnp | grep 18789` shows 100.72.143.9 (not 127.0.0.1)
2. `curl -s -o /dev/null -w "%{http_code}" POST /hooks/agent` returns 202
3. `sudo ufw status` shows 18789 allowed from 100.64.0.0/10
4. `journalctl` shows no gateway errors
5. Gateway service status is active (running)
  </verify>
  <done>
Gateway binds to Tailscale IP, hooks endpoint accepts authenticated POSTs with dedicated token, UFW allows Tailscale traffic on 18789.
  </done>
</task>

<task type="auto">
  <name>Task 2: VPS Tailscale verification + Caddy route for Resend webhooks</name>
  <files>Caddyfile on VPS (165.22.139.214)</files>
  <action>
SSH to VPS (165.22.139.214) and perform these steps:

1. **Verify Tailscale on VPS:**
   ```
   tailscale status
   ```
   - If Tailscale is running and connected to same tailnet: note VPS Tailscale IP, proceed.
   - If Tailscale is NOT installed: install it (`curl -fsSL https://tailscale.com/install.sh | sh`), then `sudo tailscale up` and authenticate. Note the assigned Tailscale IP.
   - If installed but disconnected: `sudo tailscale up` to reconnect.

2. **Test VPS-to-EC2 connectivity over Tailscale:**
   ```
   curl -s -o /dev/null -w "%{http_code}" http://100.72.143.9:18789/hooks/agent \
     -H "x-openclaw-token: HOOKS_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"message": "VPS connectivity test", "name": "test"}'
   ```
   Must return 202. If connection refused or timeout, troubleshoot Tailscale routing.

3. **Verify n8n port on VPS:**
   ```
   ss -tlnp | grep 5678
   ```
   If n8n is on a different port, note it for Caddy config below.

4. **Add Caddy route for Resend webhooks.** Find the existing Caddyfile:
   ```
   find /etc/caddy -name Caddyfile 2>/dev/null || find / -name Caddyfile -maxdepth 4 2>/dev/null
   ```

   Add the following route block inside the appropriate server block (the one handling the VPS domain):
   ```
   @resend_webhook {
       path /webhooks/resend
       remote_ip 44.228.126.217 50.112.21.217 52.24.126.164 54.148.139.208
   }
   handle @resend_webhook {
       reverse_proxy localhost:5678
   }
   ```

   Resend webhook IPs: 44.228.126.217, 50.112.21.217, 52.24.126.164, 54.148.139.208
   If n8n is on a different port, substitute for 5678.

5. **Validate and reload Caddy:**
   ```
   sudo caddy validate --config /etc/caddy/Caddyfile
   sudo caddy reload --config /etc/caddy/Caddyfile
   ```
   Or if Caddy uses systemd:
   ```
   sudo systemctl reload caddy
   ```

6. **Test Caddy route** (from VPS itself, this will fail the IP check since localhost != Resend IPs, but confirm the route exists):
   ```
   curl -s -o /dev/null -w "%{http_code}" http://localhost/webhooks/resend
   ```
   Expected: 403 or connection refused (IP restriction blocks non-Resend IPs). This confirms the route is active.

NOTE: Record the VPS Tailscale IP and the full webhook URL (e.g., `https://your-vps-domain.com/webhooks/resend`) -- both needed for Plan 02.
  </action>
  <verify>
1. `tailscale status` shows VPS connected to same tailnet as EC2
2. curl from VPS to 100.72.143.9:18789/hooks/agent returns 202
3. Caddy config validated without errors
4. Caddy reloaded successfully
5. The /webhooks/resend route exists in Caddy config
  </verify>
  <done>
VPS on same Tailscale network as EC2, Caddy routes /webhooks/resend to n8n with Resend IP restriction, VPS can POST to EC2 hooks endpoint over Tailscale.
  </done>
</task>

</tasks>

<verification>
1. From Mac: `curl -s http://100.72.143.9:18789/hooks/agent -H "x-openclaw-token: HOOKS_TOKEN" -H "Content-Type: application/json" -d '{"message":"mac test","name":"test"}'` returns 202
2. From VPS: same curl to EC2 returns 202
3. Gateway journal shows no errors, Slack still connected
4. `sudo ufw status` on EC2 shows 18789 rule
5. Caddy config on VPS contains @resend_webhook block
</verification>

<success_criteria>
- Gateway binds to Tailscale IP (not loopback)
- Hooks endpoint accepts authenticated POSTs (202 response)
- Dedicated hooks token is separate from gateway auth token
- VPS reaches EC2 over Tailscale
- Caddy routes /webhooks/resend to n8n with Resend IP restriction
- Existing Slack Socket Mode connection unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/20-inbound-email-infrastructure/20-01-SUMMARY.md`
</output>
