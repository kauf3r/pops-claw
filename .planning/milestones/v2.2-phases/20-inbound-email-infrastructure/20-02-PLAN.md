---
phase: 20-inbound-email-infrastructure
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - n8n workflow (VPS UI)
  - Resend dashboard config
  - DNS MX record
autonomous: false
requirements:
  - "svix-signature-verification"
  - "n8n-webhook-workflow"
  - "two-step-email-read"
  - "email-to-slack-bridging"
  - "mx-record-inbound"
  - "resend-webhook-secret"

must_haves:
  truths:
    - "Resend webhook POST to VPS triggers n8n workflow"
    - "n8n verifies Svix signature and rejects invalid payloads with 401"
    - "n8n fetches first ~200 chars of email body via Resend API"
    - "n8n forwards email metadata + body preview to OpenClaw /hooks/agent"
    - "Bob posts inbound email summary (sender, subject, preview, timestamp) to #popsclaw"
    - "MX record routes emails to Resend inbound SMTP"
    - "Full email body available on demand via Resend API"
  artifacts:
    - path: "n8n 'Resend Inbound Email Relay' workflow"
      provides: "5-node webhook relay with Svix verification"
    - path: "DNS MX record for mail.andykaufman.net"
      provides: "Inbound email routing to Resend"
  key_links:
    - from: "Resend webhook"
      to: "VPS Caddy /webhooks/resend"
      via: "HTTPS POST with Svix headers"
    - from: "n8n Code node"
      to: "Resend Received Emails API"
      via: "GET /emails/receiving/{id} with full_access key"
    - from: "n8n HTTP Request node"
      to: "EC2 /hooks/agent"
      via: "POST over Tailscale with hooks token"
    - from: "OpenClaw hooks"
      to: "#popsclaw"
      via: "Bob agent turn with deliver: true"

user_setup:
  - service: resend
    why: "Configure webhook endpoint + MX record for inbound email"
    dashboard_config:
      - task: "Enable receiving on mail.andykaufman.net domain"
        location: "Resend Dashboard -> Domains -> mail.andykaufman.net -> Receiving tab"
      - task: "Add webhook endpoint URL with email.received event"
        location: "Resend Dashboard -> Webhooks -> Add Endpoint"
      - task: "Copy webhook signing secret (whsec_...)"
        location: "Resend Dashboard -> Webhooks -> endpoint details"
      - task: "Add MX record from Resend to DNS"
        location: "DNS provider for andykaufman.net"
---

<objective>
Build the n8n webhook workflow that receives Resend inbound email webhooks, verifies Svix signatures, fetches a body preview, and forwards metadata to OpenClaw hooks. Then configure Resend webhook endpoint, add MX record, and run end-to-end test.

Purpose: Complete the inbound email relay pipeline so emails to *@mail.andykaufman.net reach Bob and he notifies Andy in #popsclaw.
Output: Working n8n workflow, Resend webhook configured, MX record active, verified E2E pipeline.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-inbound-email-infrastructure/20-RESEARCH.md
@.planning/phases/20-inbound-email-infrastructure/20-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build n8n Resend Inbound Email Relay workflow</name>
  <files>n8n workflow on VPS (165.22.139.214)</files>
  <action>
Access n8n on VPS and create a new workflow named "Resend Inbound Email Relay" with these nodes:

**Node 1: Webhook Trigger**
- HTTP Method: POST
- Path: `/webhooks/resend` (must match Caddy route from Plan 01)
- Authentication: None (Svix verification handles auth)
- Response: "Using 'Respond to Webhook' Node"
- Raw Body: ENABLED (critical for Svix signature verification)

**Node 2: Code - Verify Svix Signature**
Connected to: Webhook Trigger (main output)
Error output: connects to Node 5b (Respond 401)

```javascript
const crypto = require('crypto');

// Get raw body and Svix headers
const rawBody = $input.first().json.body;
const svixId = $input.first().json.headers['svix-id'];
const svixTimestamp = $input.first().json.headers['svix-timestamp'];
const svixSignature = $input.first().json.headers['svix-signature'];

// Get webhook secret from environment
const secret = $env.RESEND_WEBHOOK_SECRET;

if (!svixId || !svixTimestamp || !svixSignature || !secret) {
  throw new Error('Missing Svix headers or webhook secret');
}

// Timestamp tolerance check (5 minutes)
const now = Math.floor(Date.now() / 1000);
if (Math.abs(now - parseInt(svixTimestamp)) > 300) {
  throw new Error('Webhook timestamp outside tolerance window');
}

// Compute HMAC-SHA256
const signedContent = `${svixId}.${svixTimestamp}.${rawBody}`;
const secretBytes = Buffer.from(secret.split('_')[1], 'base64');
const computedSignature = crypto
  .createHmac('sha256', secretBytes)
  .update(signedContent)
  .digest('base64');

// Compare against provided signatures
const expectedSignature = `v1,${computedSignature}`;
const signatures = svixSignature.split(' ');
const isValid = signatures.some(sig => sig === expectedSignature);

if (!isValid) {
  throw new Error('Invalid Svix signature');
}

// Parse and return verified payload
const payload = JSON.parse(rawBody);
return [{ json: payload }];
```

**Node 3: Code - Extract Metadata + Filter Event Type**
Connected to: Node 2 (main output)

```javascript
const payload = $input.first().json;

// Only process email.received events
if (payload.type !== 'email.received') {
  return []; // Skip non-inbound events
}

const data = payload.data;

return [{
  json: {
    email_id: data.email_id,
    from: data.from,
    to: Array.isArray(data.to) ? data.to.join(', ') : data.to,
    subject: data.subject || '(no subject)',
    timestamp: data.created_at,
    message_id: data.message_id,
    has_attachments: (data.attachments && data.attachments.length > 0)
  }
}];
```

**Node 3b: HTTP Request - Fetch Body Preview**
Connected to: Node 3 (main output)

- Method: GET
- URL: `https://api.resend.com/emails/receiving/{{ $json.email_id }}`
- Authentication: Header Auth
  - Header Name: `Authorization`
  - Header Value: `Bearer {{ $env.RESEND_FULL_API_KEY }}`
- On Error: Continue (don't fail the whole pipeline if body fetch fails)

Add a Code node after this to extract the preview:

```javascript
const metadata = $('Code - Extract Metadata + Filter Event Type').first().json;
const emailData = $input.first().json;

// Extract first ~200 chars of body (prefer plain text, fall back to HTML stripped)
let bodyPreview = '';
if (emailData.text) {
  bodyPreview = emailData.text.substring(0, 200);
} else if (emailData.html) {
  bodyPreview = emailData.html.replace(/<[^>]*>/g, '').substring(0, 200);
}
if (bodyPreview.length >= 200) bodyPreview += '...';

return [{
  json: {
    ...metadata,
    body_preview: bodyPreview || '(no body content)'
  }
}];
```

**Node 4: HTTP Request - POST to OpenClaw Hooks**
Connected to: Node 3b output

- Method: POST
- URL: `http://100.72.143.9:18789/hooks/agent`
- Headers:
  - `x-openclaw-token`: `{{ $env.OPENCLAW_HOOKS_TOKEN }}` (the dedicated hooks token from Plan 01)
  - `Content-Type`: `application/json`
- Body (JSON):

```json
{
  "message": "Inbound email received.\n\nFrom: {{ $json.from }}\nTo: {{ $json.to }}\nSubject: {{ $json.subject }}\nReceived: {{ $json.timestamp }}\nAttachments: {{ $json.has_attachments }}\n\nPreview:\n{{ $json.body_preview }}\n\nNotify Andy in #popsclaw with a summary of this email: sender, subject, preview, and timestamp.\n\nIf Andy asks for the full email body, fetch it with:\ncurl -s -X GET 'https://api.resend.com/emails/receiving/{{ $json.email_id }}' -H 'Authorization: Bearer $RESEND_API_KEY'",
  "name": "Inbound Email",
  "sessionKey": "hook:inbound-email:{{ $json.email_id }}",
  "wakeMode": "now",
  "deliver": true,
  "channel": "slack",
  "to": "#popsclaw"
}
```

- Retry on Failure: Yes, 3 attempts
- Retry Interval: 1000ms (exponential backoff)
- Success codes: 200, 202 (OpenClaw returns 202 for accepted async hooks -- do NOT retry on 202)

**Node 5a: Respond to Webhook - 200 OK**
Connected to: Node 4 (main output)
- Response Code: 200
- Response Body: `{"status": "accepted"}`

**Node 5b: Respond to Webhook - 401 Unauthorized**
Connected to: Node 2 (error output)
- Response Code: 401
- Response Body: `{"error": "signature verification failed"}`

**Environment Variables to configure in n8n:**
- `RESEND_WEBHOOK_SECRET`: the `whsec_...` signing secret from Resend dashboard (Step 2 provides)
- `RESEND_FULL_API_KEY`: a Resend API key with `full_access` scope (for reading received emails)
- `OPENCLAW_HOOKS_TOKEN`: the dedicated hooks token generated in Plan 01

**Activate the workflow** after building.

**Test with manual webhook** (from VPS terminal):
```bash
# This tests the n8n workflow with a mock payload (will fail Svix verification -- that's expected)
# Real testing happens after Resend webhook is configured in Task 2
curl -X POST http://localhost:5678/webhooks/resend \
  -H "Content-Type: application/json" \
  -d '{"type":"email.received","data":{"email_id":"test-123","from":"test@example.com","to":["bob@mail.andykaufman.net"],"subject":"Test","created_at":"2026-02-16T20:00:00Z"}}'
```
This should return 401 (no Svix headers = verification failure). This confirms the verification logic works correctly.
  </action>
  <verify>
1. n8n workflow "Resend Inbound Email Relay" exists and is active
2. Workflow has correct node structure: Webhook -> Verify Svix -> Extract Metadata -> Fetch Body Preview -> POST to OpenClaw -> Respond 200 (with 401 error branch)
3. Manual test POST without Svix headers returns 401 (verification rejects)
4. Environment variables configured: RESEND_WEBHOOK_SECRET, RESEND_FULL_API_KEY, OPENCLAW_HOOKS_TOKEN
  </verify>
  <done>
n8n workflow receives webhooks, verifies Svix signatures (rejects invalid), extracts metadata, fetches body preview via Resend API, and forwards to OpenClaw /hooks/agent with delivery to #popsclaw.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Resend webhook + MX record + E2E test</name>
  <what-built>n8n workflow ready to receive Resend webhooks (Task 1). Gateway hooks endpoint active (Plan 01). Caddy routing configured (Plan 01).</what-built>
  <how-to-verify>
**Step 1: Enable Resend Receiving**
1. Go to Resend Dashboard -> Domains -> mail.andykaufman.net
2. Enable "Receiving" for this domain
3. Copy the MX record value shown (e.g., `inbound-smtp.resend.com` with priority 10)

**Step 2: Add MX Record to DNS**
1. Go to your DNS provider for andykaufman.net
2. Add MX record for `mail` subdomain:
   - Host: `mail` (or `mail.andykaufman.net`)
   - Type: MX
   - Priority: 10
   - Value: (the value from Resend dashboard)
3. Wait for DNS propagation (~5 min, verify with `dig MX mail.andykaufman.net`)

**Step 3: Configure Resend Webhook Endpoint**
1. Go to Resend Dashboard -> Webhooks -> Add Endpoint
2. URL: `https://YOUR_VPS_DOMAIN/webhooks/resend` (the Caddy route from Plan 01)
3. Events: select `email.received`
4. Save the endpoint
5. Copy the **Signing Secret** (`whsec_...`) -- this goes into n8n as RESEND_WEBHOOK_SECRET

**Step 4: Configure n8n Environment Variables**
Set `RESEND_WEBHOOK_SECRET` in n8n to the signing secret from Step 3 (if not already set during Task 1).

**Step 5: End-to-End Test**
1. Send an email from your personal Gmail to `test@mail.andykaufman.net`
2. Wait ~30 seconds for pipeline:
   - Resend receives email via MX record
   - Resend fires webhook to VPS Caddy
   - Caddy proxies to n8n
   - n8n verifies Svix, extracts metadata, fetches body preview
   - n8n POSTs to OpenClaw /hooks/agent
   - Bob receives the hook and posts to #popsclaw
3. Check #popsclaw for Bob's notification -- should contain:
   - Sender (your Gmail)
   - Subject
   - Body preview (~200 chars)
   - Timestamp
4. Ask Bob in #popsclaw to fetch the full email body (he should use `curl GET /emails/receiving/{id}`)
5. Verify Bob can retrieve and display the full email content

**If E2E fails, check in order:**
- Resend dashboard: Was the email received? (Receiving tab)
- Resend dashboard: Was the webhook fired? (Webhooks -> Logs)
- n8n: Check execution history for the workflow
- OpenClaw: `journalctl --user -u openclaw-gateway.service --since '5 min ago'`
  </how-to-verify>
  <resume-signal>Provide the results: (1) MX record value used, (2) whether #popsclaw received the notification, (3) whether Bob could fetch the full body. Type "E2E passed" if all steps succeeded, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. Send email to any address @mail.andykaufman.net -> Bob notifies in #popsclaw within ~60 seconds
2. Notification contains: sender, subject, body preview (~200 chars), timestamp
3. Ask Bob for full email -> he fetches via Resend API and displays full content
4. Send webhook without valid Svix signature -> n8n returns 401 (rejection)
5. n8n execution history shows successful runs
6. No duplicate notifications for the same email
</verification>

<success_criteria>
- Emails to *@mail.andykaufman.net arrive in Resend
- n8n verifies Svix signatures and rejects unsigned payloads
- n8n fetches body preview and forwards metadata to OpenClaw
- Bob posts inbound email summary to #popsclaw (sender, subject, preview, timestamp)
- Full email body retrievable on demand via Resend API
- MX record resolves correctly (`dig MX mail.andykaufman.net`)
</success_criteria>

<output>
After completion, create `.planning/phases/20-inbound-email-infrastructure/20-02-SUMMARY.md`
</output>
