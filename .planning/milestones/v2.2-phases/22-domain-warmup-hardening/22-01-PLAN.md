---
phase: 22-domain-warmup-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/clawd/agents/main/WARMUP.md
  - /home/ubuntu/.openclaw/skills/resend-email/SKILL.md
  - /home/ubuntu/clawd/agents/main/email-config.json
  - /home/ubuntu/.openclaw/cron/jobs.json
autonomous: true
requirements: []

must_haves:
  truths:
    - "WARMUP.md checklist exists in Bob's workspace with 5-step DNS/auth/inbox/monitor/DMARC sequence"
    - "Sending >95 emails/day is hard-blocked with refusal + Andy notification in #popsclaw"
    - "Sending >80 emails/day triggers warning in #popsclaw"
    - "Monthly send count tracked in email-config.json with alert at 2700/month"
    - "email-catchup cron polls Resend Received Emails API every 30 min and recovers missed webhooks"
    - "Catch-up cron deduplicates against email.db and only notifies if recovery happened"
    - "Bounce rate >2% or complaint rate >0.08% triggers immediate #popsclaw alert"
    - "Email health metrics included in morning briefing"
  artifacts:
    - path: "/home/ubuntu/clawd/agents/main/WARMUP.md"
      provides: "Domain warmup checklist (DNS verify, auth headers, inbox placement, 2-week monitor, DMARC escalation)"
    - path: "/home/ubuntu/.openclaw/skills/resend-email/SKILL.md"
      provides: "Updated quota enforcement (Section 9) with monthly tracking + 80/95 daily thresholds + 2700 monthly threshold"
    - path: "/home/ubuntu/clawd/agents/main/email-config.json"
      provides: "monthly_send_count + monthly_send_month fields for month-boundary reset"
    - path: "/home/ubuntu/.openclaw/cron/jobs.json"
      provides: "email-catchup cron job + morning briefing updated with email health section"
  key_links:
    - from: "SKILL.md Section 9"
      to: "email-config.json"
      via: "JSON read/write for quota counters before/after every send"
      pattern: "daily_send_count.*monthly_send_count"
    - from: "email-catchup cron"
      to: "email.db"
      via: "SELECT COUNT(*) FROM email_conversations WHERE resend_email_id dedup"
      pattern: "resend_email_id"
    - from: "morning briefing cron"
      to: "email.db"
      via: "SQL queries for bounce/complaint rates"
      pattern: "delivery_status.*bounced.*complained"
---

<objective>
Deploy domain warmup checklist, enhanced quota monitoring with monthly tracking and threshold alerts, catch-up cron for webhook downtime fallback, and email health monitoring in Bob's morning briefing.

Purpose: Harden the Resend email integration from Phases 19-21 with reputation management, quota safety, downtime resilience, and health monitoring. Final phase of v2.2 milestone.

Output: WARMUP.md reference doc, updated SKILL.md with quota thresholds, updated email-config.json with monthly fields, email-catchup cron job, morning briefing with email health section.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-domain-warmup-hardening/22-CONTEXT.md
@.planning/phases/22-domain-warmup-hardening/22-RESEARCH.md
@.planning/phases/19-outbound-email-foundation/19-02-SUMMARY.md
@.planning/phases/21-inbound-email-processing/21-01-SUMMARY.md
@.planning/phases/21-inbound-email-processing/21-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WARMUP.md checklist and update SKILL.md quota enforcement</name>
  <files>
    /home/ubuntu/clawd/agents/main/WARMUP.md
    /home/ubuntu/.openclaw/skills/resend-email/SKILL.md
    /home/ubuntu/clawd/agents/main/email-config.json
  </files>
  <action>
    **WARMUP.md** — Create reference doc in Bob's workspace (`~/clawd/agents/main/WARMUP.md`, accessible as `/workspace/WARMUP.md` in sandbox) with 5-step checklist:

    1. **Verify DNS Authentication** — Commands to run:
       - `dig TXT send.mail.andykaufman.net` (SPF — expect `v=spf1 include:amazonses.com ~all`)
       - `dig CNAME` for the 3 DKIM selectors (expect `*.dkim.amazonses.com`)
       - `dig TXT _dmarc.mail.andykaufman.net` (expect `v=DMARC1; p=none;`)
    2. **Verify Email Authentication Headers** — Send test email to theandykaufman@gmail.com, instruct Andy to check Gmail "Show original" for SPF: PASS, DKIM: PASS, DMARC: PASS
    3. **Confirm Inbox Placement** — Checklist items: arrived in inbox (not spam), From name "Bob" displays correctly, HTML renders properly
    4. **Monitor for 2 Weeks** — Checklist: all outbound delivers to inbox, no bounces, no complaints, Resend dashboard healthy
    5. **Escalate DMARC** — After Andy confirms 2 clean weeks: update `_dmarc.mail.andykaufman.net` from `p=none` to `p=quarantine; pct=100;`. NOTE: DMARC escalation is MANUAL — Andy updates DNS when ready.

    Include a status field at top: `## Status: PENDING` (Bob updates as steps complete).

    **SKILL.md Section 9 update** — The existing Section 9 (Rate Limiting) already has daily quota logic. Update it to add:

    1. Monthly counter fields: `monthly_send_count` and `monthly_send_month` in email-config.json
    2. Monthly reset logic: if `monthly_send_month` != current month (YYYY-MM format), reset `monthly_send_count` to 0 and update `monthly_send_month`
    3. Daily thresholds (per user decision):
       - `daily_send_count >= 95` → HARD BLOCK: refuse to send, log refusal, notify Andy in #popsclaw. Message: "Daily limit reached ({count}/100). Only 5 remaining for critical alerts."
       - `daily_send_count >= 80` → WARNING: continue sending but notify Andy in #popsclaw. Message: "Daily sends at {count}/100. Approaching limit."
    4. Monthly threshold: `monthly_send_count >= 2700` → WARNING + BLOCK: refuse non-critical sends, notify Andy in #popsclaw. Message: "Monthly limit approaching ({count}/3000)."
    5. When ANY limit is hit: Bob refuses to send, logs refusal, notifies Andy — no silent failures.
    6. Update the existing Section 9 quota check flow to read both daily AND monthly counters from email-config.json, and increment both after successful send.

    Do NOT remove existing rate limiting logic (1 reply/sender/hour, 10/5min hard cap). The quota thresholds are ADDITIONAL checks on top of those.

    **email-config.json** — Add two new fields to the existing JSON:
    - `"monthly_send_count": 0`
    - `"monthly_send_month": "2026-02"`

    Preserve all existing fields (recipients, daily_send_count, daily_send_date, alert_count_today, sender_allowlist).

    Use SSH to EC2 (100.72.143.9) with key `~/.ssh/clawdbot-key.pem` for all deployments.
  </action>
  <verify>
    1. `ssh ... cat ~/clawd/agents/main/WARMUP.md | head -5` shows "# Email Domain Warmup Checklist" and "Status: PENDING"
    2. `ssh ... cat ~/clawd/agents/main/WARMUP.md | grep -c '## Step'` returns 5
    3. `ssh ... grep -c 'monthly_send' ~/.openclaw/skills/resend-email/SKILL.md` returns 3+ (monthly counter references)
    4. `ssh ... grep -c 'HARD BLOCK\|hard.block' ~/.openclaw/skills/resend-email/SKILL.md` returns 1+
    5. `ssh ... python3 -c "import json; c=json.load(open('/home/ubuntu/clawd/agents/main/email-config.json')); print(c.get('monthly_send_count'), c.get('monthly_send_month'))"` returns `0 2026-02`
    6. `ssh ... grep 'sender_allowlist' ~/clawd/agents/main/email-config.json` confirms existing field preserved
    7. `ssh ... /home/ubuntu/.npm-global/bin/openclaw skills list 2>/dev/null | grep -i resend` shows "ready"
  </verify>
  <done>
    WARMUP.md exists with 5-step checklist (DNS, auth headers, inbox, 2-week monitor, DMARC escalation). SKILL.md Section 9 enforces daily 80/95 and monthly 2700 thresholds with hard-block + notification. email-config.json has monthly_send_count and monthly_send_month fields. Skill still detected as "ready" by OpenClaw.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create email-catchup cron job</name>
  <files>
    /home/ubuntu/.openclaw/cron/jobs.json
  </files>
  <action>
    Add `email-catchup` cron job to `~/.openclaw/cron/jobs.json` on EC2 via SSH. The job configuration (per CONTEXT.md and RESEARCH.md):

    ```json
    {
      "id": "email-catchup",
      "agentId": "main",
      "name": "email-catchup",
      "description": "Poll Resend for missed inbound emails (webhook downtime fallback)",
      "enabled": true,
      "schedule": {
        "kind": "cron",
        "expr": "15,45 * * * *",
        "tz": "America/Los_Angeles"
      },
      "sessionTarget": "isolated",
      "wakeMode": "now",
      "payload": {
        "kind": "agentTurn",
        "message": "Email catch-up check: poll Resend Received Emails API for missed inbound emails.\n\n1. Fetch recent emails: curl -s -X GET 'https://api.resend.com/emails/receiving?limit=100' -H \"Authorization: Bearer $RESEND_API_KEY\"\n2. For each email in the response, check email.db: SELECT COUNT(*) FROM email_conversations WHERE resend_email_id='EMAIL_ID';\n3. If count=0 AND created_at is within last 2 hours: this email was missed by webhooks. Process it using Section 8 (Inbound Email Processing) of the resend-email skill.\n4. If ALL emails already exist in DB: no action needed. Do NOT post to any channel. Simply complete silently.\n5. If any emails were recovered: notify Andy in #popsclaw with count and sender/subject summary.\n\nIMPORTANT: Only process emails with created_at within the last 2 hours. Older emails were either already processed or intentionally skipped. If the API returns has_more:true, log a warning but do NOT paginate — 100 results covers weeks at current volume.",
        "model": "sonnet"
      },
      "delivery": {
        "mode": "silent"
      }
    }
    ```

    **Key decisions (from CONTEXT.md):**
    - Schedule: `15,45 * * * *` — offset from :00/:30 to avoid collision with existing crons
    - Session: isolated (ephemeral, doesn't pollute Bob's main session)
    - Timeout: 120000ms (120s)
    - Delivery: silent (agent decides whether to notify based on recovery count)
    - Model: sonnet
    - 24/7 schedule (email arrives anytime)
    - Lookback window: 2 hours (covers brief outages; Svix retries up to ~34hr)
    - Dedup: query email.db for existing resend_email_id before processing

    **Implementation approach:**
    1. Read current jobs.json via SSH
    2. Use python3 on EC2 to parse JSON, append the new job, write back (preserves existing jobs)
    3. Restart gateway to pick up new cron: `systemctl --user restart openclaw-gateway`
    4. Verify job appears in `openclaw cron list`

    **IMPORTANT:** The `sessionTarget: "isolated"` requires `payload.kind: "agentTurn"` with `message` field (not `systemEvent` with `text`). This is per the lesson learned about payload kind matching sessionTarget.

    Also add `"timeout": 120000` to the job configuration.
  </action>
  <verify>
    1. `ssh ... /home/ubuntu/.npm-global/bin/openclaw cron list 2>/dev/null | grep email-catchup` shows the job
    2. `ssh ... python3 -c "import json; jobs=json.load(open('/home/ubuntu/.openclaw/cron/jobs.json')); catchup=[j for j in jobs if j['id']=='email-catchup'][0]; print(catchup['schedule']['expr'], catchup['sessionTarget'], catchup['payload']['kind'])"` returns `15,45 * * * * isolated agentTurn`
    3. `ssh ... systemctl --user is-active openclaw-gateway` returns `active`
    4. Total cron count: `ssh ... /home/ubuntu/.npm-global/bin/openclaw cron list --json 2>/dev/null | python3 -c "import json,sys; print(len(json.load(sys.stdin)))"` returns 20 (19 existing + 1 new)
  </verify>
  <done>
    email-catchup cron job running every 30 min (at :15 and :45), polling Resend Received Emails API for missed webhooks. Uses isolated/sonnet/agentTurn/silent pattern. Dedup via email.db. Only notifies #popsclaw if recovery actually happens. Gateway restarted and cron visible in `openclaw cron list`.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add email health monitoring to morning briefing</name>
  <files>
    /home/ubuntu/.openclaw/cron/jobs.json
  </files>
  <action>
    Update the morning briefing cron job in `jobs.json` to add an email health section. Per research recommendation: add email health metrics to the existing morning briefing rather than creating a separate cron (Bob already reads email-config.json for the email send step).

    **Add Section 9: Email Health Check** to the morning briefing cron message (between existing Section 8 Email Briefing and the end). The section instructs Bob to:

    1. Run bounce rate SQL query on email.db:
       ```sql
       SELECT
         CASE WHEN COUNT(*) < 10 THEN 'LOW_VOLUME'
         ELSE CAST(ROUND(CAST(SUM(CASE WHEN delivery_status='bounced' THEN 1 ELSE 0 END) AS REAL) / COUNT(*) * 100, 2) AS TEXT) || '%'
         END AS bounce_rate,
         SUM(CASE WHEN delivery_status='bounced' THEN 1 ELSE 0 END) AS bounced,
         COUNT(*) AS total
       FROM email_conversations
       WHERE direction = 'outbound' AND created_at >= datetime('now', '-7 days');
       ```

    2. Run complaint rate SQL query on email.db:
       ```sql
       SELECT
         CASE WHEN COUNT(*) < 20 THEN 'LOW_VOLUME'
         ELSE CAST(ROUND(CAST(SUM(CASE WHEN delivery_status='complained' THEN 1 ELSE 0 END) AS REAL) / COUNT(*) * 100, 2) AS TEXT) || '%'
         END AS complaint_rate,
         SUM(CASE WHEN delivery_status='complained' THEN 1 ELSE 0 END) AS complained,
         COUNT(*) AS total
       FROM email_conversations
       WHERE direction = 'outbound' AND created_at >= datetime('now', '-7 days');
       ```

    3. Run volume stats:
       ```sql
       SELECT
         SUM(CASE WHEN direction='outbound' AND created_at >= datetime('now', '-7 days') THEN 1 ELSE 0 END) AS outbound_week,
         SUM(CASE WHEN direction='inbound' AND created_at >= datetime('now', '-7 days') THEN 1 ELSE 0 END) AS inbound_week,
         SUM(CASE WHEN direction='outbound' AND created_at >= datetime('now', '-30 days') THEN 1 ELSE 0 END) AS outbound_month
       FROM email_conversations;
       ```

    4. Read email-config.json for current daily_send_count and monthly_send_count.

    5. **Threshold alerts** (per CONTEXT.md decisions):
       - If bounce rate > 2% AND total outbound >= 10: **IMMEDIATE ALERT** in #popsclaw
       - If complaint rate > 0.08% AND total outbound >= 20: **IMMEDIATE ALERT** in #popsclaw
       - Low-volume thresholds from RESEARCH pitfall 4: report absolute numbers ("1 bounce this week") instead of percentages when below minimum volume

    6. Include brief summary in briefing output: "Email Health: {outbound_week} sent this week, {bounce_count} bounces, {complaint_count} complaints. Daily: {daily_count}/100, Monthly: {monthly_count}/3000."

    **Implementation:**
    1. Read current jobs.json via SSH
    2. Find the morning briefing job (id contains "morning" or "briefing")
    3. Append Section 9 to both `text` and `message` fields (morning briefing uses `agentTurn` with isolated session, so update `message` field; also update `text` if present for compatibility)
    4. The section should use `/workspace/email.db` path (isolated sessions run in Docker sandbox)
    5. Write updated jobs.json
    6. Restart gateway: `systemctl --user restart openclaw-gateway`

    **NOTE:** Morning briefing runs in isolated session (Docker sandbox), so paths must use `/workspace/` (not host paths). email.db is bind-mounted to `/workspace/email.db`.
  </action>
  <verify>
    1. `ssh ... /home/ubuntu/.npm-global/bin/openclaw cron list --json 2>/dev/null | python3 -c "import json,sys; jobs=json.load(sys.stdin); briefing=[j for j in jobs if 'briefing' in j.get('name','').lower() or 'morning' in j.get('name','').lower()][0]; print('Email Health' in briefing['payload'].get('message',''))"` returns `True`
    2. `ssh ... grep -c 'bounce_rate\|complaint_rate\|Email Health' ~/.openclaw/cron/jobs.json` returns 3+
    3. `ssh ... grep -c 'delivery_status.*bounced\|delivery_status.*complained' ~/.openclaw/cron/jobs.json` returns 2+
    4. `ssh ... systemctl --user is-active openclaw-gateway` returns `active`
  </verify>
  <done>
    Morning briefing includes Section 9: Email Health Check with bounce rate, complaint rate, and volume stats from email.db. Threshold alerts fire at bounce >2% (min 10 outbound) or complaint >0.08% (min 20 outbound) with immediate #popsclaw notification. Low-volume uses absolute numbers instead of misleading percentages. Daily and monthly quota counts reported from email-config.json.
  </done>
</task>

</tasks>

<verification>
1. **WARMUP.md exists and is accessible:** `ls -la ~/clawd/agents/main/WARMUP.md` shows file; `docker exec` or sandbox test confirms `/workspace/WARMUP.md` accessible
2. **Quota enforcement works:** SKILL.md Section 9 has daily (80 warn, 95 block) and monthly (2700) thresholds with explicit refusal + notification behavior
3. **Monthly counter in config:** email-config.json has `monthly_send_count` and `monthly_send_month` fields
4. **Catch-up cron running:** `openclaw cron list` shows `email-catchup` at `15,45 * * * *`
5. **Morning briefing has health check:** Briefing cron message includes Section 9 with SQL queries and threshold alerts
6. **Total cron count:** 20 (19 existing + email-catchup)
7. **Gateway healthy:** `systemctl --user is-active openclaw-gateway` returns `active`
8. **Skill still ready:** `openclaw skills list` shows resend-email as "ready"
</verification>

<success_criteria>
- WARMUP.md deployed with 5-step checklist for Bob to work through
- SKILL.md enforces daily 80/95 and monthly 2700 thresholds (hard-block + notification, no silent failures)
- email-config.json tracks monthly send count with month-boundary reset
- email-catchup cron polls Resend every 30 min, deduplicates against email.db, only notifies on recovery
- Morning briefing includes email health metrics with threshold-based alerting
- All 8 phase success criteria truths are achievable
</success_criteria>

<output>
After completion, create `.planning/phases/22-domain-warmup-hardening/22-01-SUMMARY.md`
</output>
