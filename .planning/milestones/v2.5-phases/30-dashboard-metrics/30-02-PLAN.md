---
phase: 30-dashboard-metrics
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - src/app/page.tsx
  - src/components/dashboard/freshness-indicator.tsx
  - src/components/dashboard/activity-feed.tsx
  - src/components/dashboard/pipeline-metrics.tsx
  - src/components/dashboard/email-metrics.tsx
autonomous: false
requirements: [DASH-01, DASH-02, DASH-03, PIPE-01, PIPE-02]

must_haves:
  truths:
    - "Dashboard shows 4 status cards in a grid: Agent Health, Cron Success, Content Pipeline, Email Quota"
    - "Each card has a headline number, colored dot, and one-line detail"
    - "Activity feed shows chronological entries with icon + timestamp + description, color-coded by type"
    - "Content pipeline section shows 4 count badges (researched/written/reviewed/published)"
    - "Email section shows sent/received/bounced counts and quota usage bar"
    - "Freshness indicator shows 'Updated Xs ago' with color transitions at 60s and 120s"
    - "All data auto-refreshes every 30 seconds via SWR polling"
  artifacts:
    - path: "src/app/page.tsx"
      provides: "Full dashboard layout with 4 status cards, activity feed, pipeline metrics, email metrics"
      contains: "useSWR"
      min_lines: 50
    - path: "src/components/dashboard/freshness-indicator.tsx"
      provides: "Freshness timer with color transitions"
      contains: "FreshnessIndicator"
    - path: "src/components/dashboard/activity-feed.tsx"
      provides: "Chronological activity stream with type-based coloring"
      contains: "ActivityFeed"
    - path: "src/components/dashboard/pipeline-metrics.tsx"
      provides: "4 count badges for content pipeline statuses"
      contains: "PipelineMetrics"
    - path: "src/components/dashboard/email-metrics.tsx"
      provides: "Sent/received/bounced counts + quota usage bar"
      contains: "EmailMetrics"
  key_links:
    - from: "src/app/page.tsx"
      to: "/api/dashboard/agents"
      via: "useSWR('/api/dashboard/agents')"
      pattern: "useSWR.*dashboard/agents"
    - from: "src/app/page.tsx"
      to: "/api/dashboard/crons"
      via: "useSWR('/api/dashboard/crons')"
      pattern: "useSWR.*dashboard/crons"
    - from: "src/app/page.tsx"
      to: "/api/dashboard/metrics"
      via: "useSWR('/api/dashboard/metrics')"
      pattern: "useSWR.*dashboard/metrics"
    - from: "src/app/page.tsx"
      to: "/api/dashboard/activity"
      via: "useSWR('/api/dashboard/activity')"
      pattern: "useSWR.*dashboard/activity"
    - from: "src/app/page.tsx"
      to: "src/components/dashboard/status-card.tsx"
      via: "imports StatusCard from Plan 01"
      pattern: "StatusCard"
    - from: "src/app/page.tsx"
      to: "src/components/dashboard/freshness-indicator.tsx"
      via: "imports FreshnessIndicator"
      pattern: "FreshnessIndicator"
---

<objective>
Compose the full dashboard page from Plan 01's data layer: rewrite page.tsx with 4 status cards, build the activity feed, pipeline metrics, email metrics components, and the freshness indicator. Dashboard answers "is everything OK?" at a glance.

Purpose: This is the user-facing result -- the operational dashboard that auto-refreshes every 30 seconds.
Output: Working dashboard at http://100.72.143.9:3001 with live data from all 5 databases.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/30-dashboard-metrics/30-CONTEXT.md
@.planning/phases/30-dashboard-metrics/30-RESEARCH.md
@.planning/phases/30-dashboard-metrics/30-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite dashboard page with status cards and freshness indicator</name>
  <files>
    src/app/page.tsx
    src/components/dashboard/freshness-indicator.tsx
  </files>
  <action>
Create `src/components/dashboard/freshness-indicator.tsx`:
- "use client" component
- Props: {lastUpdated: number} (Date.now() timestamp)
- useState for elapsed seconds, useEffect resets to 0 on lastUpdated change and runs 1-second interval
- Color logic: default="text-muted-foreground", >60s="text-amber-400", >120s="text-rose-400"
- Render: `<span className={...}>Updated {elapsed}s ago</span>` with text-xs and transition-colors
- Per locked decision: subtle, no manual refresh button, color changes on staleness

Rewrite `src/app/page.tsx` (currently shows 5 DB status cards from Phase 29):
- "use client" with useSWR for 4 endpoints: /api/dashboard/agents, /api/dashboard/crons, /api/dashboard/metrics, /api/dashboard/activity
- Track lastUpdated with useState(Date.now()) that resets in useEffect whenever any data changes
- Page layout (responsive, dark theme using existing zinc+blue palette):
  - Header: "Mission Control" title + FreshnessIndicator aligned right
  - 4 status cards in grid (2x2 on md+, 1 col on mobile) using StatusCard component from Plan 01:
    1. Agent Health: icon=Users (lucide), headline=alive count, status=ok if all alive / warn if some stale / error if any down, detail="N/7 agents alive"
    2. Cron Success: icon=Clock (lucide), headline=successRate+"%", status=ok if >=95 / warn if >=80 / error if <80, detail="N% success rate"
    3. Content Pipeline: icon=FileText (lucide), headline=total article count, status=ok if total>0 / warn if total=0 (no articles yet), detail="N articles total"
    4. Email Quota: icon=Mail (lucide), headline=dailySent+"/"+dailyQuota, status=ok if dailySent<80 / warn if <95 / error if >=95, detail="N/100 daily, M/3000 monthly"
  - Below cards: two-column layout (activity feed left ~60%, metrics right ~40%) on lg+, stacked on mobile
  - Left column: ActivityFeed component (from Task 2)
  - Right column: PipelineMetrics + EmailMetrics stacked (from Task 2)
- KEEP the existing DB status section from Phase 29 at the bottom (SystemStatus + DbStatusCard components) -- do not remove, just push below the new dashboard content
- Handle loading states: show skeleton/muted text while SWR is loading (data === undefined)
- Handle error states: show card with amber dot and "Data unavailable" detail
  </action>
  <verify>
SSH to EC2 and rebuild: `cd ~/clawd/mission-control && npm run build 2>&1 | tail -20` -- build succeeds. Restart service: `systemctl --user restart mission-control`. Load http://100.72.143.9:3001 and confirm 4 status cards appear with data.
  </verify>
  <done>Dashboard page shows "Mission Control" header with freshness indicator, 4 status cards (Agent Health, Cron Success, Content Pipeline, Email Quota) in responsive grid, and placeholder spots for activity feed and metrics components. Freshness indicator counts up and changes color at 60s/120s.</done>
</task>

<task type="auto">
  <name>Task 2: Build activity feed, pipeline metrics, and email metrics components</name>
  <files>
    src/components/dashboard/activity-feed.tsx
    src/components/dashboard/pipeline-metrics.tsx
    src/components/dashboard/email-metrics.tsx
  </files>
  <action>
Rewrite `src/components/dashboard/activity-feed.tsx` (currently a stub from Phase 29):
- "use client" component
- Props: {entries: ActivityEntry[], hasMore: boolean, onLoadMore: () => void, isLoading: boolean}
- Per locked decision: flat chronological list, newest first, one line per entry
- Each entry renders: type icon (lucide icons -- Bot for agent, Clock for cron, Mail for email, FileText for content) + RelativeTime timestamp (reuse existing component from Phase 29) + summary text
- Color-code by type using ACTIVITY_COLORS from constants: agent=text-blue-400, cron=text-purple-400, email=text-emerald-400, content=text-orange-400
- No grouping by time or type, no nesting -- clean log view
- Wrap in shadcn Card with title "Recent Activity"
- Use shadcn ScrollArea for the list (already installed)
- "Load more" button at bottom when hasMore=true (Claude's discretion -- simple fixed window approach)
- Empty state: muted text "No recent activity" when entries is empty
- Loading state: show subtle "Loading..." text

Create `src/components/dashboard/pipeline-metrics.tsx`:
- "use client" component
- Props: {pipeline: {researched: number, written: number, reviewed: number, published: number, total: number}}
- Per locked decision: 4 count badges (researched / written / reviewed / published), numbers only, no charts
- Use shadcn Badge component with appropriate variants
- Wrap in shadcn Card with title "Content Pipeline"
- Each badge shows count + label, e.g., "3 Researched", "1 Written"
- Use muted styling when count is 0
- Empty state: show all 4 badges with 0 counts and "No articles yet" subtitle

Create `src/components/dashboard/email-metrics.tsx`:
- "use client" component
- Props: {email: {sent: number, received: number, bounced: number, bounceRate: number, dailySent: number, dailyQuota: number, monthlySent: number, monthlyQuota: number}}
- Per locked decision: sent/received/bounced counts + quota usage bar, numbers only
- Wrap in shadcn Card with title "Email"
- Three count items: Sent, Received, Bounced (show bounceRate% next to bounced)
- Quota usage bar: simple div-based progress bar (not a chart library), showing dailySent/dailyQuota
  - Bar color: emerald if <80%, amber if <95%, rose if >=95%
  - Label below: "N/100 today, M/3,000 this month"
- Empty state: zeros with muted styling, "No emails tracked"

Wire all 3 components into page.tsx:
- ActivityFeed receives data from useSWR("/api/dashboard/activity")
- PipelineMetrics and EmailMetrics receive data from useSWR("/api/dashboard/metrics")
- Implement onLoadMore for activity feed: track offset state, append new entries
  </action>
  <verify>
SSH to EC2: `cd ~/clawd/mission-control && npm run build 2>&1 | tail -20` -- build succeeds. Restart: `systemctl --user restart mission-control`. Load http://100.72.143.9:3001 and verify: activity feed shows entries from coordination.db, pipeline section shows 4 zero-count badges (expected), email section shows zeros with quota bar.
  </verify>
  <done>Activity feed displays chronological entries color-coded by type with timestamps and load-more. Pipeline section shows 4 count badges. Email section shows counts + quota bar. All data auto-refreshes via SWR 30s polling inherited from global config.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify dashboard from Tailscale device</name>
  <files>n/a</files>
  <action>
CHECKPOINT: Human verifies the complete Phase 30 dashboard.

What was built: 4 status cards (Agent Health, Cron Success, Content Pipeline, Email Quota), chronological activity feed, content pipeline count badges, email metrics with quota bar, freshness indicator with color transitions, and 30-second auto-refresh via SWR polling.

How to verify:
1. Open http://100.72.143.9:3001 from any Tailscale-connected device
2. Verify 4 status cards at the top with headline numbers, colored dots, and detail text
3. Verify activity feed shows recent entries (agent heartbeats from coordination.db) with timestamps and color coding
4. Verify content pipeline shows 4 zero-count badges (expected -- no articles yet)
5. Verify email section shows zeros with quota bar (expected -- no emails tracked)
6. Wait 30+ seconds -- verify freshness indicator resets after data refresh
7. Wait 60+ seconds without touching the page -- verify indicator turns amber
8. Scroll down -- verify Phase 29 DB status cards are still visible at the bottom

Resume signal: Type "approved" or describe any layout/data issues to fix.
  </action>
  <verify>User confirms dashboard layout, data accuracy, auto-refresh, and freshness indicator behavior.</verify>
  <done>User has approved the dashboard from a Tailscale device. All 5 Phase 30 requirements satisfied.</done>
</task>

</tasks>

<verification>
1. `npm run build` succeeds on EC2
2. Dashboard loads at http://100.72.143.9:3001 with 4 status cards, activity feed, metrics
3. Agent Health card shows correct alive/total count (expect 5/7 or similar)
4. Cron Success card shows ~95-100% success rate
5. Content Pipeline shows 4 zero-count badges (content.db has no data)
6. Email shows zeros (email.db has no data)
7. Activity feed shows entries from coordination.db with timestamps
8. Freshness indicator counts up, resets on poll, changes color at 60s/120s
9. Data refreshes automatically every 30 seconds
10. Phase 29 DB status section still visible at page bottom
</verification>

<success_criteria>
- Dashboard answers "is everything OK?" at a glance with 4 subsystem status cards
- Activity feed shows real entries from coordination.db in chronological order with type coloring
- Pipeline and email metrics display gracefully even with zero data
- Auto-refresh works at 30s intervals with visible freshness indicator
- User confirms dashboard looks correct from Tailscale device
- All 5 Phase 30 requirements (DASH-01, DASH-02, DASH-03, PIPE-01, PIPE-02) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/30-dashboard-metrics/30-02-SUMMARY.md`
</output>
