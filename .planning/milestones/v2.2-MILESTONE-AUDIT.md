---
milestone: v2.2
audited: 2026-02-17T21:00:00Z
status: tech_debt
scores:
  requirements: 21/22 features satisfied
  phases: 4/4 verified
  integration: 5/6 E2E flows complete
  flows: 6/7 wired (1 broken)
gaps:
  requirements:
    - id: "catch-up-cron-api"
      status: "partial"
      phase: "22-domain-warmup-hardening"
      claimed_by_plans: ["22-01-PLAN.md"]
      completed_by_plans: ["22-01-SUMMARY.md (claims verified)"]
      verification_status: "partial — cron exists but list API endpoint unconfirmed"
      evidence: "Cron polls GET /emails/receiving?limit=100 but Resend docs only confirm GET /emails/receiving/{id} (single fetch). List endpoint existence unverified. Integration checker flags this as BROKEN flow."
  integration:
    - from: "SKILL.md Section 6 (briefing)"
      to: "SKILL.md Section 9 (quota Check 0)"
      issue: "Counter double-increment — briefing Step 9 increments daily_send_count AND Check 0 also increments after send. Results in off-by-1 per briefing email."
    - from: "n8n POST Delivery Status node"
      to: "OpenClaw /hooks/agent"
      issue: "Hooks token hardcoded in n8n workflow node body instead of referencing $env.OPENCLAW_HOOKS_TOKEN. Token rotation requires updating both env var and Postgres node data."
  flows: []
tech_debt:
  - phase: 19-outbound-email-foundation
    items:
      - "4 human verification items pending (live briefing email, SPF/DKIM headers, visual rendering, alert soft cap)"
  - phase: 20-inbound-email-infrastructure
    items:
      - "3 human verification items pending (E2E pipeline confirmation, Svix rejection active, full body retrieval)"
      - "Caddy IP restriction uses static Resend IPs (may change)"
  - phase: 21-inbound-email-processing
    items:
      - "5 human verification items pending (allowlisted sender, unknown sender, reply threading, allowlist mgmt, delivery status)"
      - "Reply threading untested live"
      - "Delivery status webhook flow untested live"
  - phase: 22-domain-warmup-hardening
    items:
      - "3 human verification items pending (DNS dig, auth headers, morning briefing health section)"
      - "WARMUP.md Status: PENDING — 5-step checklist not yet started"
      - "DMARC at p=none (permissive) — manual escalation needed after 2-week monitoring"
---

# v2.2 Milestone Audit: Resend Email Integration

**Audited:** 2026-02-17
**Status:** tech_debt — all primary features operational, no critical blockers, accumulated items need review
**Score:** 21/22 features satisfied | 4/4 phases verified | 5/6 E2E flows complete

## Phase Verification Summary

| Phase | Status | Score | Gaps |
|-------|--------|-------|------|
| 19: Outbound Email Foundation | human_needed | 10/10 | 4 human verification items |
| 20: Inbound Email Infrastructure | human_needed | 12/13 | 1 human verification + 3 pending |
| 21: Inbound Email Processing | passed | 13/13 | 5 human verification items (expected for live E2E) |
| 22: Domain Warmup & Hardening | passed | 8/8 | 3 human verification items + catch-up API concern |
| **Total** | | **43/44** | **1 integration gap** |

## Features Coverage (from v2.2 ROADMAP)

| # | Feature | Phase | Status |
|---|---------|-------|--------|
| 1 | Send plain text + HTML email via Resend API | 19 | satisfied |
| 2 | Domain verification (SPF/DKIM/DMARC) | 19 | satisfied |
| 3 | API key management (sandbox env injection) | 19 | satisfied |
| 4 | Auto-Submitted header on all outbound | 19 | satisfied |
| 5 | Morning briefing delivery via email | 19 | satisfied |
| 6 | Alert/notification emails as Slack backup | 19 | satisfied |
| 7 | Inbound email receiving via subdomain MX | 20 | satisfied |
| 8 | Svix webhook signature verification | 20 | satisfied |
| 9 | Two-step email read (metadata + API fetch) | 20 | satisfied |
| 10 | Email-to-Slack bridging | 20 | satisfied |
| 11 | Gateway bind change for hooks endpoint | 20 | satisfied |
| 12 | Dedicated hooks token | 20 | satisfied |
| 13 | Auto-reply detection (RFC 3834) | 21 | satisfied |
| 14 | Rate limiting (1/sender/hour + 10/5min) | 21 | satisfied |
| 15 | Reply threading (In-Reply-To + References) | 21 | satisfied |
| 16 | Delivery status tracking via webhooks | 21 | satisfied |
| 17 | Sender allowlist / unknown sender handling | 21 | satisfied |
| 18 | Conversation history in SQLite | 21 | satisfied |
| 19 | 2-4 week warmup schedule | 22 | satisfied |
| 20 | Daily send quota tracking (80/95/100) | 22 | satisfied |
| 21 | Catch-up cron (webhook downtime fallback) | 22 | **partial** |
| 22 | Bounce/complaint rate monitoring | 22 | satisfied |

## Cross-Phase Integration

**27 cross-phase connections verified.** 0 orphaned exports. All 4 API endpoint surfaces have documented callers and auth protection.

### Wiring Status

| From → To | Status |
|-----------|--------|
| Phase 19 → Phase 20 | COMPLETE (API key, domain, hooks pattern) |
| Phase 19 → Phase 21 | COMPLETE (SKILL.md, config, template) — counter interaction risk |
| Phase 20 → Phase 21 | COMPLETE (n8n workflow, hooks endpoint, webhooks) |
| Phase 21 → Phase 22 | COMPLETE (email.db, delivery_status, SKILL.md) |

### E2E Flows

| Flow | Status |
|------|--------|
| Outbound email (Bob → Resend → inbox) | COMPLETE — test email eb5cedb5 delivered |
| Inbound email (sender → MX → Resend → n8n → Bob → Slack) | COMPLETE — E2E tested in Phase 20-02 |
| Reply threading (inbound → compose → threading headers → send → track) | COMPLETE — wired, live test pending |
| Morning briefing health metrics → threshold alerts | COMPLETE — awaits next 7 AM run |
| Quota enforcement (Check 0 before all outbound) | COMPLETE |
| Catch-up cron (poll API → dedup → recover) | **BROKEN** — list API endpoint unconfirmed |
| Delivery status webhook routing (Resend → n8n → Bob → DB update) | COMPLETE — wired, live test pending |

## Gap Details

### 1. Catch-up Cron API Endpoint (Partial Feature)

**Severity:** Moderate (fallback mechanism, not primary path)

The email-catchup cron calls `GET /emails/receiving?limit=100` to list recent received emails. However, Resend API docs only confirm `GET /emails/receiving/{id}` for fetching a single email by ID. The list endpoint's existence is unconfirmed.

**Impact:** If the endpoint doesn't exist, the catch-up cron silently fails every 30 minutes (silent delivery mode). Primary inbound path via Svix webhooks is unaffected. Svix provides 27.5-hour retry window, making this truly a secondary fallback.

**Fix:** Verify Resend API supports listing received emails. If not, explore alternatives (Resend batch endpoint, events API, or remove feature as Svix retries are sufficient).

### 2. Counter Double-Increment (Tech Debt)

**Severity:** Low

SKILL.md Section 6 Step 9 (briefing flow) and Section 9 Check 0 (quota enforcement) both increment `daily_send_count`. When briefing sends email, count increments twice.

**Impact:** daily_send_count drifts by +1 per briefing email. At current volume (1-2/day), this is harmless. Could trigger false 80/day warning ~40 days early at scale.

**Fix:** Remove Section 6 Step 9 increment and rely solely on Section 9 Check 0.

### 3. Hardcoded Hooks Token in n8n (Tech Debt)

**Severity:** Low

The POST Delivery Status n8n node has the hooks token hardcoded in its body rather than referencing `$env.OPENCLAW_HOOKS_TOKEN`. The inbound email path (node 6) correctly uses the env var.

**Impact:** Token rotation requires updating both n8n env AND the Postgres workflow node data.

**Fix:** Update delivery status node to reference `$env.OPENCLAW_HOOKS_TOKEN`.

## Human Verification Backlog

15 items across 4 phases, all expected for remote infrastructure work:

**Phase 19 (4 items):** Live briefing email delivery, SPF/DKIM headers in Gmail, visual rendering across clients, alert soft cap at 5/day

**Phase 20 (3 items):** E2E inbound pipeline live confirmation, Svix rejection still active, full body retrieval on demand

**Phase 21 (5 items):** Allowlisted sender notification, unknown sender handling, reply thread grouping in Gmail, allowlist Slack commands, delivery status DB update

**Phase 22 (3 items):** DNS record dig verification, email auth headers check, morning briefing health section output

## Tech Debt Summary

| Category | Count | Priority |
|----------|-------|----------|
| Human verification items | 15 | Normal (expected for infra work) |
| Catch-up cron API gap | 1 | Medium (verify endpoint exists) |
| Counter double-increment | 1 | Low (harmless at current volume) |
| Hardcoded token in n8n | 1 | Low (maintenance concern) |
| WARMUP.md not started | 1 | Normal (time-based, starts after ship) |
| DMARC at p=none | 1 | Normal (escalate after 2-week monitoring) |
| **Total items** | **20** | |

## Conclusion

v2.2 Resend Email Integration milestone achieves its core intent: **Bob can send, receive, and reply to email autonomously via Resend with a verified subdomain.** All 4 phases passed verification. 21 of 22 features are satisfied. The single partial feature (catch-up cron) is a secondary fallback — the primary inbound pipeline via Svix webhooks works correctly.

The milestone is ready for completion with the understanding that:
1. The catch-up cron API endpoint should be verified (and fixed if needed) as a post-ship backlog item
2. The 15 human verification items represent expected live-system testing that should happen during the warmup period
3. Two minor tech debt items (counter double-increment, hardcoded token) should be fixed when next touching SKILL.md or n8n workflow

---
*Audited: 2026-02-17T21:00:00Z*
*Auditor: Claude (gsd-audit-milestone)*
