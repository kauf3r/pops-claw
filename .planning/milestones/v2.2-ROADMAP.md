# Roadmap: Resend Email Integration

## Overview

| Phases | Features | Target |
|--------|----------|--------|
| 5 | 22 | Bob sends/receives email via Resend API |

## Phases

### Phase 19: Outbound Email Foundation

**Goal:** Bob sends email via custom skill + Resend REST API (curl from sandbox)

**Features:**
- Send plain text + HTML email via Resend API
- Domain verification (SPF/DKIM/DMARC on subdomain)
- API key management (sandbox env injection)
- `Auto-Submitted: auto-generated` header on all outbound
- Morning briefing delivery via email (reuse existing content)
- Alert/notification emails as Slack backup channel

**Plans:** ~2 plans
- Resend account + domain DNS + API key in openclaw.json sandbox env
- resend-email SKILL.md + briefing email cron + test sends

**Success Criteria:**
1. Resend domain verified (SPF/DKIM pass on test email)
2. Bob sends test email via skill from Slack command
3. Morning briefing delivered to email
4. `Auto-Submitted` header present on all outbound

**Deliverables:**
- `~/.openclaw/skills/resend-email/SKILL.md`
- `RESEND_API_KEY` in `.env` + `openclaw.json` sandbox env
- DNS records (TXT for SPF/DKIM, CNAME for DKIM key)
- Briefing email cron job

**Research:** None needed — same pattern as Oura/Govee/receipt-scanner

---

### Phase 20: Inbound Email Infrastructure

**Goal:** Emails to `bob@subdomain` trigger webhook -> n8n relay -> OpenClaw hook -> Bob notified

**Features:**
- Inbound email receiving via subdomain MX record
- Svix webhook signature verification in n8n
- Two-step email read (webhook metadata -> API fetch body)
- Email-to-Slack bridging (notify Andy of inbound)
- Gateway bind change (loopback -> tailscale for hooks endpoint)
- Dedicated hooks token (separate from gateway auth)

**Plans:** ~2 plans
- OpenClaw hooks config + gateway bind change + Caddy route on VPS
- n8n webhook workflow (trigger -> verify Svix -> fetch body -> forward to hooks)

**Success Criteria:**
1. Email to `bob@subdomain` triggers n8n webhook
2. n8n verifies Svix signature (rejects forged payloads)
3. n8n fetches full email body via Received Emails API
4. OpenClaw hook wakes Bob with email content
5. Bob notifies Andy in Slack with email summary

**Deliverables:**
- MX record on receiving subdomain
- n8n "Resend Inbound Email Relay" workflow
- Caddy route for `/webhooks/resend` on VPS
- Updated `openclaw.json` (hooks config, bind: tailscale)
- `RESEND_WEBHOOK_SECRET` in n8n credentials

**Research:** LIGHT — verify hooks config format, `bind: "tailscale"` syntax, n8n Svix verification Code node

**Depends on:** Phase 19 (Resend account + domain must exist)

---

### Phase 21: Inbound Email Processing

**Goal:** Bob intelligently processes inbound: filters auto-replies, replies with threading, tracks conversations

**Features:**
- Auto-reply detection (RFC 3834 headers + vendor X-headers)
- Rate limiting (max 1 reply per sender per hour, hard cap 10/5min)
- Reply threading (In-Reply-To + References headers)
- Delivery status tracking via webhook events
- Sender allowlist / unknown sender handling
- Conversation history in SQLite
- Scheduled email sends (Resend `scheduled_at`)

**Plans:** ~2 plans
- Auto-reply filter + rate limiter + sender allowlist logic in skill
- Reply threading + conversation DB + delivery status webhooks

**Success Criteria:**
1. Auto-reply emails (OOF, noreply) silently dropped
2. Rate limiter prevents >1 reply/sender/hour
3. Hard cap halts sending if >10 in 5 min
4. Replies appear in same thread in Gmail/Outlook
5. Conversation history queryable from SQLite

**Deliverables:**
- Updated `resend-email/SKILL.md` with reply/threading protocols
- SQLite `email_conversations` table
- Delivery status webhook events in n8n workflow
- Sender allowlist in workspace config

**Research:** MEDIUM — comprehensive auto-reply header list, loop simulation testing strategy

**Depends on:** Phase 20 (inbound receiving must work)

---

### Phase 22: Domain Warmup & Production Hardening

**Goal:** Domain reputation established, monitoring active, fallback for webhook downtime

**Features:**
- 2-4 week gradual warmup schedule
- Daily send quota tracking (stay under 100/day free tier)
- Catch-up cron polling Received Emails API (webhook downtime fallback)
- Bounce/complaint rate monitoring

**Plans:** ~1 plan
- Warmup schedule + quota tracking + catch-up cron + monitoring alerts

**Success Criteria:**
1. Test emails reach Gmail/Outlook inbox (not spam)
2. Daily send count tracked, alert at 90/day
3. Catch-up cron detects missed webhooks within 1 hour
4. Bounce rate <2%, complaint rate <0.08%

**Deliverables:**
- Quota tracking in email skill
- Catch-up cron job (poll Received Emails API)
- WARMUP.md schedule doc in workspace

**Research:** None — Resend docs provide warmup schedule

**Depends on:** Phase 19 (start warmup after first send)
**Parallel with:** Phases 20-21 (warmup is time-based, runs alongside infra work)

---

## Dependencies

```
Phase 19 (Outbound Foundation)
    |
    +-----> Phase 20 (Inbound Infrastructure)
    |           |
    |           +-----> Phase 21 (Inbound Processing)
    |
    +-----> Phase 22 (Domain Warmup) [parallel with 20-21]
```

Phase 19 is the only blocker. Phases 20-21 are sequential (infra before intelligence). Phase 22 starts after 19 and runs in parallel with 20-21 (time-based warmup, not blocking).

## Key Decisions (from Research)

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Integration pattern | Custom SKILL.md + curl | OpenClaw ignores mcpServers; matches Oura/Govee pattern |
| Inbound routing | n8n on VPS as webhook relay | EC2 has no public IP; VPS already has Caddy HTTPS |
| Receiving domain | Subdomain (not root) | Protect existing email MX records |
| Gateway bind | Change loopback -> tailscale | Enable hooks endpoint over Tailscale; only 2 nodes on network |
| API key scope | sending_access in sandbox, full_access in n8n | Limits blast radius if sandbox key leaks |
| Email body fetch | Agent fetches via API (not n8n relay) | Webhook is metadata-only; avoid large payloads through n8n |

## Risk Register

| Risk | Likelihood | Impact | Mitigation |
|------|-----------|--------|------------|
| Email loop from auto-replies | MEDIUM | HIGH (burns daily quota) | Header checking + rate limiting + hard cap |
| MX record misconfiguration | LOW | HIGH (breaks existing email) | Subdomain only, verify with dig before/after |
| Gateway bind change breaks Slack | LOW | HIGH | Slack uses Socket Mode (outbound), not affected |
| n8n downtime loses inbound | LOW | MEDIUM | Catch-up cron polls API; Svix retries 27.5hr |
| Domain in spam (no warmup) | MEDIUM | MEDIUM | 2-4 week gradual warmup, own addresses only |
| Read-only sandbox blocks npx | N/A | N/A | Using curl, not npx/MCP |

### Phase 23: Email Integration Gap Closure

**Goal:** Close 3 gaps from milestone audit — verify catch-up cron API, fix counter double-increment, fix hardcoded n8n token

**Gap Closure:** From v2.2-MILESTONE-AUDIT.md

**Features:**
- Verify/fix catch-up cron Resend list received emails API endpoint
- Fix SKILL.md counter double-increment (Section 6 Step 9 vs Section 9 Check 0)
- Fix n8n delivery status node hardcoded hooks token → use $env.OPENCLAW_HOOKS_TOKEN

**Plans:** 1 plan (3 independent small fixes, same subsystem)

**Success Criteria:**
1. Catch-up cron API call confirmed working (or replaced with valid endpoint)
2. daily_send_count increments exactly once per outbound email
3. n8n delivery status node uses env var for hooks token (not inline value)

**Deliverables:**
- Updated catch-up cron in jobs.json (if API endpoint change needed)
- Updated SKILL.md Section 6 (remove duplicate increment)
- Updated n8n workflow delivery status node (env var reference)

**Research:** LIGHT — confirm Resend list received emails API endpoint

**Depends on:** Phases 19-22 (all complete)

---

## Updated Dependencies

```
Phase 19 (Outbound Foundation)
    |
    +-----> Phase 20 (Inbound Infrastructure)
    |           |
    |           +-----> Phase 21 (Inbound Processing)
    |
    +-----> Phase 22 (Domain Warmup) [parallel with 20-21]
    |
    +-----> Phase 23 (Gap Closure) [after all phases complete]
```

---
*Updated: 2026-02-17 -- Phase 23 added (gap closure from milestone audit)*
