---
phase: 09-proactive-agent-patterns
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/.openclaw/cron/jobs.json
  - /home/ubuntu/clawd/agents/main/ANOMALY_ALERTS.md
autonomous: true

must_haves:
  truths:
    - "A cron job periodically checks health metrics for anomalous deviations"
    - "Alerts fire to Slack when health metrics deviate beyond thresholds (sleep score, readiness, HRV)"
    - "Govee temperature thresholds are defined and checked when sensor data is available"
  artifacts:
    - path: "/home/ubuntu/clawd/agents/main/ANOMALY_ALERTS.md"
      provides: "Reference doc with health metric thresholds, Govee thresholds, and alert logic"
    - path: "/home/ubuntu/.openclaw/cron/jobs.json"
      provides: "anomaly-check cron entry running twice daily"
  key_links:
    - from: "cron/jobs.json (anomaly-check)"
      to: "ANOMALY_ALERTS.md"
      via: "systemEvent text references ANOMALY_ALERTS.md for full instructions"
    - from: "ANOMALY_ALERTS.md"
      to: "health.db"
      via: "SQL queries against health_snapshots table for trend comparison"
    - from: "ANOMALY_ALERTS.md"
      to: "Slack DM D0AARQR0Y4V"
      via: "Agent sends anomaly alerts via Slack when thresholds exceeded"
---

<objective>
Create an anomaly detection system that monitors health metrics (Oura) and environmental data (Govee) for deviations, alerting via Slack when thresholds are exceeded.

Purpose: Bob detects and surfaces health and environment anomalies before they become problems -- poor sleep trends, unusual HRV changes, or Govee temperature drops.
Output: anomaly-check cron job + ANOMALY_ALERTS.md reference doc on EC2
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-oura-ring-integration/02-01-SUMMARY.md
@.planning/phases/05-govee-wyze-integrations/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ANOMALY_ALERTS.md reference doc with health and environment thresholds</name>
  <files>/home/ubuntu/clawd/agents/main/ANOMALY_ALERTS.md</files>
  <action>
SSH to EC2 (100.72.143.9) and create ~/clawd/agents/main/ANOMALY_ALERTS.md with these sections:

## 1. Health Metric Thresholds (Oura)

Query health.db for recent data. Use HOST path: `/home/ubuntu/clawd/agents/main/health.db`

**Absolute thresholds** (alert if any single day hits these):
- Sleep score < 60 (poor sleep)
- Readiness score < 60 (poor recovery)
- Resting HR > 75 bpm (elevated resting heart rate)
- HRV < 15 ms (very low heart rate variability)

**Trend thresholds** (alert if 3-day moving average deviates from 7-day average):
- Sleep score drops > 15 points vs 7-day average
- Readiness drops > 15 points vs 7-day average
- HRV drops > 20% vs 7-day average
- Resting HR increases > 10 bpm vs 7-day average

SQL queries to use:

```sql
-- Latest snapshot
SELECT date, sleep_score, readiness_score, hrv_average, resting_hr
FROM health_snapshots ORDER BY date DESC LIMIT 1;

-- 3-day average
SELECT AVG(sleep_score) as avg_sleep, AVG(readiness_score) as avg_readiness,
       AVG(hrv_average) as avg_hrv, AVG(resting_hr) as avg_hr
FROM health_snapshots ORDER BY date DESC LIMIT 3;

-- 7-day average (baseline)
SELECT AVG(sleep_score) as avg_sleep, AVG(readiness_score) as avg_readiness,
       AVG(hrv_average) as avg_hrv, AVG(resting_hr) as avg_hr
FROM health_snapshots ORDER BY date DESC LIMIT 7;
```

## 2. Environment Thresholds (Govee)

Query health.db for Govee sensor data (govee_readings table). Note: currently no sensors are bound to the account -- all 11 devices are lights. When sensors are added, these thresholds apply:

- Temperature < 60F or > 85F (out of comfort range)
- Humidity < 30% or > 60% (out of comfort range)
- Temperature drop > 10F in 1 hour (rapid change, possible HVAC issue)

```sql
-- Latest Govee readings (when sensors exist)
SELECT device_name, temperature_f, humidity, recorded_at
FROM govee_readings ORDER BY recorded_at DESC LIMIT 10;

-- Rapid temp change detection
SELECT device_name, temperature_f, recorded_at,
       LAG(temperature_f) OVER (PARTITION BY device_name ORDER BY recorded_at) as prev_temp
FROM govee_readings
WHERE recorded_at > datetime('now', '-2 hours')
ORDER BY recorded_at DESC;
```

If govee_readings table is empty or has no recent data, skip Govee checks silently.

## 3. Alert Logic

1. Run health metric queries
2. Compare against absolute thresholds first
3. If absolute thresholds OK, check trend thresholds (3-day vs 7-day)
4. Run Govee queries if sensor data exists
5. If NO anomalies detected, respond "No anomalies detected." and STOP (no Slack message)
6. If anomalies found, compose alert message

## 4. Slack Delivery

Send anomaly alerts to Andy's Slack DM (D0AARQR0Y4V):
- Subject line: "Health/Environment Alert"
- List each anomaly with current value, threshold, and trend context
- Include a brief recommendation (e.g., "Consider prioritizing sleep tonight" or "Check thermostat")
- Keep it actionable -- 2-3 sentences per anomaly, not a data dump

IMPORTANT: This runs in embedded mode (cron). Use HOST paths:
- health.db: /home/ubuntu/clawd/agents/main/health.db
- sqlite3: /usr/bin/sqlite3
- Slack: Use built-in Slack messaging

Do NOT use /workspace/ paths.
  </action>
  <verify>SSH to EC2 and confirm: `ls -la ~/clawd/agents/main/ANOMALY_ALERTS.md` and `wc -l ~/clawd/agents/main/ANOMALY_ALERTS.md` shows 80+ lines with all 4 sections</verify>
  <done>ANOMALY_ALERTS.md deployed with Oura health thresholds (absolute + trend), Govee environment thresholds, alert logic, and Slack delivery instructions</done>
</task>

<task type="auto">
  <name>Task 2: Create anomaly-check cron job running twice daily</name>
  <files>/home/ubuntu/.openclaw/cron/jobs.json</files>
  <action>
SSH to EC2 (100.72.143.9) and create the cron job:

```bash
/home/ubuntu/.npm-global/bin/openclaw cron add \
  --name "anomaly-check" \
  --schedule "0 14,22 * * *" \
  --agent main \
  --session main \
  --wake now \
  --system-event "Read /home/ubuntu/clawd/agents/main/ANOMALY_ALERTS.md and follow its instructions to check health metrics and environment data for anomalies."
```

Schedule rationale: 14:00 UTC (6 AM PT) catches overnight health data from Oura sync, 22:00 UTC (2 PM PT) catches midday check. Twice daily balances alerting speed against cost.

After creation, verify:
1. `openclaw cron list` shows anomaly-check with `0 14,22 * * *` schedule
2. Check jobs.json to confirm correct structure:
   - `wakeMode: "now"`
   - `payload.kind: "systemEvent"`
   - `schedule.expr: "0 14,22 * * *"`
   - `agentId: "main"`
  </action>
  <verify>SSH to EC2 and run `openclaw cron list | grep anomaly` to confirm job exists. Verify schedule with `cat ~/.openclaw/cron/jobs.json | python3 -c "import sys,json; jobs=json.load(sys.stdin); [print(j['name'], j['schedule']['expr']) for j in jobs if 'anomaly' in j['name']]"`</verify>
  <done>anomaly-check cron fires twice daily (6 AM PT, 2 PM PT), triggers Bob to check health + Govee metrics against thresholds and alert via Slack</done>
</task>

</tasks>

<verification>
1. `openclaw cron list` shows anomaly-check with `0 14,22 * * *` schedule
2. ANOMALY_ALERTS.md exists at ~/clawd/agents/main/ with 4 sections (thresholds, Govee, logic, delivery)
3. Cron entry has wakeMode=now and systemEvent payload referencing ANOMALY_ALERTS.md
4. Health thresholds defined for sleep (<60), readiness (<60), HRV (<15), resting HR (>75)
5. Trend detection compares 3-day vs 7-day averages
</verification>

<success_criteria>
- PP-02 satisfied: Anomaly alerts fire on health metric deviations (Oura) and Govee temp drops (when sensors available)
- Absolute thresholds catch single-day poor values
- Trend thresholds catch multi-day declining patterns
- Govee thresholds documented and ready for when sensors are bound
</success_criteria>

<output>
After completion, create `.planning/phases/09-proactive-agent-patterns/09-02-SUMMARY.md`
</output>
