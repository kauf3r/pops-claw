---
phase: 04-mcp-servers
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/.openclaw/openclaw.json
  - /home/ubuntu/clawd/agents/main/Dockerfile.sandbox (or setupCommand in config)
autonomous: false
user_setup:
  - service: github
    why: "GitHub CLI token for sandbox access"
    env_vars:
      - name: GITHUB_TOKEN
        source: "gh auth token on EC2 host (already authenticated) or GitHub Settings -> Developer settings -> Personal access tokens"

must_haves:
  truths:
    - "Bob can run gh commands from sandbox (list repos, PRs)"
    - "Bob can run sqlite3 queries from sandbox"
    - "Bob can search the web via web_search tool"
    - "Bob can read/write EC2 files via built-in filesystem tools"
  artifacts:
    - path: "/home/ubuntu/.openclaw/openclaw.json"
      provides: "Sandbox env with GITHUB_TOKEN, setupCommand for gh+sqlite3, elevated exec config"
      contains: "GITHUB_TOKEN"
  key_links:
    - from: "sandbox setupCommand"
      to: "gh binary in container"
      via: "apt-get install gh inside sandbox on creation"
      pattern: "setupCommand.*gh"
    - from: "GITHUB_TOKEN env"
      to: "gh auth inside sandbox"
      via: "sandbox.docker.env injection"
      pattern: "GITHUB_TOKEN"
---

<objective>
Install GitHub CLI and SQLite3 into the Docker sandbox so Bob can use them, inject GitHub auth token, and enable elevated exec as a host-tool fallback.

Purpose: Bob runs in a Docker sandbox where `gh` and `sqlite3` are missing. The GitHub skill shows "ready" because it checks binaries on the HOST, but Bob can't actually use them. Brave Search and filesystem tools are already working via OpenClaw built-in tools (tools.web.search and read/write/edit/exec). This plan closes the sandbox tooling gap.

Output: Bob can run `gh` and `sqlite3` from sandbox, web search works, filesystem access works.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

SSH access: `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9`
Binary: `/home/ubuntu/.npm-global/bin/openclaw`
Config: `~/.openclaw/openclaw.json`
Current OpenClaw version: v2026.2.6-3
Sandbox image: `clawdbot-sandbox:with-browser`
Sandbox mode: `all` (every session sandboxed)
Sandbox scope: `session` (per session container)
Workspace: `/home/ubuntu/clawd/agents/main` -> `/workspace/` in sandbox

CRITICAL CONTEXT — OpenClaw does NOT use mcp_config.json or @modelcontextprotocol MCP servers:
- Brave Search: configured via `tools.web.search` in openclaw.json (ALREADY DONE, key in .env on EC2)
- Filesystem: built-in `read`, `write`, `edit`, `exec` tools with workspace rw mount (ALREADY DONE)
- GitHub: bundled `github` skill wrapping `gh` CLI — binary missing from sandbox
- SQLite: agent uses `exec` to run `sqlite3` — binary missing from sandbox
- `gh` is installed on host at `/usr/bin/gh`, authenticated as kauf3r (gho_**** token with repo/workflow/gist/read:org scopes)
- `sqlite3` is installed on host at `/usr/bin/sqlite3`
- `npx` IS available in sandbox

Sandbox env injection pattern (from Phase 2): API tokens go in openclaw.json `agents.defaults.sandbox.docker.env`
Elevated exec: can run commands on host from sandbox — needs `tools.elevated.enabled` in config
setupCommand: runs once after container creation, can install packages
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install gh and sqlite3 in sandbox and inject GitHub auth</name>
  <files>
    /home/ubuntu/.openclaw/openclaw.json
  </files>
  <action>
    SSH to EC2 and make the following changes to `~/.openclaw/openclaw.json`:

    **Step 1: Get the GitHub token from host `gh` CLI:**
    ```
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'gh auth token'
    ```
    Save this token value.

    **Step 2: Add GITHUB_TOKEN to sandbox docker env:**
    Add `"GITHUB_TOKEN": "<token-from-step-1>"` to `agents.defaults.sandbox.docker.env` in openclaw.json (alongside existing OURA_ACCESS_TOKEN etc).

    **Step 3: Add setupCommand to install gh and sqlite3 in sandbox:**
    Add `"setupCommand"` to `agents.defaults.sandbox.docker` in openclaw.json. This command runs once when the container is created.

    The setupCommand should install both `gh` and `sqlite3`:
    ```
    "setupCommand": "apt-get update && apt-get install -y --no-install-recommends gh sqlite3 && rm -rf /var/lib/apt/lists/*"
    ```

    NOTE: `gh` may not be in default Ubuntu repos. If `apt-get install gh` fails, use the GitHub CLI official method:
    ```
    "setupCommand": "apt-get update && apt-get install -y --no-install-recommends sqlite3 curl && curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg && echo 'deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main' | tee /etc/apt/sources.list.d/github-cli.list > /dev/null && apt-get update && apt-get install -y --no-install-recommends gh && rm -rf /var/lib/apt/lists/*"
    ```

    IMPORTANT: setupCommand requires network egress, writable root FS, and root user in sandbox. Check if the sandbox user is 1000:1000 (it is per current config) — setupCommand typically runs as root before user switch. Test by restarting gateway and starting a new session.

    **Step 4: Enable elevated exec as fallback:**
    Add to openclaw.json:
    ```json
    "tools": {
      "elevated": {
        "enabled": true,
        "allowFrom": {
          "slack": ["U0CUJ5CAF"]
        }
      }
    }
    ```
    This allows Bob to run commands on the host when elevated mode is enabled, providing a fallback if setupCommand doesn't work perfectly. `U0CUJ5CAF` is Andy's Slack user ID (already in dm.allowFrom).

    **Step 5: Also bind-mount gh config for auth persistence (belt + suspenders):**
    Add to `agents.defaults.sandbox.docker.binds`:
    ```
    "/home/ubuntu/.config/gh:/home/node/.config/gh:ro"
    ```
    This gives the sandbox read-only access to the host's gh auth config, so `gh` works even without GITHUB_TOKEN env var.

    **Step 6: Restart gateway:**
    ```
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'systemctl --user restart openclaw-gateway.service'
    ```
    Wait 5 seconds, verify active:
    ```
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'systemctl --user status openclaw-gateway.service'
    ```

    **Step 7: Add GITHUB_TOKEN to ~/.openclaw/.env for gateway process:**
    ```
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'echo "GITHUB_TOKEN=$(gh auth token)" | tee -a ~/.openclaw/.env'
    ```

    **Step 8: Verify web_search is enabled:**
    Confirm `tools.web.search.enabled` is not explicitly set to false (it defaults to enabled). Current config has `tools.web.search.provider: "brave"` with API key — this is already working.

    **Step 9: Verify web_fetch is enabled:**
    Confirm `tools.web.fetch.enabled` is not explicitly set to false (defaults to enabled). No action needed unless disabled.
  </action>
  <verify>
    1. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'systemctl --user status openclaw-gateway.service'` shows active (running)
    2. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'grep GITHUB_TOKEN ~/.openclaw/.env'` shows token
    3. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'jq ".agents.defaults.sandbox.docker.env.GITHUB_TOKEN" ~/.openclaw/openclaw.json'` shows token
    4. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'jq ".agents.defaults.sandbox.docker.setupCommand" ~/.openclaw/openclaw.json'` shows install command
    5. `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'jq ".tools.elevated.enabled" ~/.openclaw/openclaw.json'` shows true
  </verify>
  <done>
    openclaw.json updated with: GITHUB_TOKEN in sandbox env, setupCommand to install gh+sqlite3, elevated exec enabled, gh config bind-mounted. Gateway restarted and healthy. GITHUB_TOKEN in .env.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Bob can use GitHub, SQLite, web search, and filesystem from Slack</name>
  <files>/home/ubuntu/.openclaw/openclaw.json</files>
  <action>
    Human verification of all 4 tool capabilities from Bob's sandbox. Open a NEW Slack DM with Bob (gateway restart clears sessions).

    Test each capability:

    1. **GitHub (MC-01):** Ask Bob: "List my GitHub repos using gh repo list"
       - Expected: Bob runs `gh repo list` and shows repos for kauf3r
       - If setupCommand failed, try: "Use elevated mode and run gh repo list"

    2. **SQLite (MC-02):** Ask Bob: "Query the health database: sqlite3 /workspace/health.db 'SELECT * FROM health_snapshots ORDER BY snapshot_date DESC LIMIT 3'"
       - Expected: Bob runs sqlite3 and shows recent health snapshots

    3. **Web Search (MC-03):** Ask Bob: "Search the web for 'OpenClaw MCP servers 2026'"
       - Expected: Bob uses web_search tool and returns Brave Search results

    4. **Filesystem (MC-04):** Ask Bob: "List the files in your workspace directory"
       - Expected: Bob runs ls or uses read tool to show /workspace/ contents

    5. **GitHub PR listing (success criteria):** Ask Bob: "Show me open PRs on one of my repos using gh pr list"
       - Expected: Bob lists PRs (or shows none if no open PRs)

    If any fail, check gateway logs:
    `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'journalctl --user -u openclaw-gateway.service --since "5 minutes ago" --no-pager'`
  </action>
  <verify>All 5 test commands produce expected results from Bob's sandbox via Slack.</verify>
  <done>Bob can list GitHub repos/PRs, query SQLite databases, search the web, and read/write files — all from within the Docker sandbox.</done>
</task>

</tasks>

<verification>
1. `gh repo list` works from Bob's sandbox (or via elevated exec)
2. `sqlite3 /workspace/health.db 'SELECT count(*) FROM health_snapshots'` returns a count
3. Bob can use web_search tool (already working, just confirm)
4. Bob can read/write workspace files (already working, just confirm)
5. Gateway healthy after config changes
</verification>

<success_criteria>
- GitHub CLI operational from sandbox (can list repos, PRs) — MC-01
- SQLite CLI operational from sandbox (can query databases) — MC-02
- Brave Search operational via built-in web_search tool — MC-03 (already done, verified)
- Filesystem operational via built-in tools (read/write/edit/exec) — MC-04 (already done, verified)
- GITHUB_TOKEN in sandbox env and .env — MC-06
- All tools configured in openclaw.json (OpenClaw's native config, not mcp_config.json) — MC-05 adapted
</success_criteria>

<output>
After completion, create `.planning/phases/04-mcp-servers/04-01-SUMMARY.md`
</output>
