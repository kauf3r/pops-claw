---
phase: 31-agent-board
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queries/agents.ts
  - src/lib/utils.ts
  - src/app/api/agents/route.ts
  - src/components/NavBar.tsx
autonomous: true
requirements: [AGNT-01, AGNT-02, AGNT-03, AGNT-04]

must_haves:
  truths:
    - "GET /api/agents returns JSON with 7 agent objects each having status, lastSeen, tokens24h, and errors24h"
    - "Agent status uses 5-min/30-min thresholds (not Phase 30's 1-hour threshold)"
    - "Token counts use input_tokens + output_tokens only (not cache tokens)"
    - "Main agent queries both 'main' and 'bob' agent_ids in coordination.db"
    - "NavBar shows Agents link between Dashboard and Calendar"
  artifacts:
    - path: "src/lib/queries/agents.ts"
      provides: "getAgentBoardData() returning AgentBoardSummary"
      contains: "getAgentBoardData"
    - path: "src/lib/utils.ts"
      provides: "formatTokens, MODEL_LABELS, formatModelBreakdown utilities"
      contains: "formatTokens"
    - path: "src/app/api/agents/route.ts"
      provides: "GET handler for /api/agents"
      contains: "getAgentBoardData"
    - path: "src/components/NavBar.tsx"
      provides: "Updated navigation with Agents link"
      contains: "agents"
  key_links:
    - from: "src/app/api/agents/route.ts"
      to: "src/lib/queries/agents.ts"
      via: "import getAgentBoardData"
      pattern: "getAgentBoardData"
    - from: "src/lib/queries/agents.ts"
      to: "observability.db"
      via: "getDb('observability') querying llm_calls and agent_runs"
      pattern: "getDb.*observability"
    - from: "src/lib/queries/agents.ts"
      to: "coordination.db"
      via: "getDb('coordination') querying agent_activity"
      pattern: "getDb.*coordination"
---

<objective>
Build the agent board data layer: query module for per-agent heartbeat/token/error data, API route, and NavBar link.

Purpose: Provide the backend foundation for the /agents page -- all data fetching, status computation, and token aggregation happens server-side in the API route.
Output: Working /api/agents endpoint returning 7 agents with status, tokens, errors; NavBar updated with Agents link.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31-agent-board/31-CONTEXT.md
@.planning/phases/31-agent-board/31-RESEARCH.md
@.planning/phases/30-dashboard-metrics/30-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create agent board query module and token formatting utilities</name>
  <files>
    src/lib/queries/agents.ts
    src/lib/utils.ts
  </files>
  <action>
**In src/lib/utils.ts** -- ADD these exports (do not remove existing content):

1. `formatTokens(n: number): string` -- formats numbers as "12.4k", "1.2M", or raw number if under 1000
2. `MODEL_LABELS: Record<string, string>` -- maps model IDs to single-letter labels: "claude-haiku-4-5" -> "H", "claude-sonnet-4-5" -> "S", "claude-opus-4" -> "O"
3. `formatModelBreakdown(byModel: Record<string, number>): string` -- produces "H: 8k . S: 3k . O: 1.4k" format, sorted highest-first, using MODEL_LABELS and formatTokens. Use ` \u00b7 ` (middle dot with spaces) as separator.

**In src/lib/queries/agents.ts** -- ADD `getAgentBoardData()` function alongside existing `getAgentHealth()`. Do NOT modify `getAgentHealth()` (Phase 30 dashboard depends on it).

Export types:
```typescript
interface AgentTokens { total: number; byModel: Record<string, number>; }
interface AgentBoardData {
  id: string; name: string; system: string;
  lastSeen: string | null; status: "active" | "stale" | "down";
  tokens24h: AgentTokens; errors24h: number;
}
interface AgentBoardSummary {
  agents: AgentBoardData[]; summary: { active: number; stale: number; down: number };
}
```

Implementation details for `getAgentBoardData()`:
- Import `AGENTS` from constants.ts, `getDb` from db.ts
- For each agent in AGENTS array, query:
  1. **Last seen** from BOTH coordination.db (`agent_activity`) and observability.db (`agent_runs`), take the most recent. For main agent, query agent_id IN ('main', 'bob') in coordination.db.
  2. **Status** using 5-min/30-min thresholds: active < 5min, stale 5-30min, down > 30min or never seen.
  3. **24h tokens** from observability.db `llm_calls`: `SELECT model, sum(input_tokens + output_tokens) as tokens FROM llm_calls WHERE agent_id = ? AND created_at > datetime('now', '-24 hours') GROUP BY model`. Use input+output ONLY (not cache tokens per research recommendation).
  4. **24h errors** from observability.db `agent_runs`: `SELECT count(*) as cnt FROM agent_runs WHERE agent_id = ? AND success = 0 AND created_at > datetime('now', '-24 hours')`
- Wrap all DB calls in try/catch (tables may not exist). Return zero/empty defaults on error.
- Sort result: Down first (0), Stale (1), Active (2), then alphabetical within group.
- Compute summary counts from the sorted array.
- Use `system` field to show the agent's system name (the id field from AGENTS -- e.g., "main", "landos", "ops").

IMPORTANT: The `getDb()` call may return null if the database file doesn't exist. Guard all `.prepare()` calls with null checks.
  </action>
  <verify>
SSH to EC2 (100.72.143.9), cd to ~/clawd/mission-control/, run `npx tsc --noEmit` to confirm no TypeScript errors. Then test the query by temporarily importing and calling it, or verify the build compiles cleanly.
  </verify>
  <done>
agents.ts exports getAgentBoardData() returning AgentBoardSummary with 7 agents. utils.ts exports formatTokens, MODEL_LABELS, formatModelBreakdown. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create /api/agents route and add Agents link to NavBar</name>
  <files>
    src/app/api/agents/route.ts
    src/components/NavBar.tsx
  </files>
  <action>
**Create src/app/api/agents/route.ts:**
- Follow the exact pattern from Phase 30 API routes (force-dynamic, try/catch, typed fallback)
- Import `getAgentBoardData` from `@/lib/queries/agents`
- Export `dynamic = "force-dynamic"`
- Export GET handler that calls `getAgentBoardData()` and returns `NextResponse.json(result)`
- On error, return `{ agents: [], summary: { active: 0, stale: 0, down: 0 }, error: String(error) }` with status 500

**Modify src/components/NavBar.tsx:**
- Find the `links` array (currently has Dashboard and Calendar entries)
- Add `{ href: "/agents", label: "Agents" }` between Dashboard and Calendar
- Do not change anything else in NavBar
  </action>
  <verify>
SSH to EC2, restart the dev server if needed, then run:
`curl -s http://localhost:3001/api/agents | python3 -m json.tool`
Confirm response has `agents` array with 7 entries, each having `id`, `name`, `system`, `lastSeen`, `status`, `tokens24h`, `errors24h`. Confirm `summary` object has active/stale/down counts. Also verify the NavBar renders "Agents" link by checking the source or visiting the page.
  </verify>
  <done>
/api/agents returns 7 agents with correct status/token/error data. NavBar shows Dashboard | Agents | Calendar links.
  </done>
</task>

</tasks>

<verification>
1. `curl http://100.72.143.9:3001/api/agents` returns valid JSON with 7 agents
2. Each agent has status (active/stale/down), lastSeen, tokens24h.total, tokens24h.byModel, errors24h
3. Main agent includes data from both "main" and "bob" agent_ids
4. Token totals are input+output only (should be in hundreds of thousands range, not millions)
5. NavBar on any page shows "Agents" link
</verification>

<success_criteria>
- API endpoint returns correctly shaped data for all 7 agents
- Status thresholds are 5-min/30-min (not Phase 30's 1-hour)
- Token formatting utilities are exported and working
- NavBar includes Agents navigation link
</success_criteria>

<output>
After completion, create `.planning/phases/31-agent-board/31-01-SUMMARY.md`
</output>
