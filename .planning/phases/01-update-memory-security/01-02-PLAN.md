---
phase: 01-update-memory-security
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - /home/ubuntu/.openclaw/openclaw.json
autonomous: false

must_haves:
  truths:
    - "Memory backend is sqlite-hybrid in openclaw.json"
    - "Memory system is operational after gateway restart"
    - "~/clawd/agents/main/memory/ exists and is recognized as markdown source"
    - "discovery.wideArea.enabled is false"
    - "session.dmScope is explicitly set"
    - "Gateway auth token has been rotated"
    - "Gmail OAuth scopes reviewed and documented"
  artifacts:
    - path: "/home/ubuntu/.openclaw/openclaw.json"
      provides: "Updated config with memory + security settings"
      contains: "sqlite-hybrid"
  key_links:
    - from: "/home/ubuntu/.openclaw/openclaw.json"
      to: "gateway service"
      via: "service restart reads new config"
      pattern: "memory.*sqlite-hybrid"
---

<objective>
Configure SQLite hybrid memory backend and apply security hardening to openclaw.json, then verify all settings are active.

Purpose: Memory enables Bob to recall context across sessions. Security settings close discovery exposure, scope sessions, rotate credentials, and minimize OAuth surface.

Output: Updated openclaw.json with memory and security settings verified operational.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-update-memory-security/01-01-SUMMARY.md

SSH access: `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9`
Config: `~/.openclaw/openclaw.json`
Binary: `/home/ubuntu/.npm-global/bin/openclaw`
IMPORTANT: Use `tee` not heredocs over SSH (heredocs with leading spaces on EOF cause hangs).
Memory markdown source: ~/clawd/agents/main/memory/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure memory and security settings in openclaw.json</name>
  <files>/home/ubuntu/.openclaw/openclaw.json</files>
  <action>
    1. Back up current config:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.bak-$(date +%Y%m%d)'`

    2. Read current config:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cat ~/.openclaw/openclaw.json'`

    3. Apply memory settings — add or update these keys in the JSON:
       ```json
       {
         "memory": {
           "backend": "sqlite-hybrid",
           "vectorWeight": 0.7,
           "bm25Weight": 0.3,
           "markdownSource": "~/clawd/agents/main/memory/"
         }
       }
       ```
       Use `jq` to merge if available, otherwise use a Python one-liner or careful sed. Verify JSON is valid after edit.

    4. Apply security settings — add or update these keys:
       ```json
       {
         "discovery": {
           "wideArea": {
             "enabled": false
           }
         },
         "session": {
           "dmScope": "direct"
         }
       }
       ```

    5. Validate the JSON is well-formed:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'python3 -m json.tool ~/.openclaw/openclaw.json > /dev/null && echo "valid JSON" || echo "INVALID JSON"'`

    6. Ensure ~/clawd/agents/main/memory/ directory exists:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'mkdir -p ~/clawd/agents/main/memory/'`

    7. Restart gateway to pick up new config:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'systemctl --user restart openclaw-gateway.service && sleep 3 && systemctl --user status openclaw-gateway.service'`

    Do NOT use heredocs over SSH — they hang. Use `tee`, `jq`, or `python3 -c` for file edits.
  </action>
  <verify>
    - `cat ~/.openclaw/openclaw.json | python3 -m json.tool` succeeds (valid JSON)
    - Config contains `"backend": "sqlite-hybrid"`
    - Config contains `"wideArea": { "enabled": false }`
    - Config contains `"dmScope": "direct"`
    - Gateway is active (running) after restart
  </verify>
  <done>openclaw.json updated with memory.backend=sqlite-hybrid, discovery.wideArea.enabled=false, session.dmScope=direct. Gateway restarted and healthy.</done>
</task>

<task type="auto">
  <name>Task 2: Rotate gateway token and review Gmail OAuth scopes</name>
  <files>/home/ubuntu/.openclaw/openclaw.json</files>
  <action>
    1. Rotate gateway auth token:
       Check if openclaw has a token rotation command:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 '/home/ubuntu/.npm-global/bin/openclaw --help'`

       Look for `token`, `rotate`, `auth`, or `credentials` subcommands.

       If a rotate command exists (e.g., `openclaw token rotate`), use it.
       If not, generate a new token manually:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'python3 -c "import secrets; print(secrets.token_urlsafe(32))"'`
       Then update the token in openclaw.json (look for `gateway.token`, `auth.token`, or similar field).

    2. After token rotation, restart gateway:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'systemctl --user restart openclaw-gateway.service && sleep 3 && systemctl --user status openclaw-gateway.service'`

    3. Verify gateway still accessible with new token (check dashboard or health endpoint).

    4. Review Gmail OAuth scopes:
       Check current gog configuration:
       `ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cat ~/.openclaw/gog.json 2>/dev/null || cat ~/.config/gog/config.json 2>/dev/null || echo "gog config not found at expected paths"'`

       Look for OAuth scopes in the config. Document current scopes.
       Minimum required scopes for Gmail + Calendar:
       - `https://www.googleapis.com/auth/gmail.readonly` (read emails)
       - `https://www.googleapis.com/auth/gmail.send` (send emails)
       - `https://www.googleapis.com/auth/calendar.readonly` (read calendar)

       If current scopes exceed minimum, document the excess in progress.md.
       Scope reduction requires re-auth — do NOT re-auth here, just document findings.
       If scopes are already minimal, note that SE-04 is satisfied.

    5. Document all changes in progress.md (local repo, not on EC2).
  </action>
  <verify>
    - Gateway token has been changed (new value differs from backup config)
    - Gateway is running with new token
    - Gmail OAuth scopes documented
    - progress.md updated with findings
  </verify>
  <done>Gateway token rotated, gateway healthy with new token. Gmail OAuth scopes reviewed and documented — reduction plan noted if needed.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Memory system (sqlite-hybrid) configured and security hardening applied:
    - Memory backend set to sqlite-hybrid (70% vector + 30% BM25)
    - Discovery wide area disabled
    - Session dmScope set to direct
    - Gateway auth token rotated
    - Gmail OAuth scopes reviewed
  </what-built>
  <how-to-verify>
    1. Open gateway dashboard: `ssh -L 3000:localhost:18789 -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9` then visit `http://localhost:3000?token=<new-token>`
    2. Verify dashboard loads (confirms token rotation worked)
    3. Check memory section shows sqlite-hybrid backend
    4. Send a test message to Bob via Slack, confirm he responds (gateway operational)
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
1. `ssh ... 'cat ~/.openclaw/openclaw.json'` shows memory.backend = sqlite-hybrid
2. `ssh ... 'cat ~/.openclaw/openclaw.json'` shows discovery.wideArea.enabled = false
3. `ssh ... 'cat ~/.openclaw/openclaw.json'` shows session.dmScope = direct
4. Gateway token differs from pre-rotation backup
5. Gateway service active (running)
6. Gmail OAuth scopes documented
7. ~/clawd/agents/main/memory/ directory exists
</verification>

<success_criteria>
- Memory system configured with sqlite-hybrid backend
- Security settings applied (discovery off, dmScope set, token rotated)
- Gmail OAuth scopes reviewed and documented
- Gateway healthy with all new settings active
- User confirms dashboard access with new token
</success_criteria>

<output>
After completion, create `.planning/phases/01-update-memory-security/01-02-SUMMARY.md`
</output>
