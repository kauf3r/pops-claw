---
phase: 16-wordpress-publishing
plan: 02
type: execute
wave: 2
depends_on: ["16-01"]
files_modified:
  - "~/.openclaw/skills/wordpress-publisher/SKILL.md (EC2)"
  - "~/clawd/agents/ezra/PUBLISH_SESSION.md (EC2)"
  - "~/.openclaw/cron/jobs.json (EC2)"
autonomous: true

must_haves:
  truths:
    - "Ezra can create WordPress draft posts from approved articles in content.db"
    - "Ezra posts Slack notification to #content-pipeline when a draft is created on WordPress"
    - "Human publishes the WP draft manually in WordPress admin (approval gate)"
    - "Ezra updates content.db with wp_post_id and wp_url after creating the WP draft"
    - "publish-check cron fires daily and triggers Ezra to check for approved articles"
  artifacts:
    - path: "~/.openclaw/skills/wordpress-publisher/SKILL.md (EC2)"
      provides: "WordPress REST API publishing workflow via curl"
      contains: "wp-json/wp/v2/posts"
    - path: "~/clawd/agents/ezra/PUBLISH_SESSION.md (EC2)"
      provides: "Cron-triggered publishing session instructions for Ezra"
      contains: "PUBLISH_SESSION"
    - path: "~/.openclaw/cron/jobs.json (EC2)"
      provides: "publish-check cron entry targeting Ezra"
      contains: "publish-check"
  key_links:
    - from: "PUBLISH_SESSION.md"
      to: "content.db articles table"
      via: "sqlite3 SELECT WHERE status='approved' AND wp_post_id IS NULL"
      pattern: "status.*approved.*wp_post_id IS NULL"
    - from: "SKILL.md wordpress-publisher"
      to: "WordPress REST API"
      via: "curl POST with Basic auth from sandbox env vars"
      pattern: "curl.*wp-json/wp/v2/posts"
    - from: "PUBLISH_SESSION.md"
      to: "#content-pipeline Slack"
      via: "Slack message announcing WP draft created for human review"
      pattern: "content-pipeline"
---

<objective>
Deploy Ezra's WordPress publishing workflow: skill, reference doc, and cron job.

Purpose: Complete the content pipeline by enabling Ezra to push approved articles to WordPress as drafts, with human approval gate before going live.
Output: wordpress-publisher SKILL.md, PUBLISH_SESSION.md, publish-check cron job.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-wordpress-publishing/16-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy wordpress-publisher SKILL.md for Ezra</name>
  <files>~/.openclaw/skills/wordpress-publisher/SKILL.md (EC2)</files>
  <action>
    SSH to EC2 (100.72.143.9) and create the wordpress-publisher skill.

    Create directory: `mkdir -p ~/.openclaw/skills/wordpress-publisher/`

    Write `~/.openclaw/skills/wordpress-publisher/SKILL.md` with this structure:

    **Frontmatter (required for OpenClaw detection):**
    ```yaml
    ---
    name: wordpress-publisher
    description: Publish approved articles from content.db to WordPress as drafts via REST API
    ---
    ```

    **Sections to include:**

    **Section 1: Overview**
    - You publish approved articles from content.db to WordPress as draft posts
    - Articles go to WP as "draft" status — human reviews and publishes in WP admin
    - After creating the WP draft, update content.db with wp_post_id and wp_url
    - Post a notification to #content-pipeline so the team knows a draft is ready for review

    **Section 2: Environment Variables**
    - WP_SITE_URL: WordPress site base URL (no trailing slash)
    - WP_USERNAME: WordPress username for API auth
    - WP_APP_PASSWORD: WordPress Application Password for API auth
    - These are available in your sandbox environment

    **Section 3: Create WordPress Draft Post**
    - Query: Find approved articles with no wp_post_id
      ```sql
      SELECT id, title, slug, body, word_count FROM articles
      WHERE status = 'approved' AND wp_post_id IS NULL
      ORDER BY updated_at ASC LIMIT 1;
      ```
    - Create draft post via curl:
      ```bash
      curl -s -X POST "$WP_SITE_URL/wp-json/wp/v2/posts" \
        -u "$WP_USERNAME:$WP_APP_PASSWORD" \
        -H "Content-Type: application/json" \
        -d '{
          "title": "Article Title Here",
          "content": "Full HTML article body here",
          "slug": "article-slug-here",
          "status": "draft"
        }'
      ```
    - The response JSON contains `id` (WP post ID) and `link` (WP URL)
    - Parse with: `echo "$RESPONSE" | jq -r '.id'` and `echo "$RESPONSE" | jq -r '.link'`

    **Section 4: Update content.db After Draft Creation**
    - Use BEGIN IMMEDIATE transaction (CP-05 claim locking pattern):
      ```sql
      BEGIN IMMEDIATE;
      UPDATE articles
      SET wp_post_id = {WP_POST_ID},
          wp_url = '{WP_URL}',
          updated_at = datetime('now')
      WHERE id = {ARTICLE_ID} AND status = 'approved';

      INSERT INTO pipeline_activity (entity_type, entity_id, action, agent_id, details)
      VALUES ('article', {ARTICLE_ID}, 'wp_draft_created', 'ezra',
              'WP post ID: {WP_POST_ID}, URL: {WP_URL}');
      COMMIT;
      ```

    **Section 5: Notify #content-pipeline**
    - After successfully creating the WP draft and updating content.db, post a message to #content-pipeline:
      ```
      :newspaper: **WordPress Draft Ready for Review**

      **Title:** {article title}
      **WP Draft URL:** {wp_url}
      **Word Count:** {word_count}
      **Article ID:** {article_id}

      This draft is ready for human review. Please review in WordPress admin and publish when satisfied.
      ```

    **Section 6: Handle WP Categories (Optional)**
    - List existing categories: `curl -s "$WP_SITE_URL/wp-json/wp/v2/categories" | jq '.[] | {id, name, slug}'`
    - Create new category: `curl -s -X POST "$WP_SITE_URL/wp-json/wp/v2/categories" -u "$WP_USERNAME:$WP_APP_PASSWORD" -H "Content-Type: application/json" -d '{"name": "Category Name", "slug": "category-slug"}'`
    - Add categories to post: include `"categories": [ID1, ID2]` in the POST body
    - Only assign categories if you can match the article's topic to an existing WP category

    **Section 7: Handle Published Status Update**
    - When a human confirms an article has been published (status changed in WP admin):
      ```sql
      BEGIN IMMEDIATE;
      UPDATE articles
      SET status = 'published',
          published_at = datetime('now'),
          updated_at = datetime('now')
      WHERE id = {ARTICLE_ID} AND wp_post_id IS NOT NULL;

      INSERT INTO pipeline_activity (entity_type, entity_id, action, agent_id, details)
      VALUES ('article', {ARTICLE_ID}, 'published', 'ezra', 'Published on WordPress');
      COMMIT;
      ```

    **Section 8: Error Handling**
    - If curl returns non-200: log the error, do NOT update content.db, report in #content-pipeline
    - If wp_post_id already set: skip (already drafted, awaiting human publish)
    - If no approved articles found: silently skip (no notification needed)
    - Common errors: 401 (bad credentials), 403 (insufficient permissions), 400 (invalid post data)

    **Important notes in skill:**
    - NEVER set WP post status to "publish" — always use "draft"
    - Human reviews and publishes in WordPress admin UI (WP-05 approval gate)
    - Use /workspace/content.db for all database operations (sandbox path)
    - curl and sqlite3 are pre-approved in exec-approvals allowlist
  </action>
  <verify>
    - `ssh ... cat ~/.openclaw/skills/wordpress-publisher/SKILL.md` shows valid YAML frontmatter + all 8 sections
    - Skill contains curl commands with $WP_SITE_URL, $WP_USERNAME, $WP_APP_PASSWORD env vars
    - Skill explicitly states status="draft" (never "publish")
    - Skill includes content.db update with pipeline_activity logging
    - Skill includes #content-pipeline notification template
  </verify>
  <done>wordpress-publisher SKILL.md deployed to ~/.openclaw/skills/wordpress-publisher/ with curl-based WP REST API workflow, draft-only publishing, content.db updates, and Slack notifications</done>
</task>

<task type="auto">
  <name>Task 2: Deploy PUBLISH_SESSION.md reference doc and publish-check cron job</name>
  <files>~/clawd/agents/ezra/PUBLISH_SESSION.md (EC2), ~/.openclaw/cron/jobs.json (EC2)</files>
  <action>
    SSH to EC2 (100.72.143.9) and create the reference doc + cron job.

    **Part A: Write PUBLISH_SESSION.md**

    Write `~/clawd/agents/ezra/PUBLISH_SESSION.md` with this content:

    ```markdown
    # Publish Session

    You are Ezra, the WordPress publisher. This is a cron-triggered publishing session.

    ## Instructions

    1. **Check for approved articles** ready to publish to WordPress:
       ```sql
       SELECT id, title, slug, body, word_count
       FROM articles
       WHERE status = 'approved' AND wp_post_id IS NULL
       ORDER BY updated_at ASC;
       ```

    2. **If no approved articles found:** End session silently. Do not post to Slack.

    3. **For each approved article** (process up to 3 per session):
       a. Use the wordpress-publisher skill to create a WordPress draft post
       b. Update content.db with the wp_post_id and wp_url
       c. Log the activity in pipeline_activity
       d. Post notification to #content-pipeline

    4. **Also check for recently published articles** (human published in WP admin):
       ```sql
       SELECT a.id, a.title, a.wp_post_id, a.wp_url
       FROM articles a
       WHERE a.wp_post_id IS NOT NULL
         AND a.status = 'approved'
       ORDER BY a.updated_at ASC;
       ```
       For each, check if the WP post is now published:
       ```bash
       curl -s "$WP_SITE_URL/wp-json/wp/v2/posts/{WP_POST_ID}" \
         -u "$WP_USERNAME:$WP_APP_PASSWORD" | jq -r '.status'
       ```
       If status is "publish", update content.db:
       ```sql
       BEGIN IMMEDIATE;
       UPDATE articles SET status = 'published', published_at = datetime('now'), updated_at = datetime('now')
       WHERE id = {ARTICLE_ID};
       INSERT INTO pipeline_activity (entity_type, entity_id, action, agent_id, details)
       VALUES ('article', {ARTICLE_ID}, 'published', 'ezra', 'Confirmed published on WordPress');
       COMMIT;
       ```
       Post to #content-pipeline: ":tada: Article published: {title} — {wp_url}"

    5. **Post session summary** to #content-pipeline:
       - Number of new WP drafts created
       - Number of articles confirmed published
       - Any errors encountered

    ## Database Path
    Use `/workspace/content.db` for all sqlite3 operations.

    ## Constraints
    - Process a maximum of 3 articles per session to stay within timeout
    - Never set WP post status to "publish" — always "draft"
    - Human approval gate: only humans publish via WordPress admin
    ```

    **Part B: Add publish-check cron job**

    Edit `~/.openclaw/cron/jobs.json` on EC2 to add a new cron entry.

    Use the established content agent cron pattern:
    - **id:** Generate a UUID (use `uuidgen` on EC2)
    - **name:** "publish-check"
    - **schedule:** `"0 14 * * *"` (2 PM PT daily — after Sage's review windows at 10 AM + 3 PM)
    - **tz:** `"America/Los_Angeles"`
    - **enabled:** true
    - **wakeMode:** "now"
    - **sessionTarget:** "ezra"
    - **payload:**
      - kind: "agentTurn"
      - model: "sonnet"
      - message: "Read /workspace/PUBLISH_SESSION.md and follow its instructions. Check for approved articles to draft on WordPress and check for articles that have been published by human reviewers."
    - **timeoutSeconds:** 600
    - No delivery config (per lessons learned — announce mode only works with isolated sessions)

    Use jq to append the new job to the existing jobs array without disturbing other entries.

    **Part C: Restart gateway and verify**

    1. Restart: `systemctl --user restart openclaw-gateway.service`
    2. Verify active: `systemctl --user status openclaw-gateway.service`
    3. Verify cron loaded: `cat ~/.openclaw/cron/jobs.json | jq '.[] | select(.name=="publish-check") | {name, schedule, tz, sessionTarget, enabled}'`
    4. Count total crons: `cat ~/.openclaw/cron/jobs.json | jq 'length'` (should be 16, up from 15)
  </action>
  <verify>
    - `ssh ... cat ~/clawd/agents/ezra/PUBLISH_SESSION.md` shows full reference doc with all 5 instruction sections
    - `ssh ... jq '.[] | select(.name=="publish-check")' ~/.openclaw/cron/jobs.json` returns the cron entry
    - Cron has: schedule "0 14 * * *", tz "America/Los_Angeles", sessionTarget "ezra", kind "agentTurn", model "sonnet", timeoutSeconds 600
    - No delivery config on the cron entry
    - Gateway service is active after restart
    - Total cron count is 16
  </verify>
  <done>PUBLISH_SESSION.md deployed to Ezra's workspace, publish-check cron fires daily at 2 PM PT targeting Ezra with 10-min timeout, gateway restarted and all crons loaded</done>
</task>

</tasks>

<verification>
- wordpress-publisher SKILL.md exists at ~/.openclaw/skills/wordpress-publisher/SKILL.md with valid frontmatter
- SKILL.md teaches draft-only WP publishing with curl (never "publish" status)
- PUBLISH_SESSION.md exists at ~/clawd/agents/ezra/PUBLISH_SESSION.md
- publish-check cron entry in jobs.json with correct schedule, target, and model
- Gateway service is active after restart
- Total cron jobs: 16
- Human approval gate: articles only go to WP as drafts, human publishes in WP admin
</verification>

<success_criteria>
Ezra has a complete WordPress publishing workflow: skill teaches WP REST API via curl, reference doc instructs cron sessions, cron fires daily at 2 PM PT. Approved articles become WP drafts with Slack notification. Human publishes in WP admin.
</success_criteria>

<output>
After completion, create `.planning/phases/16-wordpress-publishing/16-02-SUMMARY.md`
</output>
