---
phase: 28-platform-cleanup
plan: 02
type: execute
wave: 2
depends_on:
  - 28-01
files_modified:
  - .planning/PROJECT.md
  - .planning/phases/28-platform-cleanup/28-02-SUMMARY.md
autonomous: false
requirements:
  - CLN-01
  - CLN-05

must_haves:
  truths:
    - "gog auth list shows Gmail OAuth tokens without excess settings scopes (gmail.settings.basic, gmail.settings.sharing removed)"
    - "Both personal and AirSpace accounts re-authed with trimmed scope sets"
    - "gog gmail search and gog calendar events commands work for both accounts after re-auth"
    - "gateway.remote.url documented in PROJECT.md with explanation of why it's needed"
    - "Gateway is reachable from VPS over Tailscale"
  artifacts:
    - path: ".planning/PROJECT.md"
      provides: "gateway.remote.url documentation"
      contains: "gateway.remote"
    - path: "~/.config/gogcli/keyring/ (on EC2)"
      provides: "Re-authed OAuth tokens with trimmed scopes"
  key_links:
    - from: "gog auth list"
      to: "~/.config/gogcli/keyring/"
      via: "keyring stores OAuth tokens with scope grants"
      pattern: "no gmail.settings scopes in auth list output"
    - from: "VPS curl"
      to: "EC2 gateway at 100.72.143.9:18789"
      via: "Tailscale network"
      pattern: "200 or connection success from VPS"
---

<objective>
Re-auth Gmail OAuth with trimmed scopes for both accounts and document gateway.remote.url in PROJECT.md.

Purpose: Remove the 2 excess OAuth scopes (gmail.settings.basic, gmail.settings.sharing) deferred since Phase 1, and document the gateway.remote.url config that's been critical since Phase 20 but never formally documented. Per user's locked verification order: OAuth third, gateway docs last.
Output: Clean OAuth tokens + documented gateway config.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-platform-cleanup/28-CONTEXT.md
@.planning/phases/28-platform-cleanup/28-RESEARCH.md
@.planning/phases/28-platform-cleanup/28-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Re-auth Gmail OAuth with trimmed scopes (both accounts)</name>
  <files>EC2: ~/.config/gogcli/keyring/, ~/.openclaw/.env</files>
  <action>
Re-auth both Gmail accounts with `--services gmail,calendar` to remove excess `gmail.settings.basic` and `gmail.settings.sharing` scopes. Per user decision: one-shot re-auth, both accounts in same session.

**IMPORTANT research findings to be aware of:**
- `gog --services gmail` may request `https://mail.google.com/` (broader than current `gmail.modify`). This is acceptable per research Option A.
- `gmail.modify` already subsumes `gmail.readonly` and `gmail.send` per Google scope hierarchy. The success criteria in ROADMAP says "minimum: gmail.readonly + gmail.send + gmail.modify + calendar.readonly" but this is redundant -- `gmail.modify` alone covers read+send+modify.
- Calendar scope: audit whether Bob creates calendar events before downgrading to readonly. If no creation usage found, could use `calendar.readonly`, but `--services calendar` gives full scope. Per user decision: accept what gog provides, document it.

**Step 0: Audit calendar write usage**
Before re-auth, check if any cron/skill creates calendar events:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'grep -r "calendar.*create\|calendar.*insert\|create.*event" ~/.openclaw/cron/jobs.json ~/.openclaw/skills/ ~/clawd/agents/ 2>/dev/null | head -20'
```
If no calendar write usage found, document that full calendar scope is acceptable (gog provides it, and it's unused headroom).

**Step 1: Backup keyring**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'mkdir -p ~/backups/gog-keyring-pre-phase28 && cp -r ~/.config/gogcli/keyring/ ~/backups/gog-keyring-pre-phase28/'
```

**Step 2: Check current scopes**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'export GOG_KEYRING_PASSWORD=$(grep GOG_KEYRING_PASSWORD ~/.openclaw/.env | cut -d= -f2) && gog auth list'
```
Document current scope set for comparison.

**Step 3: Re-auth personal account (theandykaufman@gmail.com)**
This is interactive -- requires TTY for OAuth flow:
```bash
ssh -t -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9
# Then on EC2:
export GOG_KEYRING_PASSWORD=$(grep GOG_KEYRING_PASSWORD ~/.openclaw/.env | cut -d= -f2)
gog auth remove theandykaufman@gmail.com
gog auth add theandykaufman@gmail.com --manual --services gmail,calendar --client pops-claw
```
Follow the interactive OAuth flow: copy URL, authorize in browser, paste code back.

**Step 4: Verify personal account**
```bash
gog auth list
gog gmail search --account=theandykaufman@gmail.com "newer_than:1d" --max 3
gog calendar events --account=theandykaufman@gmail.com --all --today --max 5
```
Confirm: scopes reduced (no `gmail.settings.basic`, no `gmail.settings.sharing`). Gmail search and calendar query work.

**Step 5: Re-auth AirSpace account (Kaufman@AirSpaceIntegration.com)**
```bash
gog auth remove Kaufman@AirSpaceIntegration.com
gog auth add Kaufman@AirSpaceIntegration.com --manual --services gmail,calendar --client pops-claw
```
Follow the interactive OAuth flow. Note: Google Workspace admin may need to re-approve if scopes changed. Have admin access ready as fallback.

**Step 6: Verify AirSpace account**
```bash
gog auth list
gog gmail search --account=Kaufman@AirSpaceIntegration.com "newer_than:1d" --max 3
gog calendar events --account=Kaufman@AirSpaceIntegration.com --all --today --max 5
```

**Step 7: Smoke test cron jobs that use gog**
Test at least one cron that uses Gmail and one that uses Calendar to confirm they still work:
```bash
# Test a quick gog operation that mirrors what crons do
gog gmail search --account=theandykaufman@gmail.com "newer_than:1d" --max 5
gog calendar events --account=theandykaufman@gmail.com --all --today --max 10
```
Per user decision: if a cron job fails post-trim, add the missing scope back surgically.

**Step 8: Restart gateway to pick up any auth changes**
```bash
systemctl --user restart openclaw-gateway.service
sleep 5
systemctl --user status openclaw-gateway.service
```

**Rollback:** Restore keyring backup:
```bash
cp -r ~/backups/gog-keyring-pre-phase28/keyring/ ~/.config/gogcli/keyring/
```
  </action>
  <verify>
`gog auth list` shows both accounts with scopes that do NOT include `gmail.settings.basic` or `gmail.settings.sharing`. `gog gmail search` and `gog calendar events` succeed for both accounts. Gateway is running.
  </verify>
  <done>
Both personal and AirSpace Gmail OAuth tokens re-authed with trimmed scopes. Excess `gmail.settings.basic` and `gmail.settings.sharing` scopes removed. All gog commands functional. CLN-01 complete.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify OAuth re-auth completed successfully</name>
  <files>EC2: ~/.config/gogcli/keyring/</files>
  <action>
Human verifies OAuth re-auth results. What was built: Gmail OAuth scope reduction for both accounts (theandykaufman@gmail.com and Kaufman@AirSpaceIntegration.com). Re-authed with `--services gmail,calendar` to remove excess settings scopes.

How to verify:
1. Check the summary output from Task 1 -- confirm both accounts show trimmed scopes
2. If Task 1 encountered issues with the AirSpace Workspace account (admin re-approval needed), confirm whether you completed the Workspace admin approval
3. Confirm you're satisfied with the scope set before we proceed to documentation

Resume signal: Type "approved" to proceed to gateway documentation, or describe any issues with the OAuth re-auth.
  </action>
  <verify>User confirms OAuth scopes are acceptable for both accounts.</verify>
  <done>User approved the OAuth re-auth results. Safe to proceed with gateway documentation.</done>
</task>

<task type="auto">
  <name>Task 3: Document gateway.remote.url in PROJECT.md and verify from VPS</name>
  <files>.planning/PROJECT.md</files>
  <action>
Document the `gateway.remote.url` config in PROJECT.md and verify gateway reachability from VPS. This config has been critical since Phase 20 (tailnet bind) but was never formally documented.

**Step 1: Verify gateway.remote.url in config**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'grep -A2 "remote" ~/.openclaw/openclaw.json'
```
Expected: `"url": "ws://100.72.143.9:18789"` under `gateway.remote`.

**Step 2: Test gateway reachability from VPS**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'curl -s -o /dev/null -w "%{http_code}" http://100.72.143.9:18789/health 2>/dev/null || echo "direct test"'
```
Also test from VPS over Tailscale:
```bash
ssh ubuntu@100.105.251.99 \
  'curl -s -o /dev/null -w "%{http_code}" http://100.72.143.9:18789/health'
```
If SSH to VPS requires a key, use:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.105.251.99 \
  'curl -s -o /dev/null -w "%{http_code}" http://100.72.143.9:18789/health'
```
Or test from Mac via Tailscale:
```bash
curl -s -o /dev/null -w "%{http_code}" http://100.72.143.9:18789/health
```
Expect: 200 or 401 (authentication required is fine -- it means the gateway is reachable).

**Step 3: Update PROJECT.md**
Add a section to PROJECT.md documenting `gateway.remote.url`. Add it to the Infrastructure section, explaining:
- What `gateway.remote.url` is: tells the CLI where to connect when gateway isn't on localhost
- Why it's needed: gateway binds to tailnet IP (100.72.143.9:18789) not loopback, so CLI commands fail with 1006 abnormal closure without it
- Where it's configured: `gateway.remote.url` in `~/.openclaw/openclaw.json`
- Value: `ws://100.72.143.9:18789`
- When it was added: Phase 20 (inbound email infrastructure required tailnet bind)

Add to the Infrastructure block in PROJECT.md after the existing items. Also add to Key Decisions table:
| Gateway remote URL for tailnet bind | CLI needs explicit gateway URL when not on loopback | Done -- ws://100.72.143.9:18789 |
  </action>
  <verify>
PROJECT.md contains `gateway.remote.url` documentation. Gateway is reachable from at least one external point (VPS or Mac via Tailscale). `grep "gateway.remote" .planning/PROJECT.md` returns matches.
  </verify>
  <done>
`gateway.remote.url` documented in PROJECT.md with explanation of why it's needed (tailnet bind). Gateway verified reachable from VPS/Tailscale. CLN-05 complete.
  </done>
</task>

</tasks>

<verification>
1. `gog auth list` on EC2 shows both accounts WITHOUT `gmail.settings.basic` or `gmail.settings.sharing` scopes
2. `gog gmail search` and `gog calendar events` work for both accounts
3. PROJECT.md contains `gateway.remote.url` documentation
4. Gateway reachable from VPS over Tailscale (curl returns 200 or 401)
5. Gateway service is active and running
</verification>

<success_criteria>
- OAuth tokens trimmed for both personal and AirSpace accounts (CLN-01)
- gateway.remote.url documented in PROJECT.md and verified reachable from VPS (CLN-05)
- Gateway running and all gog operations functional
</success_criteria>

<output>
After completion, create `.planning/phases/28-platform-cleanup/28-02-SUMMARY.md`
</output>
