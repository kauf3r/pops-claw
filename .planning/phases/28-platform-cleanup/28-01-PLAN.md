---
phase: 28-platform-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/28-platform-cleanup/28-01-SUMMARY.md
autonomous: true
requirements:
  - CLN-02
  - CLN-03
  - CLN-04

must_haves:
  truths:
    - "openclaw doctor reports zero warnings on EC2"
    - "Deprecated auth profile migrated to setup-token format"
    - "Legacy session keys canonicalized to agent:<agentId>:<channel>:group:<id> format"
    - "dmPolicy/allowFrom config aliases confirmed active (Phase 24-01 migration verified)"
  artifacts:
    - path: "~/.openclaw/openclaw.json (on EC2)"
      provides: "Modern config with dmPolicy/allowFrom aliases"
      contains: "dmPolicy"
    - path: "~/.openclaw/ auth profile state (on EC2)"
      provides: "Migrated auth profile using setup-token"
  key_links:
    - from: "openclaw doctor"
      to: "openclaw.json + auth state + session state"
      via: "doctor scans all config and state for warnings"
      pattern: "zero warnings in doctor output"
---

<objective>
Resolve all `openclaw doctor` warnings and verify config migration is clean.

Purpose: Establish a clean diagnostic baseline before the more disruptive OAuth re-auth in Plan 02. Per user's locked verification order: doctor warnings first, config verification second.
Output: Zero-warning `openclaw doctor` output on EC2.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/28-platform-cleanup/28-CONTEXT.md
@.planning/phases/28-platform-cleanup/28-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix doctor warnings (deprecated auth profile + legacy session keys)</name>
  <files>EC2: ~/.openclaw/ (auth state, session state)</files>
  <action>
SSH into EC2 and fix both doctor warnings. Per user decision: fix all warnings in one pass, but test `openclaw doctor` after each individual fix.

**Step 1: Baseline diagnostic**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  '/home/ubuntu/.npm-global/bin/openclaw doctor 2>&1'
```
Capture current warnings. Expected: deprecated auth profile + legacy session key warnings.

**Step 2: Fix deprecated auth profile (CLN-02)**
The `anthropic:claude-cli` profile needs migration to `anthropic:manual` (setup-token). This is interactive -- needs TTY:
```bash
ssh -t -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  '/home/ubuntu/.npm-global/bin/openclaw models auth setup-token'
```
This will prompt for a token. Follow the interactive flow.

After fixing, verify:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  '/home/ubuntu/.npm-global/bin/openclaw doctor 2>&1'
```
Confirm auth profile warning is gone.

**Step 3: Fix legacy session keys (CLN-03)**
Doctor auto-canonicalizes session keys to `agent:<agentId>:<channel>:group:<id>` format:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  '/home/ubuntu/.npm-global/bin/openclaw doctor --fix 2>&1'
```

After fixing, verify:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  '/home/ubuntu/.npm-global/bin/openclaw doctor 2>&1'
```
Confirm zero warnings.

**Step 4: Verify gateway still running**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'systemctl --user status openclaw-gateway.service'
```
If gateway is down after doctor --fix, restart:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'systemctl --user restart openclaw-gateway.service && sleep 3 && systemctl --user status openclaw-gateway.service'
```

**Rollback:** If a fix breaks gateway startup, check journal:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'journalctl --user -u openclaw-gateway.service --since "5 min ago" --no-pager'
```
Doctor fixes are reversible -- the auth profile can be re-added, session keys are only reformatted (not deleted).
  </action>
  <verify>
Run `openclaw doctor` on EC2 and confirm zero warnings in output. Run `systemctl --user status openclaw-gateway.service` and confirm active (running).
  </verify>
  <done>
`openclaw doctor` outputs zero warnings. Gateway service is active and running. Both CLN-02 (auth profile) and CLN-03 (session keys) resolved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify dmPolicy/allowFrom config migration (CLN-04)</name>
  <files>EC2: ~/.openclaw/openclaw.json</files>
  <action>
Per research, the dmPolicy/allowFrom migration was already completed in Phase 24-01 during the v2026.2.17 update. This task is verification only -- confirm the migration is present and doctor doesn't flag it.

**Step 1: Check config for modern aliases**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  'grep -E "dmPolicy|allowFrom|dm\.policy|dm\.allowFrom" ~/.openclaw/openclaw.json'
```
Expected: `dmPolicy` and `allowFrom` keys present. No `dm.policy` or `dm.allowFrom` keys.

**Step 2: Confirm doctor is clean (should already be clean from Task 1)**
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  '/home/ubuntu/.npm-global/bin/openclaw doctor 2>&1'
```
Confirm no config alias warnings.

**If old keys found (unlikely):** Follow user's locked decision -- clean switch to new aliases, no old keys left behind:
```bash
# Only if needed -- edit openclaw.json to replace dm.policy with dmPolicy, dm.allowFrom with allowFrom
# Then restart gateway and verify with openclaw doctor
```

Since this is expected to be verification-only (already done in Phase 24-01), this should be a quick confirmation step.
  </action>
  <verify>
`grep` output shows `dmPolicy` and `allowFrom` in openclaw.json. No `dm.policy` or `dm.allowFrom` present. `openclaw doctor` shows no config alias warnings.
  </verify>
  <done>
Config uses modern `dmPolicy`/`allowFrom` aliases. No legacy config keys remain. CLN-04 verified complete.
  </done>
</task>

</tasks>

<verification>
1. `openclaw doctor` on EC2 outputs zero warnings (no deprecated auth, no legacy session keys, no config aliases)
2. Gateway service is active and running after all fixes
3. `openclaw.json` contains `dmPolicy`/`allowFrom` (not legacy `dm.policy`/`dm.allowFrom`)
</verification>

<success_criteria>
- Zero warnings from `openclaw doctor`
- Gateway service running and healthy
- CLN-02, CLN-03, CLN-04 all resolved/verified
</success_criteria>

<output>
After completion, create `.planning/phases/28-platform-cleanup/28-01-SUMMARY.md`
</output>
