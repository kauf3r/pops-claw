---
phase: 05-govee-wyze-integrations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/.openclaw/.env
  - /home/ubuntu/.openclaw/openclaw.json
  - /home/ubuntu/.openclaw/skills/govee/SKILL.md
  - /home/ubuntu/clawd/agents/main/health.db
autonomous: false
user_setup:
  - service: govee
    why: "Smart home device control and sensor data"
    env_vars:
      - name: GOVEE_API_KEY
        source: "Govee Home App -> Settings (gear icon) -> Apply for API Key. Key is emailed to your Govee account email."
    dashboard_config: []

must_haves:
  truths:
    - "Bob can list all Govee devices bound to the account"
    - "Bob can read temperature and humidity from Govee sensors"
    - "Bob can turn lights on/off and set brightness and color"
    - "Bob stores Govee sensor readings in the existing health.db"
    - "SKILL.md documents anomaly detection thresholds for temp/humidity"
  artifacts:
    - path: "/home/ubuntu/.openclaw/skills/govee/SKILL.md"
      provides: "Govee device skill with API docs, sensor reading, light control, anomaly detection"
      min_lines: 100
    - path: "/home/ubuntu/.openclaw/.env"
      provides: "GOVEE_API_KEY env var"
      contains: "GOVEE_API_KEY="
    - path: "/home/ubuntu/clawd/agents/main/health.db"
      provides: "govee_readings table for sensor data storage"
      contains: "govee_readings"
  key_links:
    - from: "/home/ubuntu/.openclaw/skills/govee/SKILL.md"
      to: "https://openapi.api.govee.com/router/api/v1/"
      via: "curl with Govee-API-Key header from GOVEE_API_KEY env var"
      pattern: "GOVEE_API_KEY"
    - from: "/home/ubuntu/.openclaw/openclaw.json"
      to: "sandbox docker env"
      via: "agents.defaults.sandbox.docker.env injection"
      pattern: "GOVEE_API_KEY"
    - from: "SKILL.md sensor reading workflow"
      to: "SQLite govee_readings table"
      via: "sqlite3 CLI INSERT after API call"
      pattern: "govee_readings"
---

<objective>
Create the Govee smart home skill for Bob with API access, sensor reading, light control, and anomaly detection thresholds. Set up environment, create SQLite table for sensor data, and deploy SKILL.md.

Purpose: Give Bob the ability to read temperature/humidity from Govee sensors, control smart lights, and detect environmental anomalies — all from the Docker sandbox.

Output: Working SKILL.md on EC2, GOVEE_API_KEY configured, govee_readings table in health.db, Bob able to query sensors and control lights.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-oura-ring-integration/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Configure GOVEE_API_KEY and create govee_readings table</name>
  <files>/home/ubuntu/.openclaw/.env, /home/ubuntu/.openclaw/openclaw.json, /home/ubuntu/clawd/agents/main/health.db</files>
  <action>
SSH to EC2 (ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9).

1. **Add GOVEE_API_KEY to .env** (value from user_setup or already present):
   echo 'GOVEE_API_KEY=<key>' | ssh ... "tee -a ~/.openclaw/.env > /dev/null"
   Verify: ssh ... "grep GOVEE_API_KEY ~/.openclaw/.env"

2. **Inject GOVEE_API_KEY into sandbox docker env** (same pattern as OURA_ACCESS_TOKEN in Phase 2):
   Use python3 or jq on EC2 to add GOVEE_API_KEY to `agents.defaults.sandbox.docker.env` in ~/.openclaw/openclaw.json.
   Pattern: read JSON, add key "GOVEE_API_KEY": "$GOVEE_API_KEY" to the docker.env object, write back.
   Verify: ssh ... "python3 -c \"import json; c=json.load(open('/home/ubuntu/.openclaw/openclaw.json')); print('GOVEE_API_KEY' in str(c))\""

3. **Smoke-test the Govee API** to verify the key works and discover actual device IDs/SKUs:
   ssh ... "curl -s -H 'Govee-API-Key: <key>' -H 'Content-Type: application/json' 'https://openapi.api.govee.com/router/api/v1/user/devices'"
   Save the response — it contains all device SKUs, MACs, and capabilities needed for SKILL.md.
   IMPORTANT: If the base URL returns errors, try the v1 legacy endpoint: https://developer-api.govee.com/v1/devices
   Record which devices are sensors (temp/humidity) and which are lights.

4. **Create govee_readings table in existing health.db**:
   Use sqlite3 CLI on EC2:
   ssh ... "sqlite3 /home/ubuntu/clawd/agents/main/health.db 'CREATE TABLE IF NOT EXISTS govee_readings (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     device_id TEXT NOT NULL,
     device_name TEXT,
     sku TEXT NOT NULL,
     temperature_f REAL,
     humidity_pct REAL,
     online INTEGER,
     reading_time TEXT NOT NULL,
     created_at TEXT DEFAULT CURRENT_TIMESTAMP
   );
   CREATE INDEX IF NOT EXISTS idx_govee_device_time ON govee_readings(device_id, reading_time);'"
   Verify: ssh ... "sqlite3 /home/ubuntu/clawd/agents/main/health.db '.schema govee_readings'"

5. **Restart gateway** to pick up new env var:
   ssh ... "systemctl --user restart openclaw-gateway.service"
   Verify: ssh ... "systemctl --user status openclaw-gateway.service"
  </action>
  <verify>
- grep GOVEE_API_KEY on .env returns the key line
- openclaw.json contains GOVEE_API_KEY in sandbox docker env
- curl to Govee API returns device list (200 status)
- govee_readings table exists in health.db with all columns
- Gateway service is active after restart
  </verify>
  <done>
GOVEE_API_KEY configured in .env and sandbox env. Govee API smoke-tested with real device discovery. govee_readings SQLite table created in existing health.db. Gateway restarted.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Govee SKILL.md with sensor reading, light control, and anomaly alerts</name>
  <files>/home/ubuntu/.openclaw/skills/govee/SKILL.md</files>
  <action>
SSH to EC2. Create directory and skill file:
  ssh ... "mkdir -p ~/.openclaw/skills/govee"

Write SKILL.md via scp (create locally, then scp to EC2) or use tee. The skill MUST use actual device IDs/SKUs discovered in Task 1's smoke test.

**Section 1: Overview**
- Skill name: Govee Smart Home
- Purpose: Read sensor data (temp, humidity) and control smart lights
- Auth: GOVEE_API_KEY env var
- Base URL: https://openapi.api.govee.com/router/api/v1
  (If smoke test in Task 1 showed v1 legacy URL works instead, use that)

**Section 2: Authentication**
- Header: Govee-API-Key: $GOVEE_API_KEY
- Rate limit: 10,000 requests/day
- All requests need Content-Type: application/json

**Section 3: List Devices**
Endpoint: GET /user/devices
Example curl command. Document actual devices discovered in Task 1 with their SKU, device ID (MAC), and type (sensor vs light).

**Section 4: Read Sensor Data (GV-03)**
Endpoint: POST /device/state
Request body: {"requestId": "uuid", "payload": {"sku": "<sensor_sku>", "device": "<sensor_mac>"}}
Parse response capabilities array for:
- sensorTemperature (value in Celsius * 100 — divide by 100 and optionally convert to F)
- sensorHumidity (value as percentage * 100 — divide by 100)
Include example curl and response parsing instructions.

**Section 5: Control Lights (GV-04)**
Endpoint: POST /device/control
Request body structure:
{
  "requestId": "uuid",
  "payload": {
    "sku": "<light_sku>",
    "device": "<light_mac>",
    "capability": {
      "type": "devices.capabilities.on_off",
      "instance": "powerSwitch",
      "value": 1
    }
  }
}
Document these control commands:
- Turn on/off: type=devices.capabilities.on_off, instance=powerSwitch, value=1/0
- Brightness: type=devices.capabilities.range, instance=brightness, value=0-100
- Color: type=devices.capabilities.color_setting, instance=colorRgb, value={"r":R,"g":G,"b":B}
Include example curl for each.

**Section 6: Store Sensor Readings**
Instructions for Bob to:
1. Call device state for each sensor
2. Parse temperature and humidity from capabilities
3. INSERT into /workspace/health.db govee_readings table using sqlite3:
   sqlite3 /workspace/health.db "INSERT INTO govee_readings (device_id, device_name, sku, temperature_f, humidity_pct, online, reading_time) VALUES ('<device_id>', '<name>', '<sku>', <temp_f>, <humidity>, <online>, datetime('now'));"
4. Report formatted readings

**Section 7: Anomaly Detection (GV-06)**
Define thresholds:
- Temperature: alert if below 60F or above 85F (indoor comfort range)
- Humidity: alert if below 30% or above 60% (comfort range)
- Device offline: alert if device not responding

Instructions:
1. After reading sensor data, compare against thresholds
2. If any threshold breached, send alert to Andy's Slack DM (D0AARQR0Y4V)
3. Format: "Govee Alert: [device_name] temperature is [value]F (threshold: 60-85F)"
4. Check last 3 readings for persistent anomaly (not just a single spike)

Query for trend:
  sqlite3 /workspace/health.db "SELECT temperature_f, humidity_pct, reading_time FROM govee_readings WHERE device_id='<id>' ORDER BY reading_time DESC LIMIT 3;"

**Section 8: Error Handling**
- 401: API key invalid — tell user to reapply in Govee Home App
- 429: Rate limited — wait 60s and retry
- Device offline: Report "device offline" instead of failing
- Network error: Retry once, then report failure

**Section 9: Quick Reference**
Table of all devices with name, SKU, MAC, type (sensor/light), room.

Verify the skill is detected:
  ssh ... "/home/ubuntu/.npm-global/bin/openclaw skills list"
  </action>
  <verify>
- SKILL.md exists at ~/.openclaw/skills/govee/SKILL.md
- File is >100 lines with all 9 sections
- Contains actual device IDs from smoke test (not placeholders)
- "openclaw skills list" shows the govee skill
  </verify>
  <done>
Govee SKILL.md created with full API docs for device listing, sensor reading, light control, data storage, and anomaly detection. Uses real device IDs. Skill detected by OpenClaw.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Govee smart home skill with API access to sensors and lights, SQLite storage for readings, and anomaly detection thresholds. Bob should be able to read sensors and control lights.
  </what-built>
  <how-to-verify>
1. Open Slack and message Bob: "What's the current temperature and humidity from my Govee sensors?"
2. Bob should:
   - Call the Govee API to get device state for sensors
   - Parse temperature and humidity values
   - Store readings in /workspace/health.db govee_readings table
   - Report formatted readings
3. Then message Bob: "Turn on the living room lights to 50% brightness"
4. Bob should:
   - Call the Govee control endpoint for the light
   - Confirm the action was successful
5. Verify storage: ssh to EC2 and run:
   sqlite3 ~/clawd/agents/main/health.db "SELECT * FROM govee_readings ORDER BY created_at DESC LIMIT 3;"
6. Numbers should match what Bob reported

If Bob can't find the skill, restart gateway: systemctl --user restart openclaw-gateway.service
If API returns 401, the key needs to be regenerated in the Govee Home App.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 5 Govee requirements check:
- GV-01: SKILL.md exists at ~/.openclaw/skills/govee/SKILL.md
- GV-02: GOVEE_API_KEY present in ~/.openclaw/.env and sandbox docker env
- GV-03: Skill documents sensor reading with actual device IDs, Bob reads temp/humidity
- GV-04: Skill documents light control (on/off, brightness, color) with actual device IDs
- GV-06: Skill includes anomaly detection thresholds (temp 60-85F, humidity 30-60%)
</verification>

<success_criteria>
1. Bob successfully reads Govee sensor data and reports temperature/humidity
2. Bob successfully controls a light (on/off or brightness)
3. Govee sensor readings stored in health.db govee_readings table
4. Anomaly detection thresholds documented in SKILL.md
5. Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/05-govee-wyze-integrations/05-01-SUMMARY.md`
</output>
