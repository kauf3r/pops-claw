---
phase: 31.1-context-usage-indicators
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/constants.ts
  - src/lib/utils.ts
  - src/lib/queries/agents.ts
  - src/components/agents/agent-card.tsx
autonomous: false
requirements: []

must_haves:
  truths:
    - "Each agent card on /agents shows a context window utilization progress bar with green/amber/red coloring"
    - "Each agent card shows cache hit rate as a colored percentage"
    - "Each agent card shows 24h cost as $X.XX"
    - "Agents with no LLM calls in 24h show dashes instead of misleading zeros"
    - "Context % uses total tokens (input + cache_read + cache_write) not just input_tokens column"
  artifacts:
    - path: "src/lib/constants.ts"
      provides: "MODEL_CONTEXT_LIMITS with Sonnet 4.5 at 1M and Haiku 4.5 at 200K"
      contains: "MODEL_CONTEXT_LIMITS"
    - path: "src/lib/utils.ts"
      provides: "formatCost, getContextColor, getCacheColor utility functions"
      contains: "getContextColor"
    - path: "src/lib/queries/agents.ts"
      provides: "contextPct, cacheHitRate, cost24h fields in AgentBoardData"
      contains: "contextPct"
    - path: "src/components/agents/agent-card.tsx"
      provides: "Context section with progress bar, cache rate, and cost display"
      contains: "Context"
  key_links:
    - from: "src/lib/queries/agents.ts"
      to: "src/lib/constants.ts"
      via: "imports MODEL_CONTEXT_LIMITS and DEFAULT_CONTEXT_LIMIT"
      pattern: "MODEL_CONTEXT_LIMITS\\[.*model"
    - from: "src/components/agents/agent-card.tsx"
      to: "src/lib/utils.ts"
      via: "imports getContextColor, getCacheColor, formatCost"
      pattern: "getContextColor|getCacheColor|formatCost"
    - from: "src/components/agents/agent-card.tsx"
      to: "src/lib/queries/agents.ts"
      via: "renders contextPct, cacheHitRate, cost24h from AgentBoardData"
      pattern: "agent\\.contextPct|agent\\.cacheHitRate|agent\\.cost24h"
---

<objective>
Add context usage indicators to agent cards on /agents: context window utilization %, cache hit rate, and 24h cost per agent.

Purpose: Surface context and cost visibility at a glance -- the existing agent board shows health and tokens but not how much of the context window is consumed, how effective caching is, or what each agent costs per day.

Output: Extended AgentCard with compact "Context" section showing progress bar, cache %, and cost.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/31.1-context-usage-indicators/31.1-RESEARCH.md
@.planning/phases/31-agent-board/31-01-SUMMARY.md
@.planning/phases/31-agent-board/31-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add context metrics to agent data layer</name>
  <files>
    src/lib/constants.ts
    src/lib/utils.ts
    src/lib/queries/agents.ts
  </files>
  <action>
**constants.ts** -- Add MODEL_CONTEXT_LIMITS and DEFAULT_CONTEXT_LIMIT:

```typescript
// Context window limits per model (tokens)
// Sonnet 4.5: 1M beta context (this deployment has access)
// Haiku 4.5: 200K standard context
export const MODEL_CONTEXT_LIMITS: Record<string, number> = {
  "claude-sonnet-4-5": 1_000_000,
  "claude-haiku-4-5": 200_000,
};

export const DEFAULT_CONTEXT_LIMIT = 200_000;
```

**utils.ts** -- Add three utility functions:

1. `getContextColor(pct: number | null): string` -- returns Tailwind text color class:
   - null → "text-muted-foreground"
   - >80 → "text-rose-400"
   - >60 → "text-amber-400"
   - else → "text-emerald-400"

2. `getCacheColor(rate: number | null): string` -- returns Tailwind text color class:
   - null → "text-muted-foreground"
   - <20 → "text-rose-400"
   - <50 → "text-amber-400"
   - else → "text-emerald-400"

3. `formatCost(usd: number): string` -- returns `$${usd.toFixed(2)}`

**agents.ts** -- Extend the existing `AgentBoardData` interface and `getAgentBoardData()`:

Add to interface:
```typescript
contextPct: number | null;     // 0-100+, null if no recent call
contextModel: string | null;   // model from most recent call (for tooltip)
cacheHitRate: number | null;   // 0-100, null if no calls in 24h
cost24h: number;               // USD, 0 if no calls
```

Add three new queries inside the existing per-agent loop in `getAgentBoardData()` (after the existing token/error queries, using the same `obsDb` and `agentIds`/`placeholders` variables):

1. **Context window %** (most recent LLM call):
   ```sql
   SELECT model, input_tokens + cache_read_tokens + cache_write_tokens as total_context
   FROM llm_calls
   WHERE agent_id IN (placeholders)
   ORDER BY created_at DESC LIMIT 1
   ```
   Then: `contextPct = Math.min(100, Math.round((total_context / limit) * 100))` where limit comes from `MODEL_CONTEXT_LIMITS[model] ?? DEFAULT_CONTEXT_LIMIT`. **Do NOT cap at 100 in the number** -- only cap the progress bar width. Show actual % in text (e.g. "149%" is useful signal). So actually: `contextPct = Math.round((total_context / limit) * 100)`.

2. **Cache hit rate** (24h):
   ```sql
   SELECT sum(cache_read_tokens) as cache_read,
          sum(input_tokens + cache_read_tokens) as total_input
   FROM llm_calls
   WHERE agent_id IN (placeholders)
     AND created_at > datetime('now', '-24 hours')
   ```
   Then: `cacheHitRate = Math.round((cache_read / total_input) * 100)` only if `total_input > 0`, else null.

3. **24h cost**:
   ```sql
   SELECT sum(estimated_cost_usd) as cost
   FROM llm_calls
   WHERE agent_id IN (placeholders)
     AND created_at > datetime('now', '-24 hours')
   ```
   Then: `cost24h = row?.cost ?? 0`

Import MODEL_CONTEXT_LIMITS and DEFAULT_CONTEXT_LIMIT from constants.ts.

All three queries wrapped in try/catch (table may not exist pattern, matching existing error handling in the function).
  </action>
  <verify>
SSH to EC2, restart mission-control service, then curl http://100.72.143.9:3001/api/agents and verify:
1. Each agent object has contextPct, contextModel, cacheHitRate, cost24h fields
2. Bob (main) has non-null contextPct and high cacheHitRate (>90%)
3. Sage/Ezra have null contextPct and null cacheHitRate (no recent calls)
4. Bob cost24h is >$0
  </verify>
  <done>
/api/agents returns all 7 agents with contextPct, contextModel, cacheHitRate, and cost24h fields populated correctly from observability.db.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add context section to AgentCard component</name>
  <files>
    src/components/agents/agent-card.tsx
  </files>
  <action>
Extend the existing AgentCard component with a new "Context" section below the current token/model breakdown section.

Add a `border-t border-border pt-3` separator, then three rows in a `space-y-2` container:

**Row 1: Context Window Progress Bar**
- Label "Context" on left (text-xs text-muted-foreground)
- Percentage value on right with color from `getContextColor(agent.contextPct)`:
  - If contextPct is not null: show `${agent.contextPct}%`
  - If null: show em-dash "—"
- Below the label row (only if contextPct is not null): a Tailwind progress bar:
  - Outer: `h-1.5 w-full rounded-full bg-secondary`
  - Inner: `h-full rounded-full transition-all` with dynamic width `style={{ width: \`${Math.min(100, agent.contextPct)}%\` }}`
  - Bar color: `bg-rose-500` if >80, `bg-amber-500` if >60, else `bg-emerald-500`
  - Use `cn()` for conditional classes (already imported in the component)

**Row 2: Cache Hit Rate**
- Label "Cache" on left (text-xs text-muted-foreground)
- Value on right with color from `getCacheColor(agent.cacheHitRate)`:
  - If not null: `${agent.cacheHitRate}%`
  - If null: em-dash "—"

**Row 3: 24h Cost**
- Label "24h Cost" on left (text-xs text-muted-foreground)
- Value on right: `formatCost(agent.cost24h)` in text-foreground

Import getContextColor, getCacheColor, formatCost from utils.ts. The AgentCard already imports cn and other utilities from there.

Keep it compact -- these are secondary metrics below the primary status/token display.
  </action>
  <verify>
SSH to EC2, restart mission-control, then open http://100.72.143.9:3001/agents from a Tailscale device. Verify:
1. Each agent card shows the Context section below the existing token display
2. Bob's card has a colored progress bar with a percentage
3. Bob's card shows a cache hit rate (should be >99%)
4. Bob's card shows a non-zero cost
5. Sage/Ezra cards show em-dashes for context and cache (no data)
6. Progress bar color matches thresholds (green if <60%, amber 60-80%, red >80%)
  </verify>
  <done>
All 7 agent cards display context window %, cache hit rate, and 24h cost with correct coloring and null-state handling.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify context indicators on live dashboard</name>
  <files>src/components/agents/agent-card.tsx</files>
  <action>
Human verification of context usage indicators on live dashboard. Context usage indicators were added to all agent cards on /agents: progress bar for context window %, colored cache hit rate, and formatted 24h cost.
  </action>
  <verify>
1. Open http://100.72.143.9:3001/agents from any Tailscale device
2. Verify Bob's card shows:
   - A context window % with a colored progress bar
   - A cache hit rate percentage (likely >99%)
   - A 24h cost (e.g. "$6.81")
3. Verify Sage/Ezra cards show dashes (—) for context and cache (no recent activity)
4. Verify progress bar color: green if <60%, amber if 60-80%, red if >80%
5. Verify the new section appears below existing token counts, with a separator line
  </verify>
  <done>User confirms all context indicators render correctly on live Tailscale dashboard</done>
</task>

</tasks>

<verification>
1. curl http://100.72.143.9:3001/api/agents returns contextPct, cacheHitRate, cost24h for all 7 agents
2. Active agents (Bob, Scout, Vector, Sentinel) have non-null metrics
3. Inactive agents (Sage, Ezra) show null for context/cache and $0.00 for cost
4. No TypeScript compilation errors
5. Page loads without console errors
</verification>

<success_criteria>
1. /agents page shows context window utilization as colored progress bar on each agent card
2. Cache hit rate displayed as colored percentage text
3. 24h cost displayed as $X.XX
4. No new pages, routes, or dependencies added
5. Visual verification from Tailscale device confirms all indicators render correctly
</success_criteria>

<output>
After completion, create `.planning/phases/31.1-context-usage-indicators/31.1-01-SUMMARY.md`
</output>
