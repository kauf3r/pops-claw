---
phase: 27-email-domain-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/clawd/agents/main/email-config.json
  - /home/ubuntu/clawd/agents/main/WARMUP.md
  - /home/ubuntu/.openclaw/cron/jobs.json
autonomous: false
requirements: [EML-01, EML-02, EML-03]

must_haves:
  truths:
    - "dig TXT _dmarc.mail.andykaufman.net returns p=quarantine"
    - "SPF, DKIM, and DMARC records all resolve correctly via dig"
    - "Test email to personal Gmail lands in inbox (not spam) with SPF PASS + DKIM PASS + DMARC PASS"
    - "Morning briefing Section 9 reports bounce/complaint rates with two-tier thresholds (WARNING at 2%/0.08%, CRITICAL at 5%/0.1%)"
    - "email-config.json contains dmarc_escalated_at timestamp and phase29_gate config"
    - "Morning briefing reports Phase 29 readiness gate status (days remaining)"
    - "At least one rua aggregate report received within 48 hours post-escalation with no DMARC failures"
  artifacts:
    - path: "/home/ubuntu/clawd/agents/main/email-config.json"
      provides: "DMARC escalation timestamp and Phase 29 readiness gate config"
      contains: "dmarc_escalated_at"
    - path: "/home/ubuntu/clawd/agents/main/WARMUP.md"
      provides: "Completed warmup checklist with Steps 1-4 COMPLETE and Step 5 finalized after 48h rua confirmation"
      contains: "COMPLETE"
    - path: "/home/ubuntu/.openclaw/cron/jobs.json"
      provides: "Updated morning briefing with two-tier thresholds and readiness gate in Section 9"
      contains: "phase29_gate"
  key_links:
    - from: "email-config.json"
      to: "morning briefing Section 9"
      via: "Bob reads dmarc_escalated_at to calculate days since escalation"
      pattern: "dmarc_escalated_at.*phase29_gate"
    - from: "DMARC DNS record"
      to: "email deliverability"
      via: "p=quarantine policy enforced on unauthenticated mail"
      pattern: "p=quarantine"
---

<objective>
Execute domain warmup checklist, escalate DMARC from p=none to p=quarantine, and configure health monitoring with readiness gate for Phase 29.

Purpose: Production-grade email domain reputation is the prerequisite gate for subscriber sends in Phase 29. Without enforced DMARC, email deliverability cannot be trusted for audience distribution.
Output: Verified DMARC at p=quarantine, completed WARMUP.md checklist, updated morning briefing thresholds, readiness gate tracking in email-config.json.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-email-domain-hardening/27-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: DNS verification, warmup test emails, and monitoring threshold update</name>
  <files>
    /home/ubuntu/clawd/agents/main/email-config.json
    /home/ubuntu/.openclaw/cron/jobs.json
  </files>
  <action>
**Part A: DNS Verification (WARMUP.md Step 1)**

SSH to EC2 (100.72.143.9) and run all DNS verification checks:

```bash
# SPF
dig TXT send.mail.andykaufman.net +short

# DKIM (3 Resend selectors)
dig CNAME resend._domainkey.mail.andykaufman.net +short
dig CNAME resend2._domainkey.mail.andykaufman.net +short
dig CNAME resend3._domainkey.mail.andykaufman.net +short

# DMARC (current -- expect p=none)
dig TXT _dmarc.mail.andykaufman.net +short

# MX
dig MX send.mail.andykaufman.net +short
```

Also check Resend API domain status:
```bash
source ~/.openclaw/.env && curl -s -X GET 'https://api.resend.com/domains' \
  -H "Authorization: Bearer $RESEND_API_KEY" | python3 -m json.tool
```

Confirm: SPF includes amazonses.com, DKIM CNAMEs resolve to *.dkim.amazonses.com, DMARC exists with p=none, MX points to feedback-smtp.

**Part B: Send Warmup Test Emails (WARMUP.md Steps 2-3)**

From EC2, send test emails to both accounts:

```bash
source ~/.openclaw/.env
# To personal Gmail
curl -s -X POST 'https://api.resend.com/emails' \
  -H "Authorization: Bearer $RESEND_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "from": "Bob <bob@mail.andykaufman.net>",
    "to": ["theandykaufman@gmail.com"],
    "subject": "WARMUP Test - Inbox Placement Verification",
    "html": "<h2>Domain Warmup Test</h2><p>This is a test email to verify inbox placement for mail.andykaufman.net domain hardening (Phase 27).</p><p>Please check:<br>1. This arrived in INBOX (not spam)<br>2. Click Show Original and verify SPF: PASS, DKIM: PASS, DMARC: PASS<br>3. From name shows as Bob</p>"
  }'

# To AirSpace account
curl -s -X POST 'https://api.resend.com/emails' \
  -H "Authorization: Bearer $RESEND_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "from": "Bob <bob@mail.andykaufman.net>",
    "to": ["kaufman@airspaceintegration.com"],
    "subject": "WARMUP Test - Inbox Placement Verification",
    "html": "<h2>Domain Warmup Test</h2><p>This is a test email to verify inbox placement for mail.andykaufman.net domain hardening (Phase 27).</p><p>Please check:<br>1. This arrived in INBOX (not spam)<br>2. Click Show Original and verify SPF: PASS, DKIM: PASS</p>"
  }'
```

**Part C: Update Morning Briefing Section 9 Thresholds (EML-03)**

SSH to EC2 and edit the morning briefing cron in `~/.openclaw/cron/jobs.json`. Find the morning-briefing job and update Section 9 (Email Health Check) to use two-tier thresholds:

- WARNING tier (Resend account protection): bounce >=2% (min 10 outbound), complaint >=0.08% (min 20 outbound)
- CRITICAL tier (Phase 29 gate blocker): bounce >=5% (min 10 outbound), complaint >=0.1% (min 20 outbound)

Add readiness gate reporting to Section 9. The briefing should read `email-config.json`, check for `dmarc_escalated_at`, and calculate days since escalation:
- If not set: "Phase 29 Gate: NOT STARTED -- DMARC not yet escalated"
- If set and <7 days: "Phase 29 Gate: PENDING -- {N}/7 days ({remaining} remaining)"
- If set and >=7 days with clean metrics: "Phase 29 Gate: READY -- 7+ days clean at p=quarantine"

Keep minimum volume guards (10 outbound for bounce, 20 for complaint). The existing Section 9 SQL queries against email.db remain -- just update threshold language and add the gate status line.

**Part D: Add Readiness Gate Config to email-config.json**

SSH to EC2 and add these fields to `/home/ubuntu/clawd/agents/main/email-config.json`:

```json
"dmarc_policy": "none",
"phase29_gate": {
  "requires_days": 7,
  "bounce_threshold_pct": 5,
  "complaint_threshold_pct": 0.1
}
```

Note: `dmarc_escalated_at` is NOT added yet -- that happens in Task 3 after DNS propagation is confirmed. `dmarc_policy` starts as "none" (current state).

Restart the gateway service after jobs.json changes:
```bash
systemctl --user restart openclaw-gateway.service
```
  </action>
  <verify>
1. All dig commands return expected values (SPF includes amazonses.com, DKIM CNAMEs resolve, DMARC shows p=none, MX resolves)
2. Both test emails accepted by Resend API (HTTP 200 with id field in response)
3. `cat /home/ubuntu/clawd/agents/main/email-config.json | python3 -c "import json,sys; d=json.load(sys.stdin); assert 'phase29_gate' in d; print('OK')"` passes
4. Gateway service is running: `systemctl --user is-active openclaw-gateway.service` returns "active"
  </verify>
  <done>
DNS records verified clean (SPF, DKIM, DMARC, MX all resolving correctly). Test emails sent to both Gmail and AirSpace accounts. Morning briefing Section 9 updated with two-tier thresholds and readiness gate status. email-config.json has phase29_gate config. Gateway restarted with new briefing payload.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify inbox placement and update DMARC DNS record</name>
  <files>DNS records at andykaufman.net DNS provider (external)</files>
  <action>
**What was built:** DNS verification passed, test emails sent to personal Gmail (theandykaufman@gmail.com) and AirSpace (kaufman@airspaceintegration.com), morning briefing thresholds updated, readiness gate config added.

**Human verification steps:**

**Step 1: Check personal Gmail**
1. Open Gmail, find "WARMUP Test - Inbox Placement Verification" from Bob
2. Confirm it landed in INBOX (not spam)
3. Click the three dots menu > "Show original"
4. Verify: SPF: PASS, DKIM: PASS, DMARC: PASS

**Step 2: Check AirSpace email**
1. Open kaufman@airspaceintegration.com inbox
2. Find the same test email from Bob
3. Confirm inbox delivery (not spam)
4. If Google Workspace: check "Show original" for SPF/DKIM PASS

**Step 3: Update DMARC DNS record**
In your DNS provider for andykaufman.net, update or create:
- **Name:** `_dmarc.mail.andykaufman.net` (or `_dmarc.mail` depending on provider)
- **Type:** TXT
- **Value:** `v=DMARC1; p=quarantine; pct=100; rua=mailto:dmarc@andykaufman.net;`

If `dmarc@andykaufman.net` doesn't exist or is hard to set up, use `theandykaufman@gmail.com` instead as the rua address. Either way, set up a Gmail filter to auto-label DMARC reports.

**Step 4 (if using cross-domain rua at andykaufman.net):**
Also add this DNS record to authorize cross-domain DMARC reporting:
- **Name:** `mail.andykaufman.net._report._dmarc.andykaufman.net` (or `mail.andykaufman.net._report._dmarc` depending on provider)
- **Type:** TXT
- **Value:** `v=DMARC1`

**Step 5: Wait for DNS propagation**
After updating, wait a few minutes (typically fast, can take up to 24 hours). Then type "approved" with the rua address you used so the next task can verify propagation.
  </action>
  <verify>User confirms: (1) both test emails landed in inbox (not spam), (2) SPF/DKIM/DMARC show PASS in "Show original", (3) DMARC DNS record updated to p=quarantine</verify>
  <done>Inbox placement verified for both Gmail and AirSpace accounts. DMARC DNS record updated from p=none to p=quarantine with rua tag. Resume signal: "approved" with rua address used.</done>
</task>

<task type="auto">
  <name>Task 3: Post-escalation verification and readiness gate activation</name>
  <files>
    /home/ubuntu/clawd/agents/main/email-config.json
    /home/ubuntu/clawd/agents/main/WARMUP.md
  </files>
  <action>
**Part A: Verify DMARC Propagation**

SSH to EC2 and confirm the new DMARC record:
```bash
dig TXT _dmarc.mail.andykaufman.net +short
```
Expected output should contain `p=quarantine` and `pct=100` and `rua=mailto:...`.

If rua uses cross-domain address (e.g., `dmarc@andykaufman.net` for a DMARC record on `mail.andykaufman.net`), also verify:
```bash
dig TXT mail.andykaufman.net._report._dmarc.andykaufman.net +short
```
Expected: `v=DMARC1`

**Part B: Send Post-Escalation Test Email**

Send a test email immediately after confirming propagation:
```bash
source ~/.openclaw/.env
curl -s -X POST 'https://api.resend.com/emails' \
  -H "Authorization: Bearer $RESEND_API_KEY" \
  -H 'Content-Type: application/json' \
  -d '{
    "from": "Bob <bob@mail.andykaufman.net>",
    "to": ["theandykaufman@gmail.com"],
    "subject": "Post-DMARC Escalation Test",
    "html": "<p>Verifying inbox delivery after DMARC escalation to p=quarantine. If you see this in your inbox (not spam), the escalation is successful.</p>"
  }'
```

**Part C: Verify No Bounces in email.db**

Check email.db for any recent bounces or complaints:
```bash
sqlite3 /home/ubuntu/clawd/agents/main/email.db \
  "SELECT delivery_status, COUNT(*) FROM email_conversations WHERE created_at > datetime('now', '-1 hour') GROUP BY delivery_status;"
```

**Part D: Activate Readiness Gate**

Update email-config.json with the escalation timestamp and new policy:

```bash
python3 -c "
import json
from datetime import datetime, timezone

with open('/home/ubuntu/clawd/agents/main/email-config.json') as f:
    config = json.load(f)

config['dmarc_escalated_at'] = datetime.now(timezone.utc).isoformat()
config['dmarc_policy'] = 'quarantine'

with open('/home/ubuntu/clawd/agents/main/email-config.json', 'w') as f:
    json.dump(config, f, indent=2)

print(f'Escalation recorded at: {config[\"dmarc_escalated_at\"]}')
print(f'Policy: {config[\"dmarc_policy\"]}')
print(f'Phase 29 unblocks after 7 days: check morning briefing for gate status')
"
```

**Part E: Mark WARMUP.md Steps 1-4 Complete, Step 5 In Progress**

Read the current WARMUP.md on EC2 and update Steps 1-4 to show COMPLETE status with today's date. For Step 5 (DMARC escalation), mark it as "IN PROGRESS -- awaiting 48h rua confirmation" with today's date. The warmup checklist was deployed in Phase 22 with steps for DNS verification, authentication testing, inbox placement, monitoring, and DMARC escalation. Step 5 will be marked COMPLETE by Task 4 after human confirms rua aggregate reports arrived clean.

**Part F: Restart Gateway (if jobs.json was modified)**

Only needed if any cron config changed in this task. If email-config.json was the only change, no restart needed (Bob reads it at runtime).
  </action>
  <verify>
1. `dig TXT _dmarc.mail.andykaufman.net +short` returns record containing `p=quarantine`
2. Post-escalation test email API call returns HTTP 200 with id
3. `sqlite3 /home/ubuntu/clawd/agents/main/email.db "SELECT COUNT(*) FROM email_conversations WHERE delivery_status IN ('bounced','complained') AND created_at > datetime('now', '-1 hour');"` returns 0
4. `python3 -c "import json; d=json.load(open('/home/ubuntu/clawd/agents/main/email-config.json')); assert d.get('dmarc_escalated_at'); assert d.get('dmarc_policy')=='quarantine'; print('Gate active')"` prints "Gate active"
5. WARMUP.md shows Steps 1-4 marked COMPLETE and Step 5 marked "IN PROGRESS -- awaiting 48h rua confirmation"
  </verify>
  <done>
DMARC record propagated with p=quarantine. Post-escalation test email sent and accepted. No bounces or complaints in email.db. Readiness gate activated with escalation timestamp in email-config.json. WARMUP.md Steps 1-4 completed, Step 5 in progress pending 48h rua confirmation. Phase 29 will be unblocked after 7 days of clean metrics.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: 48-hour rua aggregate report confirmation</name>
  <files>
    /home/ubuntu/clawd/agents/main/WARMUP.md
  </files>
  <action>
**What was built:** DMARC escalated to p=quarantine, readiness gate activated, Steps 1-4 of WARMUP.md marked complete. Step 5 is pending 48-hour rua aggregate report confirmation per locked decision.

**Timing:** This checkpoint fires 48 hours after Task 3 completes. Do NOT attempt until at least 48 hours have elapsed since `dmarc_escalated_at` in email-config.json.

**Human verification steps:**

**Step 1: Confirm 48 hours have elapsed**
Check the escalation timestamp:
```bash
ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 \
  "python3 -c \"import json; d=json.load(open('/home/ubuntu/clawd/agents/main/email-config.json')); print('Escalated at:', d['dmarc_escalated_at'])\""
```
Verify at least 48 hours have passed since that timestamp.

**Step 2: Check rua inbox for aggregate reports**
1. Open the rua email inbox (the address you provided in Task 2 -- either dmarc@andykaufman.net or theandykaufman@gmail.com)
2. Search for DMARC aggregate reports (subject lines typically contain "Report Domain: mail.andykaufman.net" or similar XML attachment)
3. Confirm at least ONE aggregate report has arrived
4. Open the report (XML) and verify: no DMARC failures (dkim=pass, spf=pass, disposition=none or quarantine with 0 failure count)

**Step 3: Check morning briefing for clean metrics**
Review the most recent morning briefing (or run the Section 9 query manually) to confirm bounce and complaint rates are below WARNING thresholds (bounce <2%, complaint <0.08%).

**What to report:**
- Type "approved" if: at least one rua aggregate report arrived AND it shows no DMARC failures AND metrics are clean
- Type "issues: [description]" if: no reports arrived, reports show failures, or metrics are elevated

**On approval:** Claude will SSH to EC2 and mark WARMUP.md Step 5 as COMPLETE with the confirmation date.
  </action>
  <verify>User confirms: (1) 48 hours elapsed since DMARC escalation, (2) at least one rua aggregate report received with no DMARC failures, (3) bounce/complaint metrics are clean</verify>
  <done>48-hour rua monitoring period complete. At least one DMARC aggregate report received with no failures. WARMUP.md Step 5 marked COMPLETE. Domain warmup checklist fully finalized.</done>
</task>

</tasks>

<verification>
1. `dig TXT _dmarc.mail.andykaufman.net +short` — must contain `p=quarantine; pct=100; rua=mailto:`
2. `dig TXT send.mail.andykaufman.net +short` — SPF record resolves with amazonses.com
3. `dig CNAME resend._domainkey.mail.andykaufman.net +short` — DKIM resolves to *.dkim.amazonses.com
4. `cat /home/ubuntu/clawd/agents/main/email-config.json | python3 -c "import json,sys; d=json.load(sys.stdin); print(d['dmarc_escalated_at'], d['dmarc_policy'], d['phase29_gate'])"` — shows timestamp, quarantine, gate config
5. Morning briefing next run includes two-tier email health thresholds and Phase 29 gate status
6. No bounced or complained emails in email.db within the execution window
</verification>

<success_criteria>
- DMARC DNS record shows p=quarantine (verified via dig)
- WARMUP.md Steps 1-4 marked COMPLETE after Task 3; Step 5 marked COMPLETE after Task 4 (48h rua confirmation)
- Morning briefing Section 9 has two-tier thresholds (WARNING at 2%/0.08%, CRITICAL at 5%/0.1%) and readiness gate status
- email-config.json has dmarc_escalated_at timestamp and phase29_gate config
- Test emails delivered to inbox (not spam) both pre- and post-escalation
- At least one rua aggregate report received within 48 hours with no DMARC failures
- Phase 29 readiness gate starts its 7-day countdown
</success_criteria>

<output>
After completion, create `.planning/phases/27-email-domain-hardening/27-01-SUMMARY.md`
</output>
