---
phase: 23-email-integration-gap-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.openclaw/skills/resend-email/SKILL.md
  - /home/officernd/n8n-production/workflows/resend-inbound-relay.json
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "daily_send_count increments by exactly 1 per outbound email (not 2)"
    - "On-disk n8n workflow backup matches live workflow (11 nodes, env var token references)"
    - "Catch-up cron API endpoint (GET /emails/receiving) confirmed working and documented"
  artifacts:
    - path: "~/.openclaw/skills/resend-email/SKILL.md"
      provides: "Counter increment fix — Section 6 Step 8 removed, Section 9 is single source of truth"
      contains: "If the email send fails"
    - path: "/home/officernd/n8n-production/workflows/resend-inbound-relay.json"
      provides: "Updated on-disk backup matching live 11-node workflow"
  key_links:
    - from: "SKILL.md Section 9"
      to: "email-config.json daily_send_count"
      via: "Single increment after successful send"
      pattern: "daily_send_count.*\\+ 1"
    - from: "n8n POST nodes"
      to: "OPENCLAW_HOOKS_TOKEN env var"
      via: "$env reference in workflow JSON"
      pattern: "\\$env\\.OPENCLAW_HOOKS_TOKEN"
---

<objective>
Close 3 gaps identified in the v2.2 milestone audit: verify catch-up cron API endpoint, fix counter double-increment in SKILL.md, and update stale n8n workflow backup on VPS.

Purpose: Ensure email integration has no known bugs or stale artifacts before closing the v2.2 milestone.
Output: Fixed SKILL.md on EC2, updated workflow backup on VPS, verified API endpoint documented.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-email-integration-gap-closure/23-RESEARCH.md
@.planning/phases/23-email-integration-gap-closure/23-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix counter double-increment in SKILL.md</name>
  <files>~/.openclaw/skills/resend-email/SKILL.md (on EC2 100.72.143.9)</files>
  <action>
SSH to EC2 (100.72.143.9, key ~/.ssh/clawdbot-key.pem, user ubuntu).

Edit `~/.openclaw/skills/resend-email/SKILL.md` Section 6 to remove Step 8 ("Increment `daily_send_count` in the config"). This step is a duplicate — Section 9's "After successful send" block already increments both `daily_send_count` and `monthly_send_count` for ALL outbound email types (briefings, alerts, replies, ad-hoc).

Specific change in Section 6:
- BEFORE: Step 7 (reset daily_send_date), Step 8 (increment daily_send_count), Step 9 (error handling)
- AFTER: Step 7 (reset daily_send_date), Step 8 (error handling — renumbered from old Step 9)

Do NOT touch Section 9. Section 9's centralized increment is the correct single-source-of-truth pattern that handles all email types.

After editing, read back the modified section to confirm Step 8 now says "If the email send fails..." and there is no step mentioning "Increment daily_send_count".
  </action>
  <verify>
SSH to EC2 and grep SKILL.md for "Increment.*daily_send_count" — should return ZERO matches in Section 6. Section 9 should still contain the increment logic. Count total occurrences of "daily_send_count" increment instructions — should be exactly 1 (in Section 9 only).
  </verify>
  <done>Section 6 has no counter increment step. Section 9 remains the sole increment location. Step numbering in Section 6 is sequential with no gaps.</done>
</task>

<task type="auto">
  <name>Task 2: Update stale n8n workflow backup on VPS</name>
  <files>/home/officernd/n8n-production/workflows/resend-inbound-relay.json (on VPS 100.105.251.99)</files>
  <action>
SSH to VPS (100.105.251.99, user root).

The live n8n workflow in Postgres has 11 nodes (including delivery status routing with correct `$env.OPENCLAW_HOOKS_TOKEN` references). The on-disk backup is stale with only 8 nodes.

Export the live workflow to update the backup:
```bash
docker exec n8n sh -c "n8n export:workflow --id=1XwpGnGro0NYtOjE" > /home/officernd/n8n-production/workflows/resend-inbound-relay.json
```

After export, verify the backup:
1. Count nodes in the exported JSON — should be 11
2. Grep for `$env.OPENCLAW_HOOKS_TOKEN` — should appear in both POST node configurations
3. Grep for the hardcoded token value `982cbc4b` — should NOT appear anywhere in the file

No container restart needed. The live workflow is already correct; this only updates the on-disk backup for disaster recovery.
  </action>
  <verify>
On VPS: `cat /home/officernd/n8n-production/workflows/resend-inbound-relay.json | python3 -c "import sys,json; wf=json.load(sys.stdin); nodes=wf[0]['nodes'] if isinstance(wf,list) else wf['nodes']; print(f'Nodes: {len(nodes)}')"` should output "Nodes: 11". Also grep for `OPENCLAW_HOOKS_TOKEN` in the file — should find matches. Grep for `982cbc4b` — should find zero matches.
  </verify>
  <done>On-disk workflow backup matches live workflow: 11 nodes, both POST nodes reference `$env.OPENCLAW_HOOKS_TOKEN`, no hardcoded token values.</done>
</task>

<task type="auto">
  <name>Task 3: Verify catch-up cron API endpoint and document</name>
  <files>None modified (verification only)</files>
  <action>
SSH to EC2 (100.72.143.9, key ~/.ssh/clawdbot-key.pem, user ubuntu).

The milestone audit flagged the `GET /emails/receiving` endpoint as "unconfirmed." Research already confirmed it works via live API test. This task performs a final verification and documents the result.

1. Run the API call: `curl -s -X GET 'https://api.resend.com/emails/receiving?limit=2' -H "Authorization: Bearer $RESEND_API_KEY"` (RESEND_API_KEY is in the environment via ~/.openclaw/.env)
2. Confirm response contains `{"object":"list","has_more":...,"data":[...]}` structure
3. Confirm the email-catchup cron job in `~/.openclaw/cron/jobs.json` uses this same endpoint
4. No code changes needed — endpoint is correct as-is

This task produces verification output only. The SUMMARY will document this as "confirmed working, no change needed."
  </action>
  <verify>
The curl command returns HTTP 200 with a valid JSON response containing `object`, `has_more`, and `data` fields. The `data` array contains email objects with `id`, `from`, `to`, `subject`, `created_at` fields.
  </verify>
  <done>Catch-up cron API endpoint (`GET /emails/receiving`) verified working against live Resend API. Endpoint matches jobs.json cron definition. No code change required.</done>
</task>

</tasks>

<verification>
All three gaps verified independently:
1. SKILL.md Section 6 has no counter increment; Section 9 is the sole increment location
2. On-disk n8n workflow backup has 11 nodes with env var token references (no hardcoded tokens)
3. Catch-up cron API endpoint returns valid data from Resend API
</verification>

<success_criteria>
- `daily_send_count` will increment by exactly 1 (not 2) per outbound email
- n8n on-disk backup matches live workflow for disaster recovery
- All 3 v2.2 milestone audit gaps are closed
</success_criteria>

<output>
After completion, create `.planning/phases/23-email-integration-gap-closure/23-01-SUMMARY.md`
</output>
