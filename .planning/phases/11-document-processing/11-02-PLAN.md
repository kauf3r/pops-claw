---
phase: 11-document-processing
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified:
  - /home/ubuntu/.openclaw/cron/jobs.json
  - /home/ubuntu/clawd/agents/main/EXPENSE_SUMMARY.md
autonomous: false

must_haves:
  truths:
    - "A monthly cron job generates an expense summary from the receipts table"
    - "The expense summary includes total spending, category breakdown, and top merchants"
    - "Bob can scan a receipt photo shared in Slack and store the extracted data"
    - "Stored receipts are queryable and the monthly summary reflects real data"
  artifacts:
    - path: "/home/ubuntu/clawd/agents/main/EXPENSE_SUMMARY.md"
      provides: "Reference doc for monthly expense summary cron with SQL queries and formatting"
    - path: "/home/ubuntu/.openclaw/cron/jobs.json"
      provides: "monthly-expense-summary cron entry"
  key_links:
    - from: "cron/jobs.json (monthly-expense-summary)"
      to: "EXPENSE_SUMMARY.md"
      via: "systemEvent text references EXPENSE_SUMMARY.md for full instructions"
    - from: "EXPENSE_SUMMARY.md"
      to: "SQLite receipts table in health.db"
      via: "SQL queries against /home/ubuntu/clawd/agents/main/health.db"
      pattern: "receipts"
    - from: "EXPENSE_SUMMARY.md"
      to: "Slack DM D0AARQR0Y4V"
      via: "Agent sends formatted expense summary to Andy's DM"
---

<objective>
Create the monthly expense summary cron job and verify end-to-end receipt scanning workflow.

Purpose: Bob generates a monthly spending summary on the 1st of each month, and the full receipt workflow (photo -> extraction -> storage -> query) works end-to-end.

Output: EXPENSE_SUMMARY.md reference doc + monthly-expense-summary cron job on EC2, verified receipt scanning via Slack.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-document-processing/11-01-SUMMARY.md
@.planning/phases/03-daily-briefing-rate-limits/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EXPENSE_SUMMARY.md reference doc and monthly-expense-summary cron job</name>
  <files>/home/ubuntu/clawd/agents/main/EXPENSE_SUMMARY.md, /home/ubuntu/.openclaw/cron/jobs.json</files>
  <action>
SSH to EC2 (ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9).

**Part A: Create EXPENSE_SUMMARY.md**

Write ~/clawd/agents/main/EXPENSE_SUMMARY.md via scp or tee (NOT heredoc over SSH). Contents:

## 1. Monthly Expense Summary

Generate a spending summary for the PREVIOUS month (not current month). Run on the 1st of each month.

Determine previous month date range:
- If today is 2026-03-01, summarize February 2026
- Start date: first day of previous month
- End date: last day of previous month

## 2. Queries

Run these against /home/ubuntu/clawd/agents/main/health.db (NOTE: cron runs in embedded mode, use HOST paths, NOT /workspace/):

a) Total spending:
```sql
SELECT printf('$%.2f', COALESCE(SUM(total), 0)) as total, COUNT(*) as receipt_count
FROM receipts
WHERE date >= date('now', 'start of month', '-1 month')
  AND date < date('now', 'start of month');
```

b) Category breakdown:
```sql
SELECT category,
       COUNT(*) as count,
       printf('$%.2f', SUM(total)) as total,
       printf('%.1f%%', 100.0 * SUM(total) / (SELECT SUM(total) FROM receipts WHERE date >= date('now', 'start of month', '-1 month') AND date < date('now', 'start of month'))) as pct
FROM receipts
WHERE date >= date('now', 'start of month', '-1 month')
  AND date < date('now', 'start of month')
GROUP BY category
ORDER BY SUM(total) DESC;
```

c) Top 5 merchants:
```sql
SELECT merchant, COUNT(*) as visits, printf('$%.2f', SUM(total)) as total
FROM receipts
WHERE date >= date('now', 'start of month', '-1 month')
  AND date < date('now', 'start of month')
GROUP BY merchant
ORDER BY SUM(total) DESC
LIMIT 5;
```

d) Daily average:
```sql
SELECT printf('$%.2f', COALESCE(SUM(total), 0) * 1.0 / (julianday(date('now', 'start of month')) - julianday(date('now', 'start of month', '-1 month')))) as daily_avg
FROM receipts
WHERE date >= date('now', 'start of month', '-1 month')
  AND date < date('now', 'start of month');
```

e) Largest single expense:
```sql
SELECT date, merchant, printf('$%.2f', total) as total, category
FROM receipts
WHERE date >= date('now', 'start of month', '-1 month')
  AND date < date('now', 'start of month')
ORDER BY total DESC
LIMIT 1;
```

## 3. Formatting

Format the summary for Slack DM to Andy (D0AARQR0Y4V):

```
Monthly Expense Summary - {Month Year}

Total: ${total} across {count} receipts
Daily average: ${daily_avg}

Category Breakdown:
- {category}: ${total} ({pct}%) - {count} receipts
- ...

Top Merchants:
1. {merchant}: ${total} ({visits} visits)
2. ...

Biggest Expense: {merchant} on {date} - ${total} ({category})
```

## 4. Edge Cases

- If NO receipts for previous month: send "No receipts recorded for {Month}. Start scanning receipts by sharing photos in our chat!"
- If only 1-2 receipts: still generate full summary but note "Limited data - only {N} receipts recorded"
- Round all dollar amounts to 2 decimal places

## 5. Important Notes

CRITICAL: This runs in embedded mode (cron). Use HOST paths:
- Database: /home/ubuntu/clawd/agents/main/health.db
- Do NOT use /workspace/ paths -- those only work inside Docker sandbox
- Use sqlite3 CLI or python3 for queries (both available on host)

**Part B: Create the cron job**

Add the monthly expense summary cron via direct jobs.json edit (established pattern from Phase 8-9):

Read current jobs.json, add new entry:
```json
{
  "id": "<generate-uuid>",
  "name": "monthly-expense-summary",
  "schedule": { "expr": "0 15 1 * *" },
  "agentId": "main",
  "sessionTarget": "isolated",
  "wakeMode": "now",
  "payload": {
    "kind": "systemEvent",
    "text": "Read /home/ubuntu/clawd/agents/main/EXPENSE_SUMMARY.md and follow its instructions to generate and send the monthly expense summary for last month to Andy's Slack DM."
  }
}
```

Schedule: `0 15 1 * *` = 3 PM UTC on the 1st of each month = 7 AM PT (matching morning briefing time). Use `isolated` sessionTarget for clean context.

Generate UUID via: `python3 -c "import uuid; print(str(uuid.uuid4()))"`

After adding to jobs.json, restart the gateway to pick up the new cron:
```bash
systemctl --user restart openclaw-gateway.service
```

Verify:
1. `systemctl --user status openclaw-gateway.service` shows active
2. `/home/ubuntu/.npm-global/bin/openclaw cron list` shows monthly-expense-summary
  </action>
  <verify>
- EXPENSE_SUMMARY.md exists at ~/clawd/agents/main/ with all 5 sections
- `openclaw cron list | grep monthly-expense` shows the cron job
- Gateway is running after restart
- jobs.json contains the monthly-expense-summary entry with correct schedule (0 15 1 * *)
  </verify>
  <done>EXPENSE_SUMMARY.md deployed with monthly query templates. Cron job fires 1st of each month at 7 AM PT, generates category breakdown and top merchant summary, sends to Slack DM.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify end-to-end receipt scanning and expense tracking</name>
  <files>n/a (verification only)</files>
  <action>
Human verification of the complete receipt scanning and expense tracking system:
1. receipt-scanner SKILL.md with vision-based extraction workflow
2. receipts SQLite table in health.db
3. monthly-expense-summary cron job

Bob should now be able to process receipt photos and track expenses.

Verification steps:
1. Open Slack and share a receipt photo with Bob (any receipt -- grocery, restaurant, etc.)
2. Bob should:
   - Analyze the image using built-in vision
   - Extract merchant, date, amount, tax, total, category
   - Present the extracted data for confirmation
   - On your approval, store it in the receipts table
3. After Bob confirms storage, verify on EC2:
   ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 "sqlite3 ~/clawd/agents/main/health.db 'SELECT id, date, merchant, total, category FROM receipts ORDER BY id DESC LIMIT 5;'"
4. Ask Bob: "How much have I spent this month?" -- should query receipts table and answer
5. Verify cron exists:
   ssh ... "/home/ubuntu/.npm-global/bin/openclaw cron list | grep monthly-expense"

If Bob can't see the receipt-scanner skill, start a fresh session (new Slack channel or restart gateway).
If Bob has trouble with the image, try "Log a receipt: Target, $48.85, today, shopping" for manual entry.
  </action>
  <verify>
- Bob extracts structured data from a receipt photo
- Receipt row appears in SQLite receipts table
- Bob answers spending query from receipts data
- monthly-expense-summary cron shows in cron list
  </verify>
  <done>All 4 DP requirements verified: DP-01 (SKILL.md), DP-02 (photo extraction), DP-03 (SQLite storage), DP-04 (monthly cron). Human approved.</done>
</task>

</tasks>

<verification>
Phase 11 full requirements check:
- DP-01: receipt-scanner SKILL.md exists at ~/.openclaw/skills/receipt-scanner/SKILL.md
- DP-02: SKILL.md documents photo -> extract merchant, amount, date, category using built-in vision
- DP-03: receipts table exists in health.db, SKILL.md has INSERT template using sqlite3
- DP-04: monthly-expense-summary cron fires 1st of month, queries receipts, sends summary to Slack DM
</verification>

<success_criteria>
1. Bob processes a receipt photo end-to-end (extract -> confirm -> store)
2. Receipt data appears in SQLite receipts table
3. monthly-expense-summary cron registered and shows in cron list
4. EXPENSE_SUMMARY.md has correct SQL queries with host paths (embedded mode)
5. Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-processing/11-02-SUMMARY.md`
</output>
