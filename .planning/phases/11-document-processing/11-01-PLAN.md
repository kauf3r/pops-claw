---
phase: 11-document-processing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/.openclaw/skills/receipt-scanner/SKILL.md
  - /home/ubuntu/clawd/agents/main/health.db
autonomous: true

must_haves:
  truths:
    - "Bob can receive a receipt photo in Slack and extract merchant, amount, date, and category"
    - "Bob stores extracted receipt data in a SQLite receipts table"
    - "Receipts are queryable by date range, merchant, or category"
    - "Bob can handle manual receipt entry when photo quality is poor"
  artifacts:
    - path: "/home/ubuntu/.openclaw/skills/receipt-scanner/SKILL.md"
      provides: "Receipt scanning skill with vision-based extraction and SQLite storage workflow"
      min_lines: 120
    - path: "/home/ubuntu/clawd/agents/main/health.db"
      provides: "receipts table in existing health.db"
      contains: "CREATE TABLE receipts"
  key_links:
    - from: "/home/ubuntu/.openclaw/skills/receipt-scanner/SKILL.md"
      to: "OpenClaw built-in vision"
      via: "Agent sees Slack images natively; SKILL.md teaches extraction workflow"
      pattern: "receipt"
    - from: "SKILL.md receipt extraction workflow"
      to: "SQLite receipts table"
      via: "sqlite3 CLI INSERT into /workspace/health.db receipts table"
      pattern: "INSERT INTO receipts"
---

<objective>
Create the receipt-scanner skill and SQLite receipts table for receipt photo extraction and expense storage.

Purpose: Bob can receive receipt photos in Slack, use built-in vision to extract merchant/amount/date/category, and store structured data in SQLite for expense tracking.

Output: Working SKILL.md on EC2, receipts table in health.db, Bob able to process receipt photos on demand.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-oura-ring-integration/02-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create receipts table in health.db and receipt-scanner skill directory</name>
  <files>/home/ubuntu/clawd/agents/main/health.db, /home/ubuntu/.openclaw/skills/receipt-scanner/</files>
  <action>
SSH to EC2 (ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9).

1. Create the receipts table in existing health.db (reuse existing DB -- established pattern from Phase 2):

```sql
CREATE TABLE IF NOT EXISTS receipts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  date TEXT NOT NULL,
  merchant TEXT NOT NULL,
  amount REAL NOT NULL,
  currency TEXT DEFAULT 'USD',
  category TEXT,
  subcategory TEXT,
  payment_method TEXT,
  description TEXT,
  tax REAL,
  tip REAL,
  total REAL,
  items_json TEXT,
  notes TEXT,
  source TEXT DEFAULT 'photo',
  slack_ts TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX IF NOT EXISTS idx_receipts_date ON receipts(date);
CREATE INDEX IF NOT EXISTS idx_receipts_merchant ON receipts(merchant);
CREATE INDEX IF NOT EXISTS idx_receipts_category ON receipts(category);
```

Run via ssh: `ssh ... "sqlite3 ~/clawd/agents/main/health.db '<SQL>'"` or use python3 for multi-statement.

Columns explained:
- date: receipt date (YYYY-MM-DD)
- merchant: store/vendor name
- amount: subtotal before tax/tip
- currency: defaults USD
- category: top-level (groceries, dining, transport, utilities, shopping, health, entertainment, subscriptions, other)
- subcategory: optional refinement (e.g. "coffee" under dining)
- payment_method: cash/credit/debit/venmo etc
- description: brief note about purchase
- tax/tip: separated for tracking
- total: amount + tax + tip (computed by agent)
- items_json: JSON array of line items if visible on receipt
- notes: any extra context
- source: "photo" (default), "manual", "email"
- slack_ts: Slack message timestamp for reference back to original photo

2. Create skill directory:
```bash
ssh ... "mkdir -p ~/.openclaw/skills/receipt-scanner"
```

3. Verify table:
```bash
ssh ... "sqlite3 ~/clawd/agents/main/health.db '.schema receipts'"
```
Should show the full CREATE TABLE statement.
  </action>
  <verify>
- `sqlite3 ~/clawd/agents/main/health.db '.schema receipts'` shows full table with all columns
- `sqlite3 ~/clawd/agents/main/health.db '.indexes receipts'` shows 3 indexes
- `ls -d ~/.openclaw/skills/receipt-scanner/` exists
  </verify>
  <done>receipts table created in health.db with indexes for date/merchant/category lookup. Skill directory created.</done>
</task>

<task type="auto">
  <name>Task 2: Create receipt-scanner SKILL.md with vision extraction and storage workflow</name>
  <files>/home/ubuntu/.openclaw/skills/receipt-scanner/SKILL.md</files>
  <action>
SSH to EC2. Write SKILL.md to ~/.openclaw/skills/receipt-scanner/SKILL.md via scp (write locally first, then scp) or tee. Do NOT use heredoc over SSH (causes hangs -- see lessons learned).

The skill must contain these sections:

**Frontmatter (YAML):**
```yaml
---
name: receipt-scanner
description: Scan receipt photos, extract expense data, and track spending in SQLite
---
```

**Section 1: Overview**
- Purpose: Process receipt photos shared in Slack, extract structured data using vision, store in SQLite
- Bob has built-in vision -- when a user shares a photo in Slack, Bob can see it directly
- No external OCR API needed; Claude's vision capabilities handle receipt reading
- Supports photo receipts, manual entry, and corrections

**Section 2: Receipt Photo Processing Workflow**
When a user shares a receipt photo (or asks to log a receipt):
1. Look at the image carefully and extract:
   - **Merchant/store name** (from header/logo)
   - **Date** (from receipt date, NOT today's date unless receipt date unreadable)
   - **Subtotal** (pre-tax amount)
   - **Tax** (if shown)
   - **Tip** (if applicable, e.g. restaurants)
   - **Total** (final amount charged)
   - **Line items** (if legible, as JSON array: `[{"item": "name", "qty": 1, "price": 5.99}]`)
   - **Payment method** (if shown: last 4 digits of card, cash, etc.)
2. Infer **category** from merchant type:
   - Grocery stores -> "groceries"
   - Restaurants/cafes/bars -> "dining"
   - Gas stations -> "transport"
   - Amazon/retail -> "shopping"
   - Pharmacy/doctor -> "health"
   - Electric/water/internet -> "utilities"
   - Netflix/Spotify/subscriptions -> "subscriptions"
   - Movie theaters/concerts -> "entertainment"
   - If unclear -> "other"
3. Present extracted data to user for confirmation BEFORE storing:
   ```
   Receipt extracted:
   - Merchant: Target
   - Date: 2026-02-08
   - Subtotal: $45.23
   - Tax: $3.62
   - Total: $48.85
   - Category: shopping
   - Items: 5 items detected

   Shall I save this? (or correct any fields)
   ```
4. On confirmation, store via sqlite3 CLI (see Section 4)

**Section 3: Manual Receipt Entry**
If photo quality is poor or user wants to log without a photo:
- Ask for: merchant, amount, date (default today), category (suggest based on merchant)
- All other fields optional
- Set source = "manual"

**Section 4: SQLite Storage**
Database: /workspace/health.db (inside sandbox)
Table: receipts

INSERT command template:
```bash
sqlite3 /workspace/health.db "INSERT INTO receipts (date, merchant, amount, currency, category, subcategory, payment_method, description, tax, tip, total, items_json, notes, source, slack_ts) VALUES ('YYYY-MM-DD', 'Merchant Name', 45.23, 'USD', 'shopping', NULL, 'credit', 'Weekly shopping', 3.62, 0, 48.85, '[{\"item\":\"paper towels\",\"qty\":1,\"price\":8.99}]', NULL, 'photo', 'msg_ts');"
```

For the slack_ts field: use the Slack message timestamp of the photo message if available, NULL otherwise.

**Section 5: Querying Receipts**
Provide these ready-to-use queries:

a) Recent receipts (last 7 days):
```sql
SELECT date, merchant, total, category FROM receipts WHERE date >= date('now', '-7 days') ORDER BY date DESC;
```

b) Spending by category (current month):
```sql
SELECT category, COUNT(*) as count, printf('$%.2f', SUM(total)) as total FROM receipts WHERE date >= date('now', 'start of month') GROUP BY category ORDER BY SUM(total) DESC;
```

c) Monthly spending total:
```sql
SELECT printf('$%.2f', SUM(total)) as month_total, COUNT(*) as receipt_count FROM receipts WHERE date >= date('now', 'start of month');
```

d) Search by merchant:
```sql
SELECT date, merchant, total, category FROM receipts WHERE merchant LIKE '%search_term%' ORDER BY date DESC;
```

e) Top merchants (last 30 days):
```sql
SELECT merchant, COUNT(*) as visits, printf('$%.2f', SUM(total)) as total FROM receipts WHERE date >= date('now', '-30 days') GROUP BY merchant ORDER BY SUM(total) DESC LIMIT 10;
```

**Section 6: Category Reference**
| Category | Examples |
|----------|----------|
| groceries | Safeway, Trader Joe's, Whole Foods, Costco |
| dining | Restaurants, cafes, bars, food delivery |
| transport | Gas, Uber, parking, tolls, car maintenance |
| utilities | Electric, water, internet, phone |
| shopping | Amazon, Target, clothing, electronics |
| health | Pharmacy, doctor, dentist, gym |
| entertainment | Movies, concerts, games, streaming |
| subscriptions | Netflix, Spotify, SaaS tools, memberships |
| other | Anything that doesn't fit above |

User can create custom categories -- just use any string.

**Section 7: Corrections and Updates**
If user says data is wrong after saving:
```sql
UPDATE receipts SET merchant='Correct Name', amount=50.00 WHERE id=<id>;
```
Always confirm the receipt ID before updating. Show the record first:
```sql
SELECT * FROM receipts WHERE id=<id>;
```

**Section 8: Error Handling**
- Blurry/unreadable receipt: Ask user to re-share or offer manual entry
- Duplicate detection: Before INSERT, check `SELECT id FROM receipts WHERE date='...' AND merchant='...' AND total=...` -- if match found, warn user and ask if it's a duplicate
- Missing fields: Only date, merchant, and amount are required. All others optional.
- Currency: Default USD. If receipt shows different currency, store that currency and note in description.

**Section 9: Tips**
- Best results with well-lit, flat receipt photos
- Itemized receipts give richer data than summary totals
- For recurring expenses (subscriptions), suggest user note in description
- When in doubt about category, ask the user

Verify the skill is detected:
  ssh ... "/home/ubuntu/.npm-global/bin/openclaw skills list"
Should show receipt-scanner in the list.
  </action>
  <verify>
- SKILL.md exists at ~/.openclaw/skills/receipt-scanner/SKILL.md
- File is >120 lines with all 9 sections
- Frontmatter has name and description
- `openclaw skills list` shows receipt-scanner skill
  </verify>
  <done>Receipt-scanner SKILL.md deployed with vision-based extraction workflow, SQLite storage, query templates, category inference, manual entry fallback, and error handling. Skill detected by OpenClaw.</done>
</task>

</tasks>

<verification>
Phase 11 partial requirements check:
- DP-01: SKILL.md exists at ~/.openclaw/skills/receipt-scanner/SKILL.md with frontmatter
- DP-02: SKILL.md documents photo -> extract merchant, amount, date, category workflow using built-in vision
- DP-03: receipts table exists in health.db with INSERT template in SKILL.md; sqlite3 pre-approved for exec
</verification>

<success_criteria>
1. receipts table in health.db with indexes
2. receipt-scanner SKILL.md deployed with 9 sections covering extraction, storage, queries
3. Skill appears in `openclaw skills list`
4. No gateway restart needed (skills are detected on next agent session)
</success_criteria>

<output>
After completion, create `.planning/phases/11-document-processing/11-01-SUMMARY.md`
</output>
