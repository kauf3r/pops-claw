---
phase: 06-multi-agent-gateway
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.openclaw/openclaw.json.bak-YYYYMMDD
  - ~/clawd/agents/main/HEARTBEAT.md
  - ~/clawd/agents/landos/HEARTBEAT.md
  - ~/clawd/agents/rangeos/HEARTBEAT.md
  - ~/clawd/agents/ops/HEARTBEAT.md
autonomous: true

must_haves:
  truths:
    - "openclaw.json has a timestamped backup on EC2"
    - "All 4 agent routes exist in agents.list (main, landos, rangeos, ops)"
    - "coordination.db has 3 tables (agent_tasks, agent_messages, agent_activity) with indexes"
    - "coordination.db is accessible at /workspace/coordination.db inside each agent's sandbox"
    - "HEARTBEAT.md SQL queries use correct column names matching actual schema"
  artifacts:
    - path: "~/.openclaw/openclaw.json.bak-YYYYMMDD"
      provides: "Config backup before any modifications"
    - path: "~/clawd/coordination.db"
      provides: "Shared coordination database with 3 tables"
      contains: "agent_tasks, agent_messages, agent_activity"
    - path: "~/clawd/agents/main/HEARTBEAT.md"
      provides: "Andy heartbeat instructions with correct SQL"
    - path: "~/clawd/agents/ops/HEARTBEAT.md"
      provides: "Sentinel heartbeat instructions with correct SQL"
  key_links:
    - from: "coordination.db symlinks in each agent workspace"
      to: "~/clawd/coordination.db"
      via: "filesystem symlink"
      pattern: "coordination.db -> /home/ubuntu/clawd/coordination.db"
    - from: "HEARTBEAT.md SQL queries"
      to: "coordination.db schema"
      via: "column names: body (not message) in agent_messages"
      pattern: "SELECT.*body.*FROM agent_messages"
---

<objective>
Backup config, verify existing multi-agent infrastructure, and fix known issues in coordination DB access and agent workspace documentation.

Purpose: v1 workspace setup (Feb 1) already created all 4 agents, coordination DB, heartbeat crons, and Slack bindings. This plan validates that infrastructure, creates a formal backup, and fixes the SQL column mismatch found in gateway logs (agents query `message` column but schema has `body`).

Output: Verified multi-agent gateway with correct coordination DB access from all agent sandboxes.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Backup openclaw.json and verify 4-agent gateway config</name>
  <files>~/.openclaw/openclaw.json.bak-YYYYMMDD</files>
  <action>
SSH to EC2 (100.72.143.9) and:

1. Create timestamped backup:
   ```
   cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.bak-$(date +%Y%m%d)
   ```

2. Verify agents.list has exactly 4 entries with correct structure:
   ```
   jq '.agents.list[] | {id, name, workspace}' ~/.openclaw/openclaw.json
   ```
   Expected: main/Bob, landos/Scout, rangeos/Vector, ops/Sentinel

3. Verify bindings array maps 4 Slack channels to 4 agents:
   ```
   jq '.bindings[] | {agentId, channelId: .match.peer.id}' ~/.openclaw/openclaw.json
   ```
   Expected: main->C0AD48J8CQY, landos->C0AD4842LJC, rangeos->C0AC3HB82P5, ops->C0AD485E50Q

4. Verify Slack channels config includes all 4 channels:
   ```
   jq '.channels.slack.channels' ~/.openclaw/openclaw.json
   ```
   Expected: #popsclaw, #land-ops, #range-ops, #ops all with allow:true

5. Verify heartbeat crons exist with staggered offsets:
   ```
   jq '.jobs[] | select(.name | test("heartbeat")) | {id, name, schedule: .schedule.expr}' ~/.openclaw/cron/jobs.json
   ```
   Expected: main at :00/:15/:30/:45, landos at :02/:17/:32/:47, rangeos at :04/:19/:34/:49, ops at :06/:21/:36/:51

All of the above should already be in place from v1 setup. This task is verification + backup, not creation.
  </action>
  <verify>
- File ~/.openclaw/openclaw.json.bak-YYYYMMDD exists
- jq '.agents.list | length' returns 4
- jq '.bindings | length' returns 4
- Heartbeat cron count is 4 (plus daily-heartbeat = 5 heartbeat entries)
  </verify>
  <done>
Timestamped backup exists. Config confirmed to have 4 agent routes, 4 Slack bindings, 4 channel allowlists, and 4 staggered heartbeat crons.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify coordination DB schema and fix agent HEARTBEAT.md SQL</name>
  <files>
~/clawd/agents/main/HEARTBEAT.md
~/clawd/agents/landos/HEARTBEAT.md
~/clawd/agents/rangeos/HEARTBEAT.md
~/clawd/agents/ops/HEARTBEAT.md
  </files>
  <action>
SSH to EC2 (100.72.143.9) and:

1. Verify coordination.db has correct schema:
   ```
   sqlite3 ~/clawd/coordination.db ".schema"
   ```
   Expected tables: agent_tasks, agent_messages, agent_activity
   Expected indexes: idx_tasks_agent, idx_tasks_status, idx_messages_to, idx_messages_unread, idx_activity_agent, idx_activity_created

2. Verify symlinks from each agent workspace resolve:
   ```
   for agent in main landos rangeos ops; do
     readlink ~/clawd/agents/$agent/coordination.db
     sqlite3 ~/clawd/agents/$agent/coordination.db "SELECT count(*) FROM agent_messages;"
   done
   ```

3. Fix HEARTBEAT.md SQL column mismatch in ALL 4 agent workspaces.
   The actual schema has column `body` in agent_messages, but agents have been querying `message`.
   Gateway log confirms: `no such column: message` error.

   For each agent's HEARTBEAT.md, verify the SQL queries use correct column names:
   - agent_messages columns: id, from_agent, to_agent, message_type, subject, body, read_at, created_at
   - agent_tasks columns: id, agent_id, title, status, priority, beads_issue_id, created_at, updated_at
   - agent_activity columns: id, agent_id, activity_type, summary, created_at

   The current HEARTBEAT.md files use `SELECT *` which works fine, but any named-column queries in the docs or that agents infer should use `body` not `message`.

   Review each HEARTBEAT.md. If any explicitly reference `message` as a column name, fix to `body`. The main issue is that agents interpret `SELECT *` and then try to reference columns by guessed names. Add an explicit schema reference comment at the top of each HEARTBEAT.md:
   ```
   ## Coordination DB Schema Reference
   - agent_messages: id, from_agent, to_agent, message_type, subject, body, read_at, created_at
   - agent_tasks: id, agent_id, title, status, priority, beads_issue_id, created_at, updated_at
   - agent_activity: id, agent_id, activity_type, summary, created_at
   ```

4. Verify coordination.db is accessible from sandbox. Each agent workspace is bind-mounted at /workspace/ in Docker. The symlink `coordination.db -> /home/ubuntu/clawd/coordination.db` needs to resolve. Since Docker follows symlinks on bind-mount, and the target `/home/ubuntu/clawd/coordination.db` is the parent of the workspace dir, Docker may NOT follow the symlink.

   Test: Start a quick sandbox check by having the agent query coordination.db. If symlinks don't work from sandbox, need to change strategy to bind-mount coordination.db directly.

   If symlink doesn't resolve in sandbox, fix by adding a bind-mount in openclaw.json:
   ```
   agents.defaults.sandbox.docker.binds += "/home/ubuntu/clawd/coordination.db:/workspace/coordination.db:rw"
   ```
   Then restart gateway.

   Note: Each agent has its OWN workspace mounted at /workspace/, so the symlink target is OUTSIDE the mount. This likely means the symlink WILL NOT resolve in sandbox. The bind-mount fix is almost certainly needed.
  </action>
  <verify>
- `sqlite3 ~/clawd/coordination.db ".tables"` shows all 3 tables
- All 4 agent symlinks resolve on host
- Each HEARTBEAT.md has schema reference section with correct column names
- From sandbox, `sqlite3 /workspace/coordination.db "SELECT count(*) FROM agent_messages"` succeeds
  </verify>
  <done>
Coordination DB verified with correct schema. All HEARTBEAT.md files updated with explicit schema reference. Coordination DB accessible from inside Docker sandbox (either via working symlink or bind-mount fix).
  </done>
</task>

</tasks>

<verification>
1. `ls ~/.openclaw/openclaw.json.bak-*` shows today's backup
2. `jq '.agents.list | length' ~/.openclaw/openclaw.json` returns 4
3. `sqlite3 ~/clawd/coordination.db ".tables"` returns 3 tables
4. All 4 HEARTBEAT.md files contain "Coordination DB Schema Reference" section
5. `grep -l "body" ~/clawd/agents/*/HEARTBEAT.md` matches all 4 agents
6. Coordination DB queries succeed from agent sandbox
</verification>

<success_criteria>
- MA-01: openclaw.json backup exists with timestamp
- MA-02: 4 agent routes verified in config (already existed)
- MA-03: 3 coordination tables verified with indexes (already existed)
- MA-04: 4 staggered heartbeat crons verified (already existed)
- MA-05: 4 Slack channel bindings verified (already existed)
- Bonus: SQL column mismatch fixed, schema reference added to all agent docs
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-agent-gateway/06-01-SUMMARY.md`
</output>
