---
phase: 06-multi-agent-gateway
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - ~/.openclaw/openclaw.json
autonomous: false

must_haves:
  truths:
    - "Gateway service restarts successfully with multi-agent config"
    - "All 4 agents respond to heartbeat within one 15-minute cycle"
    - "Slack messages in #land-ops route to Scout (landos)"
    - "Slack messages in #range-ops route to Vector (rangeos)"
    - "Slack messages in #ops route to Sentinel (ops)"
    - "Each agent can read/write coordination.db from sandbox"
  artifacts:
    - path: "~/.openclaw/openclaw.json"
      provides: "Verified multi-agent gateway configuration"
    - path: "~/clawd/coordination.db"
      provides: "Shared coordination DB accessible from all sandboxes"
  key_links:
    - from: "Slack channel messages"
      to: "Agent routing via bindings"
      via: "openclaw.json bindings[].match.peer.id"
      pattern: "agentId.*channel"
    - from: "Heartbeat cron"
      to: "Agent sandbox"
      via: "cron job sessionTarget -> agent workspace"
      pattern: "sessionTarget.*main|landos|rangeos|ops"
    - from: "Agent sandbox"
      to: "coordination.db"
      via: "bind-mount or symlink at /workspace/coordination.db"
      pattern: "sqlite3 /workspace/coordination.db"
---

<objective>
Restart the gateway and verify all 4 agents load, respond to heartbeats, and correctly route Slack messages.

Purpose: After Plan 01 fixes (backup, schema docs, sandbox DB access), confirm the full multi-agent system is operational end-to-end.

Output: Running multi-agent gateway with verified routing and coordination.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-agent-gateway/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restart gateway and verify all agents load</name>
  <files>~/.openclaw/openclaw.json</files>
  <action>
SSH to EC2 (100.72.143.9) and:

1. If Plan 01 made any config changes (e.g., bind-mount for coordination.db), restart the gateway:
   ```
   systemctl --user restart openclaw-gateway.service
   sleep 5
   systemctl --user status openclaw-gateway.service --no-pager
   ```

   If Plan 01 made NO config changes (everything already worked), skip restart and just verify current status.

2. Check gateway logs for agent initialization:
   ```
   journalctl --user -u openclaw-gateway.service --since "5 minutes ago" --no-pager | grep -i "agent\|error\|warn"
   ```
   Expected: All 4 agents initialized without errors.

3. Verify cron jobs are loaded:
   ```
   journalctl --user -u openclaw-gateway.service --since "5 minutes ago" --no-pager | grep -i "cron\|heartbeat"
   ```

4. Wait for one heartbeat cycle to complete (max 15 minutes). Check each agent had a heartbeat fire:
   ```
   jq '.jobs[] | select(.name | test("heartbeat")) | {name, lastStatus: .state.lastStatus, lastRunAtMs: .state.lastRunAtMs}' ~/.openclaw/cron/jobs.json
   ```
   All 4 should show lastStatus: "ok".

5. Verify coordination.db access from sandbox by checking recent activity:
   ```
   sqlite3 ~/clawd/coordination.db "SELECT agent_id, activity_type, created_at FROM agent_activity ORDER BY created_at DESC LIMIT 8;"
   ```
   Should show recent heartbeat activity from multiple agents.
  </action>
  <verify>
- `systemctl --user is-active openclaw-gateway.service` returns "active"
- No ERROR-level entries in gateway logs
- All 4 heartbeat crons show lastStatus: "ok"
- agent_activity table has entries from at least 2 different agents
  </verify>
  <done>
Gateway running. All 4 agents initialized. Heartbeats executing. Coordination DB receiving writes from sandbox.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Slack routing to all agents</name>
  <what-built>
Multi-agent gateway with 4 agents (Andy/main, Scout/landos, Vector/rangeos, Sentinel/ops), each mapped to a Slack channel via bindings. Coordination DB accessible from all agent sandboxes. Heartbeats running on staggered 15-minute schedules.
  </what-built>
  <how-to-verify>
Test message routing in Slack:

1. Go to **#land-ops** channel in Slack, send: "Scout, confirm you're online. Reply with your agent ID and run: sqlite3 /workspace/coordination.db 'SELECT count(*) FROM agent_activity'"
   - Expected: Scout (landos) responds with agent ID and a count from coordination.db

2. Go to **#range-ops** channel in Slack, send: "Vector, confirm you're online. Reply with your agent ID."
   - Expected: Vector (rangeos) responds

3. Go to **#ops** channel in Slack, send: "Sentinel, confirm you're online. Reply with your agent ID."
   - Expected: Sentinel (ops) responds

4. Go to **#popsclaw** (or DM), send: "Andy, confirm all agents are online. Check coordination.db for recent activity from all 4 agents."
   - Expected: Andy (main) responds with agent activity summary

If any agent doesn't respond within 2 minutes, check:
- Is the channel in the Slack allowlist?
- Is the bot a member of that channel?
- Is the binding correct in openclaw.json?
  </how-to-verify>
  <resume-signal>Type "approved" if all 4 agents responded correctly, or describe which agent(s) failed and error details.</resume-signal>
</task>

</tasks>

<verification>
1. Gateway service is active and running
2. All 4 heartbeat crons executed successfully in last 15 minutes
3. Coordination DB has activity entries from multiple agents
4. Each Slack channel routes to the correct agent (human-verified)
5. Agents can query coordination.db from inside sandbox
</verification>

<success_criteria>
- MA-06: Gateway restarted (or confirmed running), all 4 agents load and respond
- End-to-end: Slack message -> correct agent -> coordination DB access -> response
- All 6 MA requirements (MA-01 through MA-06) satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/06-multi-agent-gateway/06-02-SUMMARY.md`
</output>
