---
phase: 26-agent-observability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.openclaw/plugins/observability-hooks/package.json
  - ~/.openclaw/plugins/observability-hooks/openclaw.plugin.json
  - ~/.openclaw/plugins/observability-hooks/tsconfig.json
  - ~/.openclaw/plugins/observability-hooks/src/index.ts
  - ~/.openclaw/plugins/observability-hooks/src/db.ts
  - ~/.openclaw/plugins/observability-hooks/src/pricing.ts
  - ~/.openclaw/openclaw.json
autonomous: true
requirements:
  - OBS-01
  - OBS-02

must_haves:
  truths:
    - "llm_output and agent_end hooks fire on every LLM call and agent run across all 7 agents"
    - "Each LLM call writes a row to observability.db with agent_id, model, tokens, and estimated cost"
    - "Each agent run writes a row to observability.db with agent_id, duration, success/error"
    - "observability.db is readable from Bob's sandbox at /workspace/observability.db"
  artifacts:
    - path: "~/.openclaw/plugins/observability-hooks/package.json"
      provides: "Plugin npm package definition"
    - path: "~/.openclaw/plugins/observability-hooks/openclaw.plugin.json"
      provides: "Plugin manifest for OpenClaw registration"
    - path: "~/.openclaw/plugins/observability-hooks/src/index.ts"
      provides: "Hook handlers for llm_output and agent_end"
    - path: "~/.openclaw/plugins/observability-hooks/src/db.ts"
      provides: "SQLite schema, insert functions, retention cleanup"
    - path: "~/.openclaw/plugins/observability-hooks/src/pricing.ts"
      provides: "Model-to-cost mapping for Haiku/Sonnet/Opus"
    - path: "~/.openclaw/plugins/observability-hooks/dist/index.js"
      provides: "Compiled plugin entry point"
  key_links:
    - from: "observability-hooks plugin"
      to: "openclaw.json plugins.load.paths"
      via: "Plugin path registration"
    - from: "observability.db host path"
      to: "/workspace/observability.db sandbox path"
      via: "Docker bind mount (ro)"
    - from: "llm_output event"
      to: "llm_calls table INSERT"
      via: "api.on('llm_output', ...) handler in index.ts"
---

<objective>
Build and install the observability-hooks OpenClaw plugin that captures LLM usage and agent lifecycle data.

Purpose: OBS-01 requires llm_input/llm_output hooks configured and firing. OBS-02 requires per-agent token usage, model distribution, turn counts, cost, latency, and errors available to Bob. This plan creates the data collection infrastructure.

Output: Working plugin writing to observability.db, bind-mounted into sandbox, verified by gateway logs after restart.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/26-agent-observability/26-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create observability-hooks plugin source files</name>
  <files>
    ~/.openclaw/plugins/observability-hooks/package.json
    ~/.openclaw/plugins/observability-hooks/openclaw.plugin.json
    ~/.openclaw/plugins/observability-hooks/tsconfig.json
    ~/.openclaw/plugins/observability-hooks/src/index.ts
    ~/.openclaw/plugins/observability-hooks/src/db.ts
    ~/.openclaw/plugins/observability-hooks/src/pricing.ts
  </files>
  <action>
    SSH to EC2 (100.72.143.9) and create the plugin at `~/.openclaw/plugins/observability-hooks/`.

    **package.json:** Follow SecureClaw pattern exactly. Key fields:
    - `"name": "@openclaw/observability-hooks"`, `"version": "1.0.0"`
    - `"main": "dist/index.js"`, `"type": "module"`
    - `"openclaw": { "type": "extension", "extensions": ["./dist/index.js"] }`
    - `"peerDependencies": { "openclaw": "^2026.2.17" }`
    - `"scripts": { "build": "tsc" }`
    - `"devDependencies": { "typescript": "^5.7.0" }`
    - No runtime dependencies needed — uses `child_process.execSync` for sqlite3 CLI calls

    **openclaw.plugin.json:**
    ```json
    {
      "id": "observability-hooks",
      "name": "Agent Observability",
      "description": "Tracks LLM usage, latency, and errors across all agents",
      "version": "1.0.0"
    }
    ```

    **tsconfig.json:** Standard ESM TypeScript config targeting ES2022 with NodeNext module resolution, outDir: "dist", rootDir: "src", strict: true.

    **src/pricing.ts:** Hardcoded cost map from research:
    - `claude-haiku-4-5`: input $1.00/M, output $5.00/M
    - `claude-sonnet-4-5`: input $3.00/M, output $15.00/M
    - `claude-opus-4-5`: input $5.00/M, output $25.00/M
    - Export `estimateCost(model, inputTokens, outputTokens): number` function
    - Normalize model names: strip `anthropic/` prefix, handle partial matches (e.g., model string contains "haiku" -> use haiku rates)
    - Return 0 for unknown models (don't throw)

    **src/db.ts:** SQLite via `child_process.execSync('sqlite3 ...')` (proven on this host, no npm deps).
    - DB path: `/home/ubuntu/clawd/agents/main/observability.db` (same dir as email.db, bind-mountable)
    - `initDb()`: Creates tables if not exist using the schema from research:
      - `llm_calls` table: id, agent_id, session_key, model, provider, input_tokens, output_tokens, cache_read_tokens, cache_write_tokens, estimated_cost_usd, created_at
      - `agent_runs` table: id, agent_id, session_key, success, error, duration_ms, created_at
      - Indexes: idx_llm_agent_time, idx_llm_model, idx_runs_agent_time, idx_runs_errors
    - `recordLlmCall(data)`: INSERT into llm_calls
    - `recordAgentRun(data)`: INSERT into agent_runs
    - `cleanup(days=90)`: DELETE WHERE created_at < datetime('now', '-{days} days') from both tables
    - All SQL executed via `execSync('sqlite3 /path/to/db "SQL"')` — keep handlers fast (<1ms for INSERT)
    - Handle errors gracefully: wrap execSync in try/catch, log to stderr, never throw (don't block the hook pipeline)

    **src/index.ts:** Plugin entry point following SecureClaw pattern:
    ```typescript
    export default {
      id: 'observability-hooks',
      name: 'Agent Observability',
      version: '1.0.0',
      register(api) {
        // Init DB on plugin load
        initDb();

        api.on('llm_output', async (event, ctx) => {
          const agentId = ctx.agentId ?? parseAgentFromSessionKey(ctx.sessionKey);
          recordLlmCall({
            agentId: agentId ?? 'unknown',
            sessionKey: ctx.sessionKey ?? '',
            model: event.model,
            provider: event.provider,
            inputTokens: event.usage?.input ?? 0,
            outputTokens: event.usage?.output ?? 0,
            cacheReadTokens: event.usage?.cacheRead ?? 0,
            cacheWriteTokens: event.usage?.cacheWrite ?? 0,
            estimatedCostUsd: estimateCost(event.model, event.usage?.input ?? 0, event.usage?.output ?? 0),
            timestamp: new Date().toISOString(),
          });
        });

        api.on('agent_end', async (event, ctx) => {
          const agentId = ctx.agentId ?? parseAgentFromSessionKey(ctx.sessionKey);
          recordAgentRun({
            agentId: agentId ?? 'unknown',
            sessionKey: ctx.sessionKey ?? '',
            success: event.success,
            error: event.error ?? null,
            durationMs: event.durationMs ?? null,
            timestamp: new Date().toISOString(),
          });
        });
      }
    };
    ```
    - `parseAgentFromSessionKey(key)`: Parse agentId from session key format `agent:<agentId>:<rest>`. Return null if format doesn't match.
    - Import `initDb`, `recordLlmCall`, `recordAgentRun` from `./db.js`
    - Import `estimateCost` from `./pricing.js`

    After creating files: `cd ~/.openclaw/plugins/observability-hooks && npm install && npx tsc`
  </action>
  <verify>
    ```bash
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'ls ~/.openclaw/plugins/observability-hooks/dist/index.js && echo "Plugin compiled OK"'
    ```
  </verify>
  <done>Plugin source files exist at ~/.openclaw/plugins/observability-hooks/, TypeScript compiles to dist/ without errors, observability.db can be created by initDb()</done>
</task>

<task type="auto">
  <name>Task 2: Register plugin, add bind mount, restart gateway, verify hooks</name>
  <files>
    ~/.openclaw/openclaw.json
  </files>
  <action>
    SSH to EC2 and configure OpenClaw to load the new plugin.

    **1. Register plugin in openclaw.json:**
    Use python3/jq to add to the existing config (do NOT overwrite — merge):
    - Add `"/home/ubuntu/.openclaw/plugins/observability-hooks"` to `plugins.load.paths` array (alongside existing secureclaw path)
    - Add `"observability-hooks": { "enabled": true }` to `plugins.entries`

    **2. Add bind mount for observability.db:**
    Add to `agents.defaults.sandbox.docker.binds` array:
    `"/home/ubuntu/clawd/agents/main/observability.db:/workspace/observability.db:ro"`
    (Read-only is sufficient — Bob only reads for briefing queries, plugin writes from host)

    **Important:** The DB file must exist before the bind mount works. Create it by running the plugin's initDb or manually:
    ```bash
    sqlite3 /home/ubuntu/clawd/agents/main/observability.db "SELECT 1;"
    ```

    **3. Restart gateway:**
    ```bash
    systemctl --user restart openclaw-gateway.service
    ```
    Wait 10 seconds, then verify:
    ```bash
    systemctl --user status openclaw-gateway.service
    ```

    **4. Verify hooks are firing:**
    Trigger a quick agent turn (heartbeat cron is cheapest):
    ```bash
    /home/ubuntu/.npm-global/bin/openclaw cron run heartbeat-main-15m --timeout 60000
    ```
    Then check observability.db for new rows:
    ```bash
    sqlite3 /home/ubuntu/clawd/agents/main/observability.db "SELECT COUNT(*) FROM llm_calls; SELECT COUNT(*) FROM agent_runs;"
    ```
    Both should show >= 1 row.

    Also verify gateway logs show plugin loaded:
    ```bash
    journalctl --user -u openclaw-gateway.service --since "5 minutes ago" | grep -i observ
    ```

    **5. Verify sandbox access:**
    Check that Bob can read the DB from sandbox (the bind mount is correct):
    ```bash
    /home/ubuntu/.npm-global/bin/openclaw cron run heartbeat-main-15m --timeout 60000
    ```
    Then SSH and check the DB has data:
    ```bash
    sqlite3 /home/ubuntu/clawd/agents/main/observability.db "SELECT agent_id, model, input_tokens, output_tokens, estimated_cost_usd FROM llm_calls ORDER BY created_at DESC LIMIT 5;"
    ```
  </action>
  <verify>
    ```bash
    # Verify plugin registered
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'cat ~/.openclaw/openclaw.json | python3 -c "import sys,json; c=json.load(sys.stdin); print(\"observability-hooks\" in str(c.get(\"plugins\",{})))"'

    # Verify DB has data
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'sqlite3 /home/ubuntu/clawd/agents/main/observability.db "SELECT COUNT(*) as llm_rows FROM llm_calls; SELECT COUNT(*) as run_rows FROM agent_runs;"'

    # Verify gateway running
    ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9 'systemctl --user is-active openclaw-gateway.service'
    ```
  </verify>
  <done>Plugin is registered in openclaw.json, observability.db has rows from at least one agent turn (llm_calls >= 1, agent_runs >= 1), gateway is active, bind mount makes DB readable at /workspace/observability.db in sandbox</done>
</task>

</tasks>

<verification>
1. `ls ~/.openclaw/plugins/observability-hooks/dist/index.js` — compiled plugin exists
2. `grep "observability-hooks" ~/.openclaw/openclaw.json` — plugin registered
3. `sqlite3 observability.db "SELECT COUNT(*) FROM llm_calls"` — data flowing
4. `sqlite3 observability.db "SELECT DISTINCT agent_id FROM llm_calls"` — agent IDs captured
5. `systemctl --user is-active openclaw-gateway.service` — gateway running
</verification>

<success_criteria>
- Plugin compiles and loads without errors
- llm_output hooks fire and write to llm_calls table with agent_id, model, tokens, cost
- agent_end hooks fire and write to agent_runs table with agent_id, duration, success/error
- observability.db is accessible from Bob's sandbox at /workspace/observability.db
- Gateway service remains stable after plugin installation
</success_criteria>

<output>
After completion, create `.planning/phases/26-agent-observability/26-01-SUMMARY.md`
</output>
