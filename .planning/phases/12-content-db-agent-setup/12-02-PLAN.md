---
phase: 12-content-db-agent-setup
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - ~/.openclaw/openclaw.json (EC2)
  - ~/clawd/agents/quill/PRODUCT_CONTEXT.md (EC2)
  - ~/clawd/agents/sage/PRODUCT_CONTEXT.md (EC2)
  - ~/clawd/agents/ezra/PRODUCT_CONTEXT.md (EC2)
autonomous: true

must_haves:
  truths:
    - "3 new agents (Quill, Sage, Ezra) appear in openclaw.json agents.list"
    - "Each agent has a dedicated workspace directory on EC2"
    - "PRODUCT_CONTEXT.md exists in all 3 content agent workspaces with UAS domain guardrails"
    - "PRODUCT_CONTEXT.md includes claim locking protocol and activity logging instructions"
  artifacts:
    - path: "~/.openclaw/openclaw.json"
      provides: "3 new agent entries in agents.list"
      contains: "quill, sage, ezra"
    - path: "~/clawd/agents/quill/PRODUCT_CONTEXT.md"
      provides: "UAS domain context + pipeline protocols for Quill"
    - path: "~/clawd/agents/sage/PRODUCT_CONTEXT.md"
      provides: "UAS domain context + pipeline protocols for Sage"
    - path: "~/clawd/agents/ezra/PRODUCT_CONTEXT.md"
      provides: "UAS domain context + pipeline protocols for Ezra"
  key_links:
    - from: "openclaw.json agents.list"
      to: "~/clawd/agents/{quill,sage,ezra}/"
      via: "workspace path in agent config"
      pattern: "/home/ubuntu/clawd/agents/(quill|sage|ezra)"
---

<objective>
Register 3 content pipeline agents (Quill, Sage, Ezra) in openclaw.json and deploy PRODUCT_CONTEXT.md with UAS domain guardrails, claim locking protocol, and activity logging instructions to all 3 workspaces.

Purpose: Content agents need identity (config) and domain knowledge (PRODUCT_CONTEXT.md) before they can participate in the pipeline. The context doc prevents hallucination about UAS features/regulations and establishes shared protocols.
Output: 3 agents registered, 3 workspace directories created, PRODUCT_CONTEXT.md deployed.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Register 3 content agents in openclaw.json</name>
  <files>~/.openclaw/openclaw.json (EC2)</files>
  <action>
SSH to EC2 (100.72.143.9). Back up openclaw.json first:
```bash
cp ~/.openclaw/openclaw.json ~/.openclaw/openclaw.json.bak-phase12
```

Add 3 new agents to the `agents.list` array in openclaw.json:

```json
{ "id": "quill", "name": "Quill", "workspace": "/home/ubuntu/clawd/agents/quill" },
{ "id": "sage", "name": "Sage", "workspace": "/home/ubuntu/clawd/agents/sage" },
{ "id": "ezra", "name": "Ezra", "workspace": "/home/ubuntu/clawd/agents/ezra" }
```

Append after the existing `ops` entry. Do NOT modify any existing agent entries.

These agents inherit all defaults (model, sandbox config, binds) from agents.defaults. No agent-specific overrides needed.

Create workspace directories:
```bash
mkdir -p ~/clawd/agents/quill ~/clawd/agents/sage ~/clawd/agents/ezra
```

Set ownership consistent with existing agent dirs:
```bash
ls -ld ~/clawd/agents/main/  # Check existing ownership pattern
# Apply same ownership to new dirs if needed
```

Do NOT add bindings or channel config yet -- that requires the Slack channel ID from the human checkpoint in Plan 03.

Restart gateway to pick up new agents:
```bash
systemctl --user restart openclaw-gateway.service
sleep 5
systemctl --user status openclaw-gateway.service
```

Verify agents loaded by checking gateway logs:
```bash
journalctl --user -u openclaw-gateway.service --since "5 minutes ago" --no-pager | grep -i "agent"
```
  </action>
  <verify>
SSH: `cat ~/.openclaw/openclaw.json | python3 -c "import sys,json; d=json.load(sys.stdin); ids=[a['id'] for a in d['agents']['list']]; print(ids)"` includes quill, sage, ezra.
SSH: `ls -d ~/clawd/agents/quill ~/clawd/agents/sage ~/clawd/agents/ezra` all exist.
SSH: `systemctl --user is-active openclaw-gateway.service` returns "active".
  </verify>
  <done>3 content agents (Quill, Sage, Ezra) registered in openclaw.json agents.list with dedicated workspace directories. Gateway restarted and healthy with 7 total agents.</done>
</task>

<task type="auto">
  <name>Task 2: Deploy PRODUCT_CONTEXT.md to all content agent workspaces</name>
  <files>~/clawd/agents/quill/PRODUCT_CONTEXT.md, ~/clawd/agents/sage/PRODUCT_CONTEXT.md, ~/clawd/agents/ezra/PRODUCT_CONTEXT.md (all EC2)</files>
  <action>
SSH to EC2. Create PRODUCT_CONTEXT.md and deploy to all 3 content agent workspaces. The file serves as domain guardrails, pipeline protocols, and shared reference for all content agents.

Write the file to ~/clawd/agents/quill/PRODUCT_CONTEXT.md first, then copy to sage and ezra.

Content for PRODUCT_CONTEXT.md:

```markdown
# UAS Product Context

## Company Overview

Unmanned Aerial Solutions (UAS) provides commercial drone services including aerial surveying, mapping, inspection, and data analytics. Based in California.

## Content Domain Rules

### DO
- Write about commercial drone applications (agriculture, construction, energy, infrastructure)
- Reference FAA Part 107 regulations accurately
- Discuss drone technology trends (LiDAR, photogrammetry, thermal imaging, RTK GPS)
- Cover industry verticals: agriculture, construction, energy/utilities, mining, real estate
- Use data-driven claims with sources
- Write in professional but accessible tone
- Include practical takeaways for commercial drone operators
- Reference real industry standards (ASTM, ISO for UAS)

### DON'T
- Claim UAS manufactures drones (they provide services)
- Invent specific FAA regulation numbers without verification
- Promise specific ROI percentages without sourcing
- Write about military/defense drone applications
- Write about recreational/hobby drone use
- Claim capabilities UAS doesn't have (make up service offerings)
- Use overly technical jargon without explanation
- Reference competitors by name negatively
- Make claims about specific pricing

## Content Pipeline Database

All content data lives in `/workspace/content.db` (SQLite).

### Tables
- **topics**: Research topics with briefs, keywords, priority
- **articles**: Written content with SEO/readability/accuracy scores
- **social_posts**: LinkedIn/Instagram posts linked to articles
- **pipeline_activity**: Audit log of all pipeline actions

### Status Flows
- Topics: backlog -> researching -> writing -> completed
- Articles: writing -> review -> revision -> approved -> published
- Social posts: draft -> scheduled -> posted

## Claim Locking Protocol (CP-05)

When claiming a topic or article for work, agents MUST use SQLite transactions to prevent race conditions:

```sql
BEGIN IMMEDIATE;
-- Check if unclaimed
SELECT id, claimed_by FROM topics WHERE id = ? AND claimed_by IS NULL;
-- If unclaimed, claim it
UPDATE topics SET claimed_by = '<agent_id>', claimed_at = datetime('now'), status = '<new_status>', updated_at = datetime('now') WHERE id = ? AND claimed_by IS NULL;
COMMIT;
```

Rules:
1. Always use BEGIN IMMEDIATE (not BEGIN or BEGIN DEFERRED) -- acquires write lock immediately
2. Check claimed_by IS NULL before UPDATE
3. Include claimed_by IS NULL in UPDATE WHERE clause (double-check pattern)
4. Never use optimistic locking (check-then-update without transaction)
5. On SQLITE_BUSY (lock contention), retry after 1-2 second delay, max 3 retries
6. Release claims if work is abandoned: UPDATE ... SET claimed_by = NULL, claimed_at = NULL

## Activity Logging Protocol (CP-06)

Every state change MUST be logged to pipeline_activity:

```sql
INSERT INTO pipeline_activity (entity_type, entity_id, agent_id, action, old_status, new_status, details)
VALUES ('<topics|articles|social_posts>', <id>, '<agent_id>', '<action_verb>', '<old_status>', '<new_status>', '<optional details>');
```

Action verbs: created, claimed, status_changed, reviewed, scored, published, released
Always log BEFORE committing the status change (in same transaction if possible).

## Agent Roles

- **Vector** (rangeos): Topic researcher -- finds opportunities, creates topic briefs
- **Quill** (quill): Writer -- claims topics, produces article drafts
- **Sage** (sage): Editor -- reviews articles, scores quality, approves or requests revision
- **Ezra** (ezra): Publisher -- publishes to WordPress, creates social posts
```

Deploy to all 3 workspaces:
```bash
cp ~/clawd/agents/quill/PRODUCT_CONTEXT.md ~/clawd/agents/sage/PRODUCT_CONTEXT.md
cp ~/clawd/agents/quill/PRODUCT_CONTEXT.md ~/clawd/agents/ezra/PRODUCT_CONTEXT.md
```

Verify all 3 files are identical:
```bash
md5sum ~/clawd/agents/quill/PRODUCT_CONTEXT.md ~/clawd/agents/sage/PRODUCT_CONTEXT.md ~/clawd/agents/ezra/PRODUCT_CONTEXT.md
```
  </action>
  <verify>
SSH: `ls -la ~/clawd/agents/quill/PRODUCT_CONTEXT.md ~/clawd/agents/sage/PRODUCT_CONTEXT.md ~/clawd/agents/ezra/PRODUCT_CONTEXT.md` -- all 3 exist.
SSH: `md5sum ~/clawd/agents/*/PRODUCT_CONTEXT.md` -- all 3 have same hash.
SSH: `grep "BEGIN IMMEDIATE" ~/clawd/agents/quill/PRODUCT_CONTEXT.md` -- claim locking protocol present.
SSH: `grep "pipeline_activity" ~/clawd/agents/quill/PRODUCT_CONTEXT.md` -- activity logging protocol present.
SSH: `grep "DON'T" ~/clawd/agents/quill/PRODUCT_CONTEXT.md` -- domain guardrails present.
  </verify>
  <done>PRODUCT_CONTEXT.md deployed to all 3 content agent workspaces with UAS domain DO/DON'T guardrails, claim locking protocol (BEGIN IMMEDIATE), activity logging protocol, status flows, and agent role definitions. CP-04, CP-05, CP-06 documentation satisfied.</done>
</task>

</tasks>

<verification>
1. openclaw.json has 7 agents (4 existing + 3 new: quill, sage, ezra)
2. Workspace dirs exist: ~/clawd/agents/{quill,sage,ezra}/
3. PRODUCT_CONTEXT.md exists in all 3 workspaces with identical content
4. PRODUCT_CONTEXT.md contains: UAS DO/DON'T rules, claim locking with BEGIN IMMEDIATE, activity logging protocol, status flows, agent roles
5. Gateway service active with new agents loaded
</verification>

<success_criteria>
- 3 new agents registered and loading in gateway
- Workspace directories created with correct ownership
- PRODUCT_CONTEXT.md deployed with domain guardrails (CP-04)
- Claim locking protocol documented with BEGIN IMMEDIATE pattern (CP-05)
- Activity logging protocol documented with INSERT template (CP-06)
- No existing agent config disrupted
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-db-agent-setup/12-02-SUMMARY.md`
</output>
