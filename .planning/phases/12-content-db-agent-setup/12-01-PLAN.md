---
phase: 12-content-db-agent-setup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/clawd/content.db (EC2)
  - ~/.openclaw/openclaw.json (EC2)
autonomous: true

must_haves:
  truths:
    - "content.db exists at ~/clawd/content.db on EC2 with 4 tables"
    - "All agents can read/write content.db from sandbox via /workspace/content.db"
    - "Claim locking uses BEGIN IMMEDIATE transactions (no optimistic locking)"
    - "Pipeline activity is logged to pipeline_activity table on every state change"
  artifacts:
    - path: "~/clawd/content.db"
      provides: "Content pipeline database with 4 tables + indexes"
      contains: "topics, articles, social_posts, pipeline_activity"
    - path: "~/.openclaw/openclaw.json"
      provides: "content.db bind-mount in agents.defaults.sandbox.docker.binds"
      contains: "/home/ubuntu/clawd/content.db:/workspace/content.db:rw"
  key_links:
    - from: "openclaw.json binds"
      to: "~/clawd/content.db"
      via: "Docker bind-mount"
      pattern: "content.db:/workspace/content.db:rw"
---

<objective>
Create content.db with 4-table schema, bind-mount to all agent sandboxes, and establish claim locking + activity logging protocols.

Purpose: Foundation database for the entire content marketing pipeline. All content agents (Quill, Sage, Ezra) and existing agents need read/write access.
Output: content.db on EC2 with verified sandbox access via bind-mount.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-multi-agent-gateway/06-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create content.db with 4-table schema and indexes</name>
  <files>~/clawd/content.db (EC2)</files>
  <action>
SSH to EC2 (100.72.143.9) and create content.db at ~/clawd/content.db using sqlite3.

Create these 4 tables:

```sql
CREATE TABLE topics (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  brief TEXT,
  keywords TEXT,
  content_type TEXT DEFAULT 'article',
  status TEXT DEFAULT 'backlog',
  claimed_by TEXT,
  claimed_at TEXT,
  priority INTEGER DEFAULT 2,
  source_url TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  topic_id INTEGER NOT NULL REFERENCES topics(id),
  title TEXT NOT NULL,
  slug TEXT UNIQUE NOT NULL,
  body TEXT,
  word_count INTEGER DEFAULT 0,
  status TEXT DEFAULT 'writing',
  claimed_by TEXT,
  claimed_at TEXT,
  reviewer_notes TEXT,
  seo_score INTEGER,
  readability_score INTEGER,
  accuracy_score INTEGER,
  wp_post_id INTEGER,
  wp_url TEXT,
  published_at TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  updated_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE social_posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER NOT NULL REFERENCES articles(id),
  platform TEXT NOT NULL,
  content TEXT NOT NULL,
  image_prompt TEXT,
  status TEXT DEFAULT 'draft',
  posted_at TEXT,
  post_url TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE pipeline_activity (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  entity_type TEXT NOT NULL,
  entity_id INTEGER NOT NULL,
  agent_id TEXT NOT NULL,
  action TEXT NOT NULL,
  old_status TEXT,
  new_status TEXT,
  details TEXT,
  created_at TEXT DEFAULT CURRENT_TIMESTAMP
);
```

Create indexes:

```sql
CREATE INDEX idx_topics_status ON topics(status);
CREATE INDEX idx_topics_claimed ON topics(claimed_by);
CREATE INDEX idx_articles_status ON articles(status);
CREATE INDEX idx_articles_topic ON articles(topic_id);
CREATE INDEX idx_articles_claimed ON articles(claimed_by);
CREATE INDEX idx_social_article ON social_posts(article_id);
CREATE INDEX idx_social_platform ON social_posts(platform);
CREATE INDEX idx_activity_entity ON pipeline_activity(entity_type, entity_id);
CREATE INDEX idx_activity_agent ON pipeline_activity(agent_id);
CREATE INDEX idx_activity_created ON pipeline_activity(created_at);
```

Status flow for topics: backlog -> researching -> writing -> completed
Status flow for articles: writing -> review -> revision -> approved -> published
Status flow for social_posts: draft -> scheduled -> posted

Follow coordination.db pattern exactly (same TEXT timestamps with CURRENT_TIMESTAMP defaults).

Verify: `sqlite3 ~/clawd/content.db ".tables"` returns all 4 tables. `sqlite3 ~/clawd/content.db ".schema"` shows all indexes.
  </action>
  <verify>
SSH: `sqlite3 ~/clawd/content.db ".tables"` lists topics, articles, social_posts, pipeline_activity.
SSH: `sqlite3 ~/clawd/content.db ".schema" | grep "CREATE INDEX" | wc -l` returns 10.
SSH: `sqlite3 ~/clawd/content.db "INSERT INTO topics(title, slug, brief) VALUES('test','test-slug','test brief'); SELECT id, status FROM topics WHERE slug='test-slug';"` returns 1|backlog.
SSH: `sqlite3 ~/clawd/content.db "DELETE FROM topics WHERE slug='test-slug';"` cleanup.
  </verify>
  <done>content.db exists at ~/clawd/content.db with 4 tables, 10 indexes, correct column types and defaults.</done>
</task>

<task type="auto">
  <name>Task 2: Bind-mount content.db and verify sandbox access</name>
  <files>~/.openclaw/openclaw.json (EC2)</files>
  <action>
SSH to EC2. Add content.db bind-mount to openclaw.json in agents.defaults.sandbox.docker.binds array.

Add this line to the binds array (after the existing coordination.db bind):
`/home/ubuntu/clawd/content.db:/workspace/content.db:rw`

Follow the exact pattern from Phase 6 (coordination.db bind-mount). Use jq or direct edit.

After editing, restart the gateway service:
```bash
systemctl --user restart openclaw-gateway.service
sleep 5
systemctl --user status openclaw-gateway.service
```

Verify sandbox access by running a test query from inside a Docker container:
```bash
docker run --rm \
  -v /home/ubuntu/clawd/content.db:/workspace/content.db:rw \
  -v /home/ubuntu/clawd/sqlite3-compat:/usr/bin/sqlite3:ro \
  clawdbot-sandbox:with-browser \
  sqlite3 /workspace/content.db ".tables"
```

This must return all 4 table names, confirming sandbox agents can access content.db.

IMPORTANT: Do NOT modify any other part of openclaw.json. Only append to the binds array.
  </action>
  <verify>
SSH: `grep content.db ~/.openclaw/openclaw.json` shows the bind-mount line.
SSH: `systemctl --user is-active openclaw-gateway.service` returns "active".
SSH: Docker test query returns "articles pipeline_activity social_posts topics".
  </verify>
  <done>content.db bind-mounted at /workspace/content.db:rw for all agents. Gateway restarted and healthy. Sandbox read/write access confirmed.</done>
</task>

</tasks>

<verification>
1. `sqlite3 ~/clawd/content.db ".tables"` returns 4 tables
2. `sqlite3 ~/clawd/content.db ".schema" | grep "CREATE INDEX" | wc -l` returns 10
3. `grep "content.db" ~/.openclaw/openclaw.json` shows bind-mount entry
4. Gateway service active after restart
5. Docker sandbox can query content.db at /workspace/content.db
</verification>

<success_criteria>
- content.db exists with topics, articles, social_posts, pipeline_activity tables
- 10 indexes created for query performance
- Bind-mount in openclaw.json agents.defaults.sandbox.docker.binds
- All agents (existing + future) have /workspace/content.db:rw access
- Gateway service running cleanly after config change
- CP-01 satisfied (schema + bind-mount)
- CP-05 partially satisfied (schema supports BEGIN IMMEDIATE; protocol documented in PRODUCT_CONTEXT.md in Plan 02)
- CP-06 partially satisfied (pipeline_activity table exists; logging protocol documented in PRODUCT_CONTEXT.md in Plan 02)
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-db-agent-setup/12-01-SUMMARY.md`
</output>
