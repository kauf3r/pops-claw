---
phase: 02-oura-ring-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/.openclaw/.env
  - /home/ubuntu/.openclaw/skills/oura/SKILL.md
autonomous: false
user_setup:
  - service: oura
    why: "Health data integration (sleep, readiness, activity)"
    env_vars:
      - name: OURA_ACCESS_TOKEN
        source: "https://cloud.ouraring.com/personal-access-tokens -> Create New Personal Access Token"
    dashboard_config: []

must_haves:
  truths:
    - "Bob can fetch today's Oura sleep score, readiness score, and HRV via curl"
    - "Bob can fetch activity data (steps, calories) via Oura API"
    - "Bob stores a daily health snapshot row in SQLite"
    - "Health snapshot data is queryable for morning briefing consumption"
  artifacts:
    - path: "/home/ubuntu/.openclaw/skills/oura/SKILL.md"
      provides: "Oura Ring skill instructions for Bob"
      min_lines: 80
    - path: "/home/ubuntu/.openclaw/.env"
      provides: "OURA_ACCESS_TOKEN env var"
      contains: "OURA_ACCESS_TOKEN="
  key_links:
    - from: "/home/ubuntu/.openclaw/skills/oura/SKILL.md"
      to: "https://cloud.ouraring.com/v2/usercollection/"
      via: "curl with Bearer token from OURA_ACCESS_TOKEN env var"
      pattern: "OURA_ACCESS_TOKEN"
    - from: "SKILL.md health snapshot instructions"
      to: "SQLite health_snapshots table"
      via: "sqlite3 CLI or python3 with INSERT statement"
      pattern: "health_snapshots"
---

<objective>
Create the Oura Ring skill for Bob, configure API access, and set up health data storage.

Purpose: Give Bob the ability to pull daily health metrics (sleep, readiness, HRV, resting HR, activity) from the Oura Ring API and store daily snapshots in SQLite for morning briefing consumption.

Output: Working SKILL.md on EC2, OURA_ACCESS_TOKEN in .env, SQLite health_snapshots table created, Bob able to pull and store health data on demand.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add OURA_ACCESS_TOKEN to .env and create health_snapshots table</name>
  <files>/home/ubuntu/.openclaw/.env, SQLite DB on EC2</files>
  <action>
SSH to EC2 (ssh -i ~/.ssh/clawdbot-key.pem ubuntu@100.72.143.9).

1. Append OURA_ACCESS_TOKEN to ~/.openclaw/.env (value provided by user_setup or already present). Use tee -a (NOT heredoc over SSH):
   echo 'OURA_ACCESS_TOKEN=<token>' | ssh ... "tee -a ~/.openclaw/.env > /dev/null"
   Verify it's present: ssh ... "grep OURA_ACCESS_TOKEN ~/.openclaw/.env"

2. Create the health_snapshots SQLite table. Use python3 on EC2 (sqlite3 CLI also acceptable):
   Table: health_snapshots
   Columns:
   - id INTEGER PRIMARY KEY AUTOINCREMENT
   - date TEXT NOT NULL UNIQUE (YYYY-MM-DD format)
   - sleep_score INTEGER
   - sleep_efficiency REAL
   - sleep_duration_hours REAL
   - readiness_score INTEGER
   - hrv_balance REAL
   - resting_hr INTEGER
   - body_temp_deviation REAL
   - activity_score INTEGER
   - steps INTEGER
   - active_calories INTEGER
   - raw_json TEXT (full API response for debugging)
   - created_at TEXT DEFAULT (datetime('now'))

   DB path: ~/clawd/health.db (new DB file for health data — keeps it separate from pipeline.db and OpenClaw's internal SQLite)

   Verify: ssh ... "python3 -c \"import sqlite3; c=sqlite3.connect('/home/ubuntu/clawd/health.db'); print(c.execute('SELECT sql FROM sqlite_master WHERE name=\\\"health_snapshots\\\"').fetchone()[0])\""

3. Restart the gateway service to pick up the new env var:
   ssh ... "systemctl --user restart openclaw-gateway.service"
   Verify: ssh ... "systemctl --user status openclaw-gateway.service" (should show active)
  </action>
  <verify>
- grep OURA_ACCESS_TOKEN on .env returns the token line
- health_snapshots table exists in ~/clawd/health.db with all columns
- Gateway service is active after restart
  </verify>
  <done>
OURA_ACCESS_TOKEN is in .env, health_snapshots table created with correct schema, gateway running with new env.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Oura Ring SKILL.md</name>
  <files>/home/ubuntu/.openclaw/skills/oura/SKILL.md</files>
  <action>
SSH to EC2. Create directory and skill file:
  ssh ... "mkdir -p ~/.openclaw/skills/oura"

Write SKILL.md via tee (NOT heredoc — use echo or printf piped to tee, or scp a local temp file). The skill must contain:

**Section 1: Overview**
- Skill name: Oura Ring Health Data
- Purpose: Pull daily health metrics from Oura Ring API
- Auth: OURA_ACCESS_TOKEN env var (Bearer token)

**Section 2: Authentication**
- Header: Authorization: Bearer $OURA_ACCESS_TOKEN
- Base URL: https://cloud.ouraring.com/v2/usercollection
- Rate limit: 5000 req/day (effectively unlimited for daily pulls)

**Section 3: API Endpoints**
Document these endpoints with example curl commands:

a) Daily Sleep:
   GET /daily_sleep?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
   Key fields: score, efficiency, total_sleep_duration (seconds), deep_sleep_duration, rem_sleep_duration

b) Daily Readiness:
   GET /daily_readiness?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
   Key fields: score, temperature_deviation, hrv_balance

c) Daily Activity:
   GET /daily_activity?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD
   Key fields: score, steps, active_calories, total_calories

d) Heart Rate:
   GET /heartrate?start_datetime=YYYY-MM-DDTHH:MM:SS&end_datetime=YYYY-MM-DDTHH:MM:SS
   Key fields: bpm, source (awake/rest/sleep)
   Note: Use this to get resting HR — filter source=rest and average

**Section 4: Daily Health Snapshot Workflow**
Instructions for Bob to:
1. Determine yesterday's date (data available ~4-6 hours after waking)
2. Call all 3 daily endpoints for yesterday's date
3. Parse key metrics from JSON responses
4. Compute resting HR from heartrate endpoint (average of source=rest readings for the night)
5. INSERT into ~/clawd/health.db health_snapshots table using python3:
   python3 -c "
   import sqlite3, json
   conn = sqlite3.connect('/home/ubuntu/clawd/health.db')
   conn.execute('''INSERT OR REPLACE INTO health_snapshots
     (date, sleep_score, sleep_efficiency, sleep_duration_hours,
      readiness_score, hrv_balance, resting_hr, body_temp_deviation,
      activity_score, steps, active_calories, raw_json)
     VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)''',
     (date, sleep_score, efficiency, duration_hrs,
      readiness_score, hrv_balance, resting_hr, temp_dev,
      activity_score, steps, active_cal, raw_json))
   conn.commit()
   "
6. Report summary to user

**Section 5: Querying for Morning Briefing**
Instructions for retrieving the latest snapshot:
  python3 -c "
  import sqlite3, json
  conn = sqlite3.connect('/home/ubuntu/clawd/health.db')
  row = conn.execute('SELECT * FROM health_snapshots ORDER BY date DESC LIMIT 1').fetchone()
  # Format into briefing section
  "

Include a formatting template:
  Health (Oura):
  - Sleep: {score}/100 ({duration}h, {efficiency}% efficiency)
  - Readiness: {score}/100
  - HRV Balance: {hrv_balance}
  - Resting HR: {resting_hr} bpm
  - Activity: {score}/100 ({steps} steps)

**Section 6: Error Handling**
- 401: Token expired or invalid — tell user to regenerate at cloud.ouraring.com
- 429: Rate limited (unlikely) — wait and retry
- Empty data array: Ring not worn or data not synced yet — report "no data available"
- Network error: Retry once, then report failure

**Section 7: Tips**
- Data for "today" isn't complete until the next morning — always query yesterday
- Sleep data includes naps if detected
- HRV balance is relative to personal baseline (positive = above average)
- Body temp deviation is relative to personal baseline (positive = warmer)

Verify the skill is detected:
  ssh ... "/home/ubuntu/.npm-global/bin/openclaw skills list" (should show oura in the list)
  </action>
  <verify>
- SKILL.md exists at ~/.openclaw/skills/oura/SKILL.md
- File is >80 lines with all 7 sections
- "openclaw skills list" shows the oura skill
  </verify>
  <done>
Oura SKILL.md created with complete API docs, snapshot workflow, briefing query template, and error handling. Skill detected by OpenClaw.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Oura Ring skill with API access, SQLite storage, and health data workflow. Bob should now be able to pull Oura health data and store it.
  </what-built>
  <how-to-verify>
1. Open Slack and message Bob: "Pull my Oura health data for yesterday and store it"
2. Bob should:
   - Call the Oura API endpoints (sleep, readiness, activity, heart rate)
   - Parse the responses
   - Store a snapshot row in ~/clawd/health.db
   - Report a summary with sleep score, readiness, HRV, resting HR, steps
3. Verify storage: ssh to EC2 and run:
   python3 -c "import sqlite3; conn=sqlite3.connect('/home/ubuntu/clawd/health.db'); row=conn.execute('SELECT date, sleep_score, readiness_score, steps FROM health_snapshots ORDER BY date DESC LIMIT 1').fetchone(); print(row)"
4. Numbers should match what Bob reported

If Bob can't find the skill, restart gateway: systemctl --user restart openclaw-gateway.service
If API returns 401, token may need regeneration at https://cloud.ouraring.com/personal-access-tokens
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues</resume-signal>
</task>

</tasks>

<verification>
Phase 2 requirements check:
- HE-01: SKILL.md exists at ~/.openclaw/skills/oura/SKILL.md
- HE-02: OURA_ACCESS_TOKEN present in ~/.openclaw/.env
- HE-03: Skill documents how to pull sleep, readiness, HRV, resting HR, activity
- HE-04: health_snapshots table in ~/clawd/health.db, verified with a real data row
- HE-05: Skill includes briefing query template and formatting for morning briefing consumption
</verification>

<success_criteria>
1. Bob successfully pulls Oura data via API and reports health metrics
2. A health_snapshots row exists in SQLite with real data
3. Briefing query template in SKILL.md returns formatted health section
4. Human verification passed
</success_criteria>

<output>
After completion, create `.planning/phases/02-oura-ring-integration/02-01-SUMMARY.md`
</output>
