---
phase: 32-memory-office-visualization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/api/office/route.ts
  - src/components/office/office-floor.tsx
  - src/components/office/agent-desk.tsx
  - src/app/office/page.tsx
autonomous: true
requirements: [OFFC-01, OFFC-02]

must_haves:
  truths:
    - "Opening /office shows a top-down office floorplan with 7 agent desks"
    - "Each desk has a unique illustrated avatar representing the agent"
    - "Active agents show an animated green pulse; idle agents are gray/dim"
    - "Each active agent shows a badge with their current task type"
    - "Agents without activity for 5+ minutes display as idle"
  artifacts:
    - path: "src/app/office/page.tsx"
      provides: "Office view page with floorplan layout"
      contains: "useSWR"
    - path: "src/components/office/office-floor.tsx"
      provides: "SVG floorplan layout with desk positions"
      contains: "svg"
    - path: "src/components/office/agent-desk.tsx"
      provides: "Individual desk with avatar, status pulse, task badge"
      contains: "animate-pulse"
    - path: "src/app/api/office/route.ts"
      provides: "Agent status data for office view"
      exports: ["GET"]
  key_links:
    - from: "src/app/office/page.tsx"
      to: "/api/office"
      via: "useSWR fetch"
      pattern: "useSWR.*api/office"
    - from: "src/app/api/office/route.ts"
      to: "src/lib/queries/agents.ts"
      via: "reuse existing agent health queries"
      pattern: "getAgentHealth|coordination"
---

<objective>
Build the /office page with a top-down office floorplan showing 7 agent avatars at virtual workstations, with animated status reflecting current activity (working vs idle based on 5-minute heartbeat threshold).

Purpose: OFFC-01 and OFFC-02 -- make agent status fun to look at with an isometric-lite office visualization.
Output: Office API route, floorplan component, desk component, page component.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-memory-office-visualization/32-RESEARCH.md
@.planning/phases/31-agent-board/31-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create office API route with agent status data</name>
  <files>src/app/api/office/route.ts</files>
  <action>
Create `src/app/api/office/route.ts`:

1. `export const dynamic = "force-dynamic"`

2. GET handler that returns status for all 7 agents with fields needed for office view:
   - Reuse the existing agent query patterns from `src/lib/queries/agents.ts` (getAgentHealth or similar pattern -- query coordination.db `agent_activity` for last activity per agent)
   - For each of 7 agents, return:
     - `agent_id`, `display_name`, `system` (from AGENTS constant in constants.ts)
     - `status`: "active" if last activity within 5 minutes, "idle" otherwise
     - `last_activity_type`: the `activity_type` from most recent coordination.db entry (e.g., "cron", "coordination", "heartbeat", "session")
     - `task_label`: friendly label derived from activity_type: cron -> "Running cron", coordination -> "Coordinating", heartbeat -> "Monitoring", session -> "In session". If idle: "Idle"
     - `last_seen`: ISO timestamp of last activity (or null if never seen)
   - Query coordination.db for latest `agent_activity` per agent (use `MAX(created_at)` grouped by agent_id). Handle bob/main aliasing for the main agent (IN ('main', 'bob')).
   - Also check observability.db `agent_runs` for supplementary last-seen data (some agents may show in observability but not coordination)

3. Return `{ agents: OfficeAgent[], timestamp: ISO string }`

4. Wrap in try/catch with 500 error response on failure
  </action>
  <verify>
SSH to EC2, curl http://localhost:3001/api/office and confirm JSON with 7 agents, each having status (active/idle), task_label, and last_seen fields.
  </verify>
  <done>API returns status for all 7 agents with activity type, 5-minute idle threshold, and friendly task labels.</done>
</task>

<task type="auto">
  <name>Task 2: Create office floorplan page with agent desks and avatars</name>
  <files>src/components/office/office-floor.tsx, src/components/office/agent-desk.tsx, src/app/office/page.tsx</files>
  <action>
Create `src/components/office/agent-desk.tsx` -- AgentDesk component:
- Props: `{ agent_id, display_name, system, status, task_label, last_seen }`
- Render as a desk unit containing:
  - **Avatar:** Simple SVG placeholder avatar -- colored circle with agent's initial letter, unique color per agent (use AGENT_COLORS from research: main=blue, landos=green, rangeos=purple, ops=orange, quill=pink, sage=yellow, ezra=cyan). The user wants "illustrated character avatars" but research recommends starting with placeholder SVGs that can be replaced later. Make each avatar visually distinct: different geometric character shapes (e.g., circle with different hat/accessory shapes in SVG) giving each agent personality.
  - **Status indicator:** When active: animated green pulse ring around avatar (use `animate-pulse` from tailwindcss-animate with emerald-400 color). When idle: gray/dim avatar with reduced opacity (opacity-40).
  - **Name label:** Agent display name below avatar
  - **Task badge:** Small pill badge below name showing task_label text. Green background when active, zinc/gray when idle. Only show when status is "active".
  - **Desk graphic:** Simple SVG desk shape (rectangle with slight perspective/shadow) beneath the avatar, giving the isometric-lite feel. Use zinc-800 fill with subtle zinc-700 top surface.

Create `src/components/office/office-floor.tsx` -- OfficeFloor component:
- Props: `{ agents: OfficeAgent[] }`
- Render a top-down office floorplan using CSS grid or absolute positioning within an SVG/div container:
  - Office background: dark zinc-900 floor with subtle grid lines (isometric-lite feel)
  - Desk arrangement: 2 rows of desks. Top row: 4 desks (main, landos, rangeos, ops). Bottom row: 3 desks (quill, sage, ezra) centered. Natural office layout feel.
  - Each desk position renders an AgentDesk component
  - Decorative elements: subtle "floor" texture via CSS pattern (optional), "wall" border at top suggesting office boundary
  - Container is responsive: scales with viewport, maintains aspect ratio

Create `src/app/office/page.tsx`:
- Page title "The Office" with subtitle "Virtual workspace â€” agent status at a glance"
- useSWR fetch to `/api/office` with 30s refresh (standard SWR polling from providers.tsx)
- Render OfficeFloor with agents data
- Summary line above floor: "N active, M idle" with colored counts (same pattern as fleet summary on /agents)
- Skeleton loader: gray placeholder matching floorplan dimensions while loading
- Freshness indicator (reuse existing pattern)
  </action>
  <verify>
SSH to EC2, restart dev server. Visit http://100.72.143.9:3001/office from Tailscale. Verify: floorplan shows 7 desks with avatars, active agents pulse green, idle agents are dimmed, task badges show current activity type, layout is responsive.
  </verify>
  <done>/office page displays top-down floorplan with 7 agent desks. Active agents show green pulse and task badge. Idle agents (5+ min without activity) are dimmed. Each agent has a unique colored avatar.</done>
</task>

</tasks>

<verification>
1. /api/office returns 7 agents with status, task_label, and last_seen
2. /office page loads with floorplan showing all 7 agent desks
3. Active agents display animated green pulse around avatar
4. Idle agents display dimmed/gray avatar without pulse
5. Task badges show friendly activity labels for active agents
6. 5-minute threshold correctly distinguishes active vs idle
7. Each agent has a unique colored avatar
8. Layout is responsive and maintains visual coherence
9. Skeleton loader shows during initial fetch
10. SWR auto-refresh updates agent status every 30 seconds
</verification>

<success_criteria>
- OFFC-01: Office view shows avatar for each of 7 agents at virtual workstations
- OFFC-02: Agent avatars reflect current status (working when active, idle when inactive based on 5-min threshold)
</success_criteria>

<output>
After completion, create `.planning/phases/32-memory-office-visualization/32-02-SUMMARY.md`
</output>
