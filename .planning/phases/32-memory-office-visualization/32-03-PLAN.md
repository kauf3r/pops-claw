---
phase: 32-memory-office-visualization
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/queries/analytics.ts
  - src/app/api/analytics/tokens/route.ts
  - src/app/api/analytics/pipeline/route.ts
  - src/app/api/analytics/email/route.ts
  - src/app/api/analytics/crons/route.ts
  - src/components/analytics/token-chart.tsx
  - src/components/analytics/pipeline-chart.tsx
  - src/components/analytics/email-chart.tsx
  - src/components/analytics/cron-chart.tsx
  - src/app/analytics/page.tsx
autonomous: true
requirements: [VIZ-01, VIZ-02, VIZ-03, VIZ-04]

must_haves:
  truths:
    - "Opening /analytics shows 4 charts on a single page"
    - "Token usage chart displays stacked area per agent over time"
    - "Content pipeline chart shows bar chart with article counts by status"
    - "Email volume chart shows line chart over time (or empty state when no data)"
    - "Cron chart shows donut with success/error/never-run segments"
    - "Time range buttons (24h / 7d / 30d) control the token and email charts"
    - "Hovering charts shows tooltip with exact values"
  artifacts:
    - path: "src/lib/queries/analytics.ts"
      provides: "Analytics aggregation queries for all 4 chart types"
      contains: "getTokenTimeSeries"
    - path: "src/app/analytics/page.tsx"
      provides: "Analytics page with 4 charts and time range selector"
      contains: "useSWR"
    - path: "src/components/analytics/token-chart.tsx"
      provides: "Recharts AreaChart with stacked agent areas"
      contains: "AreaChart"
    - path: "src/components/analytics/pipeline-chart.tsx"
      provides: "Recharts BarChart for content pipeline"
      contains: "BarChart"
    - path: "src/components/analytics/email-chart.tsx"
      provides: "Recharts LineChart for email volume"
      contains: "LineChart"
    - path: "src/components/analytics/cron-chart.tsx"
      provides: "Recharts PieChart donut for cron status"
      contains: "PieChart"
  key_links:
    - from: "src/app/analytics/page.tsx"
      to: "/api/analytics/*"
      via: "useSWR fetches to 4 endpoints"
      pattern: "useSWR.*api/analytics"
    - from: "src/app/api/analytics/tokens/route.ts"
      to: "src/lib/queries/analytics.ts"
      via: "getTokenTimeSeries"
      pattern: "getTokenTimeSeries"
    - from: "src/components/analytics/token-chart.tsx"
      to: "recharts"
      via: "AreaChart from recharts with ChartContainer wrapper"
      pattern: "ChartContainer.*AreaChart"
---

<objective>
Build the /analytics page with 4 Recharts visualizations: token usage area chart per agent, content pipeline bar chart by status, email volume line chart over time, and cron success/failure donut chart. All wrapped in shadcn ChartContainer with tooltips and time range selector.

Purpose: VIZ-01 through VIZ-04 -- make trends visible across tokens, content, email, and crons.
Output: Analytics query module, 4 API routes, 4 chart components, analytics page.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/32-memory-office-visualization/32-RESEARCH.md
@.planning/phases/30-dashboard-metrics/30-01-SUMMARY.md
@.planning/phases/29-infrastructure-database-foundation/29-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics query module and 4 API routes</name>
  <files>src/lib/queries/analytics.ts, src/app/api/analytics/tokens/route.ts, src/app/api/analytics/pipeline/route.ts, src/app/api/analytics/email/route.ts, src/app/api/analytics/crons/route.ts</files>
  <action>
Create `src/lib/queries/analytics.ts` with 4 query functions:

1. **`getTokenTimeSeries(days: number = 7)`** -- query observability.db:
   - SQL: `SELECT date(created_at) as day, CASE WHEN agent_id IN ('main', 'bob') THEN 'main' ELSE agent_id END as agent, sum(input_tokens + output_tokens) as tokens FROM llm_calls WHERE created_at > datetime('now', '-N days') GROUP BY day, agent ORDER BY day ASC`
   - Pivot results to Recharts format: `{ date: "2026-02-21", main: 177941, landos: 50802, ops: 61440, rangeos: 12000, quill: 8000, sage: 3000, ezra: 1000 }`. Fill missing agents with 0 per date.
   - Use getDb("observability") from db.ts. Return empty array if DB null.

2. **`getPipelineCounts()`** -- query content.db:
   - SQL: `SELECT status, count(*) as count FROM articles GROUP BY status`
   - Map to: `[{ status: "researched", count: N }, { status: "written", count: N }, ...]`
   - content.db is currently 0-byte (no articles table). Handle gracefully: if DB is null or table doesn't exist, return empty array.

3. **`getEmailVolume(days: number = 7)`** -- query email.db:
   - SQL: `SELECT date(created_at) as day, direction, count(*) as count FROM email_conversations WHERE created_at > datetime('now', '-N days') GROUP BY day, direction ORDER BY day ASC`
   - Pivot to: `{ date: "2026-02-21", inbound: 5, outbound: 3 }`
   - email.db currently has 0 rows in email_conversations. Return empty array gracefully.

4. **`getCronDonutData()`** -- read cron jobs.json file (NOT a database):
   - Read `/home/ubuntu/.openclaw/cron/jobs.json`, parse JSON
   - Count by `state.lastStatus`: "ok" -> Success, "error" -> Error, null/undefined -> Never Run
   - Return: `[{ name: "Success", value: 19, fill: "hsl(142, 71%, 45%)" }, { name: "Error", value: 0, fill: "hsl(0, 84%, 60%)" }, { name: "Never Run", value: 1, fill: "hsl(240, 5%, 65%)" }]`
   - Filter out segments with value 0
   - On file read error, return empty array

Define agent color palette constant in this file:
```typescript
export const AGENT_COLORS: Record<string, string> = {
  main: "hsl(217, 91%, 60%)",     // Blue (Bob)
  landos: "hsl(142, 71%, 45%)",   // Green (Scout)
  rangeos: "hsl(262, 83%, 58%)",  // Purple (Vector)
  ops: "hsl(25, 95%, 53%)",       // Orange (Sentinel)
  quill: "hsl(340, 82%, 52%)",    // Pink (Quill)
  sage: "hsl(48, 96%, 53%)",      // Yellow (Sage)
  ezra: "hsl(186, 72%, 45%)",     // Cyan (Ezra)
};
```

Create 4 API routes (all with `export const dynamic = "force-dynamic"` and try/catch):

- `src/app/api/analytics/tokens/route.ts` -- GET, accepts `?days=7` query param (default 7), calls getTokenTimeSeries(days)
- `src/app/api/analytics/pipeline/route.ts` -- GET, calls getPipelineCounts()
- `src/app/api/analytics/email/route.ts` -- GET, accepts `?days=7` query param, calls getEmailVolume(days)
- `src/app/api/analytics/crons/route.ts` -- GET, calls getCronDonutData()
  </action>
  <verify>
SSH to EC2, curl all 4 endpoints:
- `curl http://localhost:3001/api/analytics/tokens` -- expect array of date+agent pivoted rows
- `curl http://localhost:3001/api/analytics/pipeline` -- expect empty array (content.db has no data)
- `curl http://localhost:3001/api/analytics/email` -- expect empty array (email.db has no rows)
- `curl http://localhost:3001/api/analytics/crons` -- expect array with Success segment (~19-20 jobs)
  </verify>
  <done>All 4 analytics API routes return correctly shaped data. Token endpoint returns pivoted time series. Pipeline and email return empty arrays gracefully. Cron returns donut segments.</done>
</task>

<task type="auto">
  <name>Task 2: Create 4 chart components and analytics page</name>
  <files>src/components/analytics/token-chart.tsx, src/components/analytics/pipeline-chart.tsx, src/components/analytics/email-chart.tsx, src/components/analytics/cron-chart.tsx, src/app/analytics/page.tsx</files>
  <action>
Create 4 chart components, all using shadcn ChartContainer wrapper (from `@/components/ui/chart`) and ChartTooltip/ChartTooltipContent for hover tooltips:

**`src/components/analytics/token-chart.tsx`** -- TokenChart:
- Props: `{ data: Array<Record<string, number | string>> }`
- Use Recharts `AreaChart` with `CartesianGrid`, `XAxis` (date), `YAxis` (token count formatted with formatTokens from utils.ts)
- One `Area` per agent with `stackId="1"` for stacked display, `type="monotone"`, gradient fills using AGENT_COLORS
- Define SVG `<defs>` with `<linearGradient>` per agent (solid color to transparent)
- Chart config object mapping agent IDs to labels and colors (e.g., `main: { label: "Bob", color: AGENT_COLORS.main }`)
- XAxis tickFormatter: format date to "Mon DD" using date-fns `format()`
- If data is empty, show "No token data yet" empty state

**`src/components/analytics/pipeline-chart.tsx`** -- PipelineChart:
- Props: `{ data: Array<{ status: string, count: number }> }`
- Use Recharts `BarChart` with horizontal bars, one bar per status
- Color each bar by status: researched=blue, written=amber, reviewed=purple, published=emerald
- XAxis: status labels, YAxis: count
- If data is empty, show styled empty state: "No content pipeline data yet — articles will appear here once the pipeline produces content"

**`src/components/analytics/email-chart.tsx`** -- EmailChart:
- Props: `{ data: Array<{ date: string, inbound: number, outbound: number }> }`
- Use Recharts `LineChart` with two `Line` components: inbound (blue) and outbound (emerald)
- Dot markers on data points, smooth `type="monotone"` curves
- XAxis: date formatted "Mon DD", YAxis: count
- If data is empty, show styled empty state: "No email data yet — volume will appear once emails are sent and received"

**`src/components/analytics/cron-chart.tsx`** -- CronChart:
- Props: `{ data: Array<{ name: string, value: number, fill: string }> }`
- Use Recharts `PieChart` with `Pie` component, `innerRadius={60}` `outerRadius={80}` for donut
- Use `Cell` components with `fill` from data entries
- `paddingAngle={3}` for segment spacing
- Center label showing total count (sum of all values)
- ChartTooltip with name and value
- If data is empty, show empty state

Create `src/app/analytics/page.tsx`:
- Page title "Analytics" with subtitle "Token usage, content pipeline, email volume, and cron health"
- Time range selector: 3 buttons (24h / 7d / 30d), default 7d selected. Use `useState` for selected range. Buttons styled as pills with active state (filled vs outline).
- Fetch all 4 data sources with useSWR:
  - `/api/analytics/tokens?days=${days}` (days from time range state: 1/7/30)
  - `/api/analytics/pipeline` (no time range -- counts are cumulative)
  - `/api/analytics/email?days=${days}` (days from time range state)
  - `/api/analytics/crons` (no time range -- current snapshot)
- Layout: 2x2 grid on desktop (lg:grid-cols-2), 1 column on mobile. Each chart in a shadcn Card with title header.
  - Top-left: "Token Usage" with TokenChart
  - Top-right: "Content Pipeline" with PipelineChart
  - Bottom-left: "Email Volume" with EmailChart
  - Bottom-right: "Cron Health" with CronChart
- Time range buttons only affect token and email charts (pipeline and cron are snapshots)
- Skeleton loaders: 4 card-shaped placeholders while data loads
- Freshness indicator (reuse existing pattern)
  </action>
  <verify>
SSH to EC2, restart dev server. Visit http://100.72.143.9:3001/analytics from Tailscale. Verify: 4 charts render in 2x2 grid. Token area chart shows stacked data with agent colors. Pipeline shows empty state. Email shows empty state. Cron donut shows success segment. Time range buttons change token chart data. Hover tooltips work on all charts.
  </verify>
  <done>/analytics page shows 4 Recharts visualizations in 2x2 grid. Token area chart stacks agent usage. Content pipeline and email show graceful empty states. Cron donut shows success/error distribution. Time range buttons (24h/7d/30d) control time-based charts. Tooltips show exact values on hover.</done>
</task>

</tasks>

<verification>
1. /api/analytics/tokens returns pivoted time series with agent columns
2. /api/analytics/tokens?days=1 returns 24h data, ?days=30 returns 30d data
3. /api/analytics/pipeline returns empty array (expected -- content.db empty)
4. /api/analytics/email returns empty array (expected -- no email rows)
5. /api/analytics/crons returns donut data with success count matching jobs.json
6. /analytics page loads with 4 charts in 2x2 grid
7. Token area chart shows stacked gradient areas per agent with proper colors
8. Content pipeline shows meaningful empty state message
9. Email volume shows meaningful empty state message
10. Cron donut shows success segment with center total label
11. Time range buttons (24h/7d/30d) update token and email charts
12. Hover tooltips display exact values on all charts
13. Responsive layout collapses to 1 column on mobile
14. Skeleton loaders display during data fetch
</verification>

<success_criteria>
- VIZ-01: Token usage displayed as area charts per agent via Recharts
- VIZ-02: Content pipeline displayed as bar chart by status (empty state acceptable since content.db is empty)
- VIZ-03: Email volume displayed as line chart over time (empty state acceptable since email.db has no rows)
- VIZ-04: Cron success/failure displayed as donut chart with actual data from jobs.json
</success_criteria>

<output>
After completion, create `.planning/phases/32-memory-office-visualization/32-03-SUMMARY.md`
</output>
