---
phase: 24-critical-security-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/backups/pre-v2026.2.17-*/openclaw
  - ~/backups/pre-v2026.2.17-*/openclaw.json
  - ~/backups/pre-v2026.2.17-*/gog-keyring/
  - ~/backups/pre-v2026.2.17-*/doctor-output.txt
  - ~/backups/pre-v2026.2.17-*/security-audit.txt
  - ~/.config/systemd/user/openclaw-gateway.service
autonomous: true
requirements:
  - SEC-01

must_haves:
  truths:
    - "openclaw --version reports v2026.2.17 on EC2"
    - "openclaw doctor shows no NEW critical findings (pre-existing warnings OK)"
    - "Gateway is running and accessible on 100.72.143.9:18789"
    - "gateway.remote.url in openclaw.json is preserved (ws://100.72.143.9:18789)"
    - "Pre-update backup exists for instant rollback"
  artifacts:
    - path: "~/backups/pre-v2026.2.17-*/openclaw"
      provides: "Rollback binary"
    - path: "~/backups/pre-v2026.2.17-*/openclaw.json"
      provides: "Rollback config"
    - path: "~/backups/pre-v2026.2.17-*/gog-keyring/"
      provides: "Rollback OAuth tokens"
    - path: "~/backups/pre-v2026.2.17-*/doctor-output.txt"
      provides: "Before/after comparison baseline"
  key_links:
    - from: "openclaw binary"
      to: "openclaw-gateway.service"
      via: "systemd ExecStart"
      pattern: "ExecStart=.*openclaw"
    - from: "openclaw.json"
      to: "gateway"
      via: "gateway.remote.url"
      pattern: "ws://100.72.143.9:18789"
---

<objective>
Capture pre-update security baseline, create rollback backup, update OpenClaw from v2026.2.6-3 to v2026.2.17, run doctor, and verify gateway is running on tailnet.

Purpose: Patch CVE-2026-25253 (CVSS 8.8 1-click RCE) and bring 11 minor versions of security hardening to the EC2 instance, with a safe rollback path if the update breaks anything.

Output: Updated OpenClaw binary running on EC2 with gateway accessible on tailnet, pre-update backup stored for rollback.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-critical-security-update/24-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture pre-update security baseline and create rollback backup</name>
  <files>
    ~/backups/pre-v2026.2.17-*/
  </files>
  <action>
SSH to EC2 (100.72.143.9) and execute the following:

1. **Create backup directory:**
   ```bash
   BACKUP_DIR=~/backups/pre-v2026.2.17-$(date +%Y%m%d%H%M)
   mkdir -p "$BACKUP_DIR"
   ```

2. **Capture pre-update baselines (for before/after comparison):**
   ```bash
   /home/ubuntu/.npm-global/bin/openclaw --version > "$BACKUP_DIR/version.txt" 2>&1
   /home/ubuntu/.npm-global/bin/openclaw doctor > "$BACKUP_DIR/doctor-output.txt" 2>&1
   ```
   Note: `openclaw security audit --deep` may not exist as a CLI command. If it fails, skip it -- SecureClaw audit in Plan 02 provides the security baseline.

3. **Backup binary, config, and gog tokens:**
   ```bash
   cp $(which openclaw) "$BACKUP_DIR/openclaw"
   cp ~/.openclaw/openclaw.json "$BACKUP_DIR/openclaw.json"
   cp -r ~/.config/gogcli/keyring/ "$BACKUP_DIR/gog-keyring/" 2>/dev/null || echo "No gog keyring found"
   ```

4. **Capture current service file for comparison:**
   ```bash
   cp ~/.config/systemd/user/openclaw-gateway.service "$BACKUP_DIR/openclaw-gateway.service"
   ```

5. **Verify backup contents:**
   ```bash
   ls -la "$BACKUP_DIR/"
   ```
   Expect: openclaw binary, openclaw.json, gog-keyring/ dir, doctor-output.txt, version.txt, service file.

6. **Record the backup directory path for use in Task 2 rollback instructions.**
  </action>
  <verify>
SSH and run: `ls ~/backups/pre-v2026.2.17-*/openclaw ~/backups/pre-v2026.2.17-*/openclaw.json ~/backups/pre-v2026.2.17-*/doctor-output.txt`
All three files must exist. Also verify `cat ~/backups/pre-v2026.2.17-*/version.txt` shows v2026.2.6-3.
  </verify>
  <done>
Pre-update backup directory exists with binary, config, gog tokens, doctor output, and version file. Baseline captured for before/after comparison.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OpenClaw to v2026.2.17 and verify gateway on tailnet</name>
  <files>
    /home/ubuntu/.npm-global/bin/openclaw
    ~/.config/systemd/user/openclaw-gateway.service
  </files>
  <action>
SSH to EC2 (100.72.143.9) and execute the following:

1. **Stop gateway service before update:**
   ```bash
   systemctl --user stop openclaw-gateway.service
   ```

2. **Update OpenClaw binary:**
   ```bash
   npm install -g openclaw@latest
   ```

3. **Verify new version:**
   ```bash
   /home/ubuntu/.npm-global/bin/openclaw --version
   ```
   Must report v2026.2.17 (or the latest available if 2.17 isn't the latest by execution time -- the key requirement is it must be >= v2026.2.17 to have CVE-2026-25253 patched).

4. **Run doctor with fix:**
   ```bash
   /home/ubuntu/.npm-global/bin/openclaw doctor --fix
   ```
   Watch for:
   - **Entrypoint mismatch:** If doctor flags it, note the new entrypoint path. Update `~/.config/systemd/user/openclaw-gateway.service` ExecStart line to match.
   - **Config migration:** Doctor may migrate config schema. This is expected and fine.
   - **New critical findings:** Any NEW critical finding (not present in pre-update doctor-output.txt) must be investigated and resolved before proceeding.
   - **Pre-existing warnings:** Deprecated auth profile, legacy session key -- these are Phase 28 scope. Ignore.

5. **If doctor flagged entrypoint change, update service file:**
   ```bash
   # Only if doctor shows new entrypoint:
   # Edit ~/.config/systemd/user/openclaw-gateway.service
   # Update the ExecStart line to the new entrypoint path
   ```

6. **Verify critical config preserved:**
   ```bash
   grep -A2 '"remote"' ~/.openclaw/openclaw.json
   ```
   Must show `"url": "ws://100.72.143.9:18789"` (gateway.remote.url). If missing, the update overwrote it -- restore from backup.

   Also check gateway bind setting:
   ```bash
   grep '"bind"' ~/.openclaw/openclaw.json
   ```
   Must show `"tailnet"` (not loopback).

7. **Reload and restart gateway:**
   ```bash
   systemctl --user daemon-reload
   systemctl --user restart openclaw-gateway.service
   sleep 5
   systemctl --user status openclaw-gateway.service
   ```
   Must show `active (running)`.

8. **Verify gateway is accessible on tailnet:**
   ```bash
   ss -tlnp | grep 18789
   ```
   Must show 100.72.143.9:18789 listening.

   ```bash
   /home/ubuntu/.npm-global/bin/openclaw gateway health
   ```
   Must show OK (or equivalent positive response). If this fails with "unauthorized: device token mismatch", this is the v2026.2.14 regression. Workaround:
   - Check `journalctl --user -u openclaw-gateway.service --since '1 min ago' | tail -20` for error details
   - Manually align OPENCLAW_GATEWAY_TOKEN in `~/.openclaw/.env` with the active device token
   - Restart gateway and retry

9. **Verify gog tokens not corrupted:**
   ```bash
   /home/ubuntu/.npm-global/bin/openclaw run -- gog calendar events --max 1
   ```
   If this fails with `aes.KeyUnwrap integrity check failed`, restore gog keyring from backup:
   ```bash
   rm -rf ~/.config/gogcli/keyring/
   cp -r ~/backups/pre-v2026.2.17-*/gog-keyring/ ~/.config/gogcli/keyring/
   ```
   If restored tokens also fail, re-auth: `gog auth add --manual --services gmail,calendar` (this will require interactive OAuth -- create a checkpoint if needed).

10. **Run post-update doctor for comparison:**
    ```bash
    /home/ubuntu/.npm-global/bin/openclaw doctor > /tmp/doctor-post-update.txt 2>&1
    cat /tmp/doctor-post-update.txt
    ```
    Compare with pre-update. No NEW critical findings allowed.

**ROLLBACK PROCEDURE (if update breaks gateway irrecoverably):**
```bash
# Stop gateway
systemctl --user stop openclaw-gateway.service
# Restore binary
cp ~/backups/pre-v2026.2.17-*/openclaw /home/ubuntu/.npm-global/bin/openclaw
# Restore config
cp ~/backups/pre-v2026.2.17-*/openclaw.json ~/.openclaw/openclaw.json
# Restore service file
cp ~/backups/pre-v2026.2.17-*/openclaw-gateway.service ~/.config/systemd/user/openclaw-gateway.service
# Reload and restart
systemctl --user daemon-reload
systemctl --user restart openclaw-gateway.service
```
  </action>
  <verify>
SSH and run all three:
1. `/home/ubuntu/.npm-global/bin/openclaw --version` — must show >= v2026.2.17
2. `systemctl --user status openclaw-gateway.service` — must show active (running)
3. `ss -tlnp | grep 18789` — must show 100.72.143.9:18789
4. `grep -A2 '"remote"' ~/.openclaw/openclaw.json` — must show ws://100.72.143.9:18789
  </verify>
  <done>
OpenClaw updated to v2026.2.17+, doctor passes with no new critical findings, gateway running on tailnet (100.72.143.9:18789), gateway.remote.url preserved, gog tokens functional.
  </done>
</task>

</tasks>

<verification>
1. `openclaw --version` reports >= v2026.2.17 on EC2
2. `openclaw doctor` shows no new critical findings vs. pre-update baseline
3. Gateway service is active and listening on 100.72.143.9:18789
4. `gateway.remote.url` in openclaw.json is `ws://100.72.143.9:18789`
5. Pre-update backup exists at `~/backups/pre-v2026.2.17-*/` with binary + config + tokens
6. gog calendar/gmail tokens are functional
</verification>

<success_criteria>
- SEC-01 satisfied: OpenClaw updated from v2026.2.6-3 to v2026.2.17 (CVE-2026-25253 patched)
- Gateway running on tailnet with preserved config
- Rollback backup available if needed by Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/24-critical-security-update/24-01-SUMMARY.md`
</output>
