---
phase: 24-critical-security-update
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - /home/ubuntu/backups/pre-v2026.2.17/openclaw
  - /home/ubuntu/backups/pre-v2026.2.17/openclaw.json
  - /home/ubuntu/backups/pre-v2026.2.17/gog-keyring/
  - /home/ubuntu/backups/pre-v2026.2.17/doctor-output.txt
  - /home/ubuntu/backups/pre-v2026.2.17/security-audit.txt
  - /home/ubuntu/.npm-global/lib/node_modules/openclaw/
  - /home/ubuntu/.openclaw/openclaw.json
  - /home/ubuntu/.config/systemd/user/openclaw-gateway.service
autonomous: true
requirements:
  - SEC-01

must_haves:
  truths:
    - "openclaw --version reports v2026.2.17 on EC2"
    - "Gateway service is active and listening on 100.72.143.9:18789"
    - "CLI commands work via gateway.remote.url (WebSocket to tailnet IP)"
    - "gog OAuth tokens are functional (calendar or gmail test query succeeds)"
    - "Pre-update binary and config are backed up for instant rollback"
  artifacts:
    - path: "/home/ubuntu/backups/pre-v2026.2.17/openclaw"
      provides: "Rollback binary"
    - path: "/home/ubuntu/backups/pre-v2026.2.17/openclaw.json"
      provides: "Rollback config"
    - path: "/home/ubuntu/backups/pre-v2026.2.17/gog-keyring/"
      provides: "Rollback OAuth tokens"
    - path: "/home/ubuntu/backups/pre-v2026.2.17/doctor-output.txt"
      provides: "Pre-update doctor baseline"
    - path: "/home/ubuntu/backups/pre-v2026.2.17/security-audit.txt"
      provides: "Pre-update security audit baseline"
  key_links:
    - from: "openclaw binary"
      to: "openclaw-gateway.service"
      via: "ExecStart path in systemd unit"
      pattern: "ExecStart=.*openclaw.*gateway"
    - from: "openclaw.json gateway.remote.url"
      to: "gateway WebSocket on 100.72.143.9:18789"
      via: "CLI -> gateway connection"
      pattern: "ws://100.72.143.9:18789"
---

<objective>
Update OpenClaw from v2026.2.6-3 to v2026.2.17 on EC2, patching CVE-2026-25253 (CVSS 8.8 RCE via auth token exfiltration). Capture a pre-update security baseline and full backup before updating, then verify gateway, CLI connectivity, and OAuth tokens survive the major version jump.

Purpose: Patch a critical 1-click RCE vulnerability and establish a clean, verified foundation for SecureClaw plugin installation in Plan 24-02.
Output: OpenClaw v2026.2.17 running on EC2 with gateway accessible on tailnet, CLI functional, OAuth intact, and rollback artifacts preserved.
</objective>

<execution_context>
@/Users/andykaufman/.claude/get-shit-done/workflows/execute-plan.md
@/Users/andykaufman/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-critical-security-update/24-CONTEXT.md
@.planning/phases/24-critical-security-update/24-RESEARCH.md
@.planning/phases/01-update-memory-security/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Capture pre-update security baseline and create full backup</name>
  <files>
    /home/ubuntu/backups/pre-v2026.2.17/openclaw
    /home/ubuntu/backups/pre-v2026.2.17/openclaw.json
    /home/ubuntu/backups/pre-v2026.2.17/gog-keyring/
    /home/ubuntu/backups/pre-v2026.2.17/doctor-output.txt
    /home/ubuntu/backups/pre-v2026.2.17/security-audit.txt
  </files>
  <action>
    SSH to EC2 (100.72.143.9) and execute all pre-update captures:

    1. **Capture security baseline** (before ANY changes):
       - Run `openclaw doctor` and save output to a file for before/after comparison
       - Run `openclaw security audit --deep` and save output
       - Run ClawdStrike baseline: `cd ~/.openclaw/skills/clawdstrike && bash scripts/collect_verified.sh`
       - Record current version: `openclaw --version` (expect v2026.2.6-3)
       - Record current gateway status: `systemctl --user status openclaw-gateway.service`

    2. **Create backup directory and copy rollback artifacts**:
       - `mkdir -p ~/backups/pre-v2026.2.17`
       - Copy binary: `cp $(which openclaw) ~/backups/pre-v2026.2.17/`
       - Copy config: `cp ~/.openclaw/openclaw.json ~/backups/pre-v2026.2.17/`
       - Copy gog keyring: `cp -r ~/.config/gogcli/keyring/ ~/backups/pre-v2026.2.17/gog-keyring/`
         (Known corruption risk during major version migration per MEMORY.md)
       - Copy doctor output: save to `~/backups/pre-v2026.2.17/doctor-output.txt`
       - Copy security audit output: save to `~/backups/pre-v2026.2.17/security-audit.txt`
       - Copy ClawdStrike bundle if generated: `cp ~/.openclaw/skills/clawdstrike/verified-bundle.json ~/backups/pre-v2026.2.17/` (optional, may not exist)

    3. **Verify backup completeness**:
       - `ls -la ~/backups/pre-v2026.2.17/` should show at minimum: openclaw binary, openclaw.json, gog-keyring/ directory, doctor-output.txt, security-audit.txt

    Note: Use full binary path `/home/ubuntu/.npm-global/bin/openclaw` for non-interactive SSH commands per MEMORY.md.
  </action>
  <verify>
    SSH: `ls -la ~/backups/pre-v2026.2.17/` shows all backup files exist and have non-zero sizes.
    SSH: `cat ~/backups/pre-v2026.2.17/doctor-output.txt` shows doctor output captured.
    SSH: `cat ~/backups/pre-v2026.2.17/security-audit.txt` shows security audit captured.
  </verify>
  <done>
    Pre-update baseline captured (doctor + security audit + ClawdStrike). Full backup exists at ~/backups/pre-v2026.2.17/ with binary, config, gog keyring, and baseline outputs. Ready to proceed with update knowing rollback is instant (copy backup binary + config back, restart service).
  </done>
</task>

<task type="auto">
  <name>Task 2: Update OpenClaw to v2026.2.17 and verify gateway + connectivity</name>
  <files>
    /home/ubuntu/.npm-global/lib/node_modules/openclaw/
    /home/ubuntu/.openclaw/openclaw.json
    /home/ubuntu/.config/systemd/user/openclaw-gateway.service
  </files>
  <action>
    SSH to EC2 (100.72.143.9) and execute the proven update procedure:

    1. **Stop gateway** (minimize risk of partial-update state):
       - `systemctl --user stop openclaw-gateway.service`

    2. **Update OpenClaw binary**:
       - `npm install -g openclaw@latest`
       - Verify: `openclaw --version` should report v2026.2.17
       - If version is NOT v2026.2.17, check what version installed and assess whether to proceed or pin

    3. **Run doctor with auto-fix**:
       - `openclaw doctor --fix`
       - Compare output against pre-update baseline (~/backups/pre-v2026.2.17/doctor-output.txt)
       - Check for NEW critical findings (pre-existing warnings like deprecated auth profile are Phase 28's scope)
       - If doctor flags a service entrypoint mismatch (known pitfall from prior update): update the ExecStart line in `~/.config/systemd/user/openclaw-gateway.service` to match the new entrypoint path, then `systemctl --user daemon-reload`

    4. **Verify config preservation**:
       - Confirm `gateway.remote.url` is still `ws://100.72.143.9:18789` in openclaw.json (critical for CLI commands)
       - Confirm gateway bind is still tailnet (100.72.143.9), not reverted to loopback
       - If doctor --fix changed anything unexpected, diff against backup: `diff ~/.openclaw/openclaw.json ~/backups/pre-v2026.2.17/openclaw.json`

    5. **Restart gateway**:
       - `systemctl --user daemon-reload` (in case service file changed)
       - `systemctl --user start openclaw-gateway.service`
       - Wait 5 seconds, then: `systemctl --user status openclaw-gateway.service` (expect: active/running)
       - Check logs: `journalctl --user -u openclaw-gateway.service --since '1 min ago' --no-pager | tail -30`
       - Look for any "unauthorized: device token mismatch" errors (v2026.2.14 regression -- if present, manually align OPENCLAW_GATEWAY_TOKEN)

    6. **Verify gateway on tailnet**:
       - `ss -tlnp | grep 18789` should show listening on 100.72.143.9:18789
       - `openclaw gateway health` should return OK (uses gateway.remote.url)

    7. **Verify gog OAuth tokens**:
       - Test: `gog calendar events --max 1` or `gog auth list`
       - If "aes.KeyUnwrap integrity check failed": tokens corrupted. Restore from backup: `rm -rf ~/.config/gogcli/keyring/ && cp -r ~/backups/pre-v2026.2.17/gog-keyring/ ~/.config/gogcli/keyring/`
       - If restore doesn't fix it: re-auth with `gog auth add --manual --services gmail,calendar` (requires human action -- escalate as checkpoint)

    8. **Update service file version string** (cosmetic, established pattern from Phase 1):
       - Update Description and version env var in `~/.config/systemd/user/openclaw-gateway.service` to show v2026.2.17
       - `systemctl --user daemon-reload && systemctl --user restart openclaw-gateway.service`
  </action>
  <verify>
    SSH: `openclaw --version` outputs v2026.2.17
    SSH: `systemctl --user status openclaw-gateway.service` shows active (running)
    SSH: `ss -tlnp | grep 18789` shows 100.72.143.9:18789
    SSH: `openclaw gateway health` returns OK
    SSH: `gog auth list` shows Gmail + Calendar auth entries (no errors)
    SSH: `journalctl --user -u openclaw-gateway.service --since '5 min ago' --no-pager | grep -i error` returns empty (no errors)
  </verify>
  <done>
    OpenClaw v2026.2.17 is running on EC2. Gateway is active on tailnet (100.72.143.9:18789). CLI commands connect via gateway.remote.url. gog OAuth tokens are intact. No new critical doctor findings. CVE-2026-25253 is patched. Ready for SecureClaw installation in Plan 24-02.
  </done>
</task>

</tasks>

<verification>
- `openclaw --version` reports v2026.2.17 (SEC-01 version requirement)
- Gateway service is active and healthy on tailnet IP
- CLI connectivity works (gateway.remote.url preserved)
- gog OAuth tokens functional
- Backup exists at ~/backups/pre-v2026.2.17/ for instant rollback
- No new critical findings from `openclaw doctor`
</verification>

<success_criteria>
SEC-01 is fully satisfied: OpenClaw is updated from v2026.2.6-3 to v2026.2.17 with CVE-2026-25253 patched. Pre-update baseline and rollback artifacts are preserved. Gateway is running and accessible on tailnet. The platform is ready for SecureClaw plugin installation.
</success_criteria>

<output>
After completion, create `.planning/phases/24-critical-security-update/24-01-SUMMARY.md`
</output>
